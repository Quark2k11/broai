<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<title>Bro AI</title>
<!-- TF.js bundled via reliable CDN with fallback -->
<script>
window.TF_LOADED=false;
function loadTF(){
  return new Promise((res)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js';
    s.onload=()=>{window.TF_LOADED=true;res(true);};
    s.onerror=()=>{res(false);};
    document.head.appendChild(s);
  });
}
function loadCocoSsd(){
  return new Promise((res)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js';
    s.onload=()=>res(true);s.onerror=()=>res(false);
    document.head.appendChild(s);
  });
}
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
:root{--c:#00FFFF;--d:#000;--d2:#0A0A1A;--d3:#0D0D2B;--g:#888;--gr:#00FF88;--r:#FF4444;--o:#FF8800;--pur:#8800FF;--gold:#FFD700;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:#000;color:#fff;font-family:'Rajdhani',sans-serif;}
.screen{display:none;flex-direction:column;position:fixed;inset:0;z-index:1;}
.screen.active{display:flex;}

/* â”€â”€ HOME â”€â”€ */
#homeScreen{background:radial-gradient(ellipse at center,#0D0D2B 0%,#000 70%);justify-content:center;align-items:center;gap:18px;}
.logo{font-family:'Orbitron',monospace;font-size:48px;font-weight:900;color:var(--c);letter-spacing:8px;animation:glow 2s infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 30px #00FFFF60}50%{text-shadow:0 0 60px #00FFFFcc}}
.tagline{color:var(--g);font-size:11px;letter-spacing:5px;}
.main-btn{width:80%;max-width:290px;height:58px;border:none;border-radius:32px;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:3px;cursor:pointer;transition:transform 0.15s;}
.main-btn:active{transform:scale(0.97);}
.main-btn.p{background:var(--c);color:#000;}
.main-btn.s{background:transparent;color:var(--c);border:2px solid var(--c);}
.settings-link{color:var(--g);font-size:12px;letter-spacing:2px;background:none;border:none;cursor:pointer;margin-top:6px;padding:6px 16px;}

/* â”€â”€ TOPBAR â”€â”€ */
.tb{display:flex;align-items:center;padding:10px 12px;background:var(--d3);border-bottom:1px solid rgba(0,255,255,0.15);min-height:52px;gap:8px;flex-shrink:0;}
.tb-title{font-family:'Orbitron',monospace;font-size:13px;color:var(--c);font-weight:700;flex:1;}
.back{background:none;border:none;color:var(--c);font-size:22px;cursor:pointer;padding:2px 6px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--gr);animation:blink 1.5s infinite;flex-shrink:0;}
.dot.r{background:var(--r);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.mbadge{font-size:9px;color:var(--o);background:rgba(255,136,0,0.12);border:1px solid rgba(255,136,0,0.4);border-radius:10px;padding:2px 8px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* â”€â”€ FACE SCREEN â”€â”€ */
#faceScreen{background:#000;position:relative;}
#faceArea{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;overflow:hidden;}
/* Hidden background camera */
#bgCamVideo{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;}
#bgCanvas{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;}
/* Status strip */
.face-status{position:absolute;top:10px;left:10px;right:52px;display:flex;flex-wrap:wrap;gap:5px;z-index:5;}
.fs-pill{font-family:'Orbitron',monospace;font-size:9px;padding:3px 8px;border-radius:10px;background:rgba(0,0,0,0.8);border:1px solid rgba(0,255,255,0.2);color:var(--g);letter-spacing:1px;}
.fs-pill.on{border-color:var(--gr);color:var(--gr);}
.fs-pill.alert{border-color:var(--r);color:var(--r);animation:blink 0.7s infinite;}
.fs-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 10px;cursor:pointer;font-size:15px;z-index:5;}
.bat{position:absolute;bottom:10px;right:10px;font-family:'Orbitron',monospace;font-size:10px;background:rgba(0,0,0,0.8);border:1px solid rgba(0,255,136,0.3);border-radius:8px;padding:3px 9px;color:var(--gr);z-index:5;display:none;}
.bat.low{border-color:var(--r);color:var(--r);}
.nav-pill{position:absolute;bottom:10px;left:10px;font-family:'Orbitron',monospace;font-size:9px;color:var(--o);background:rgba(0,0,0,0.8);border:1px solid rgba(255,136,0,0.3);border-radius:8px;padding:3px 9px;z-index:5;display:none;}
/* Eyes */
.emo-lbl{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;margin-bottom:18px;}
.eyes-row{display:flex;gap:44px;}
.eye{width:100px;height:100px;border-radius:50%;background:var(--c);position:relative;overflow:hidden;box-shadow:0 0 40px rgba(0,255,255,0.8);transition:background 0.4s,box-shadow 0.4s,height 0.1s,border-radius 0.1s;}
.eye.blink{height:6px!important;border-radius:3px!important;}
.pupil{position:absolute;width:40px;height:40px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform 0.4s;}
.shine{position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.sub-area{margin-top:45px;width:244px;min-height:52px;text-align:center;}
.sub-txt{font-size:15px;color:#fff;line-height:1.6;word-break:break-word;}
.listen-lbl{font-size:11px;color:var(--gr);font-family:'Orbitron',monospace;letter-spacing:2px;margin-top:8px;min-height:18px;}
/* Face bar */
#faceBar{display:flex;padding:8px 10px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.15);gap:6px;flex-shrink:0;}
.fbar{flex:1;height:42px;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:9px;font-weight:700;cursor:pointer;letter-spacing:1px;}
.fbar.cy{background:var(--c);color:#000;}
.fbar.ol{background:transparent;color:var(--c);border:1px solid rgba(0,255,255,0.4);}
.fbar.re{background:rgba(255,68,68,0.15);color:var(--r);border:1px solid var(--r);}

/* â”€â”€ FULLSCREEN â”€â”€ */
#fsOverlay{display:none;position:fixed;inset:0;z-index:999;background:#000;flex-direction:column;justify-content:center;align-items:center;}
#fsOverlay.show{display:flex;}
.fs-exit{position:absolute;top:14px;right:14px;background:rgba(0,0,0,0.6);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 10px;cursor:pointer;font-size:15px;}
.fs-eyes{display:flex;gap:44px;}
.fs-eye{width:110px;height:110px;border-radius:50%;background:var(--c);position:relative;overflow:hidden;box-shadow:0 0 50px rgba(0,255,255,0.9);transition:background 0.4s,box-shadow 0.4s,height 0.1s,border-radius 0.1s;}
.fs-eye.blink{height:6px!important;border-radius:3px!important;}
.fs-pupil{position:absolute;width:44px;height:44px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform 0.4s;}
.fs-shine{position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.fs-sub{margin-top:45px;width:264px;min-height:52px;text-align:center;}
.fs-sub-txt{font-size:16px;color:#fff;line-height:1.6;word-break:break-word;}
.fs-listen{font-size:11px;color:var(--gr);font-family:'Orbitron',monospace;letter-spacing:2px;margin-top:8px;min-height:18px;}
.fs-emo{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;margin-bottom:18px;}

/* â”€â”€ CHAT â”€â”€ */
#chatScreen{background:#000;}
.chat-wrap{flex:1;display:flex;overflow:hidden;}
.sidebar{width:0;overflow:hidden;background:var(--d2);border-right:1px solid rgba(0,255,255,0.1);transition:width 0.3s;flex-shrink:0;display:flex;flex-direction:column;}
.sidebar.open{width:230px;}
.sb-head{padding:12px;border-bottom:1px solid rgba(0,255,255,0.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sb-ttl{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);}
.sb-new{background:var(--c);color:#000;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;}
.sb-list{flex:1;overflow-y:auto;padding:8px;}
.sb-item{padding:10px;border-radius:10px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;position:relative;}
.sb-item:hover,.sb-item.act{background:rgba(0,255,255,0.08);border-color:rgba(0,255,255,0.2);}
.sb-name{font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:20px;}
.sb-date{font-size:10px;color:var(--g);margin-top:2px;}
.sb-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--r);font-size:13px;cursor:pointer;}
.chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#msgList{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;}
.msg{max-width:86%;padding:11px 15px;border-radius:18px;font-size:15px;line-height:1.5;word-break:break-word;animation:fu 0.2s ease;}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.u{align-self:flex-end;background:var(--c);color:#000;font-weight:600;border-bottom-right-radius:4px;}
.msg.b{align-self:flex-start;background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-bottom-left-radius:4px;}
.msg.s{align-self:center;background:rgba(0,255,255,0.04);color:var(--g);font-size:12px;border-radius:12px;text-align:center;max-width:90%;padding:8px 14px;}
.typing{display:none;padding:0 12px 4px;flex-shrink:0;}
.typing-in{display:inline-flex;background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-radius:18px;padding:12px 16px;gap:5px;}
.typing-in span{width:7px;height:7px;border-radius:50%;background:var(--c);animation:td 1.2s infinite;}
.typing-in span:nth-child(2){animation-delay:.2s}.typing-in span:nth-child(3){animation-delay:.4s}
@keyframes td{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
.input-bar{display:flex;align-items:center;padding:8px 10px 10px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.15);gap:8px;flex-shrink:0;}
#chatInput{flex:1;background:#111830;border:2px solid rgba(0,255,255,0.3);border-radius:24px;padding:11px 16px;color:#fff;font-size:16px;font-family:'Rajdhani',sans-serif;outline:none;min-width:0;}
#chatInput:focus{border-color:var(--c);}
#chatInput::placeholder{color:#444;}
.mic-btn{width:46px;height:46px;border-radius:50%;border:1px solid rgba(0,255,255,0.3);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;background:var(--d2);color:var(--c);flex-shrink:0;}
.send-btn{width:46px;height:46px;border-radius:50%;border:none;cursor:pointer;font-size:18px;background:var(--c);color:#000;flex-shrink:0;}

/* â”€â”€ SETTINGS â”€â”€ */
#settingsScreen{background:#000;}
.set-scroll{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;}
/* Section headers */
.sec-head{font-family:'Orbitron',monospace;font-size:10px;color:var(--c);letter-spacing:3px;opacity:0.8;margin:12px 0 6px;padding-left:2px;border-left:2px solid var(--c);padding-left:8px;}
/* Row */
.srow{display:flex;align-items:center;justify-content:space-between;background:var(--d3);border:1px solid rgba(0,255,255,0.08);border-radius:12px;padding:12px 14px;gap:10px;}
.srl{font-size:15px;font-weight:600;}
.srd{font-size:11px;color:var(--g);margin-top:2px;}
/* Toggle */
.tog{width:46px;height:24px;background:var(--d2);border-radius:12px;border:1px solid rgba(0,255,255,0.25);position:relative;cursor:pointer;transition:all 0.3s;flex-shrink:0;}
.tog.on{background:var(--c);border-color:var(--c);}
.tog::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all 0.3s;}
.tog.on::after{left:24px;}
/* Input */
.sinp{width:100%;background:var(--d3);border:1px solid rgba(0,255,255,0.25);border-radius:10px;padding:10px 14px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;margin-bottom:6px;}
.sinp:focus{border-color:var(--c);}
/* Select */
.ssel{background:var(--d2);border:1px solid rgba(0,255,255,0.25);color:var(--c);border-radius:8px;padding:6px 10px;font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;}
/* Buttons */
.sbtn{width:100%;height:44px;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:4px;}
.sbtn.cy{background:var(--c);color:#000;}
.sbtn.gray{background:#111;color:var(--g);border:1px solid #333;}
.sbtn.re{background:rgba(255,68,68,0.1);color:var(--r);border:1px solid rgba(255,68,68,0.3);}
/* Model row */
.mrow{display:flex;justify-content:space-between;align-items:center;background:var(--d3);border-radius:8px;padding:8px 12px;margin-bottom:3px;}
.mbadge{font-size:10px;padding:2px 8px;border-radius:8px;font-family:'Orbitron',monospace;}
.mbadge.ok{background:rgba(0,255,136,0.1);color:var(--gr);border:1px solid rgba(0,255,136,0.3);}
.mbadge.skip{background:rgba(255,68,68,0.1);color:var(--r);border:1px solid rgba(255,68,68,0.3);}
.mbadge.nokey{background:rgba(80,80,80,0.1);color:#555;border:1px solid #333;}
/* Slider */
.sl{width:100%;-webkit-appearance:none;height:5px;border-radius:3px;background:#1a1a3a;outline:none;margin:6px 0;}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--c);cursor:pointer;}
/* Face card */
.face-card{display:flex;align-items:center;gap:10px;background:var(--d3);border:1px solid rgba(0,255,255,0.1);border-radius:10px;padding:10px;margin-bottom:6px;}
.face-img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--c);flex-shrink:0;}
.face-info{flex:1;}
.face-name{font-size:14px;font-weight:600;}
.face-sub{font-size:11px;color:var(--g);}
.face-del{background:none;border:none;color:var(--r);font-size:16px;cursor:pointer;}
/* Unknown face card */
.unk-card{display:flex;align-items:center;gap:10px;background:rgba(255,136,0,0.06);border:1px solid rgba(255,136,0,0.2);border-radius:10px;padding:10px;margin-bottom:6px;}
.unk-img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--o);flex-shrink:0;}
/* Detection log */
.det-item{padding:8px 12px;border-radius:8px;background:var(--d3);border-left:3px solid var(--c);margin-bottom:4px;font-size:12px;line-height:1.6;}
.det-item.person{border-color:var(--gr);}
.det-item.motion{border-color:var(--r);}
.det-item.object{border-color:var(--o);}
/* Reminder item */
.rem-item{display:flex;align-items:center;gap:10px;background:var(--d3);border-radius:10px;padding:10px;margin-bottom:6px;}
.rem-time{font-family:'Orbitron',monospace;font-size:13px;color:var(--c);flex-shrink:0;}
.rem-del{background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;}
/* Report stat */
.rep-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,255,255,0.06);}
.rep-row:last-child{border:none;}
.rep-k{color:var(--g);font-size:13px;}
.rep-v{font-family:'Orbitron',monospace;font-size:14px;color:var(--c);}
/* Log entry */
.log-entry{font-size:11px;color:#aaa;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);line-height:1.6;}
/* Fun section */
.fun-result{font-size:14px;color:#fff;background:rgba(136,0,255,0.08);border:1px solid rgba(136,0,255,0.2);border-radius:10px;padding:12px;min-height:60px;line-height:1.6;margin-top:8px;}
/* Trivia */
.t-opt{padding:11px 14px;border-radius:10px;border:1px solid rgba(0,255,255,0.2);background:var(--d3);font-size:14px;cursor:pointer;text-align:left;width:100%;margin-bottom:6px;}
.t-opt.correct{background:rgba(0,255,136,0.15);border-color:var(--gr);color:var(--gr);}
.t-opt.wrong{background:rgba(255,68,68,0.12);border-color:var(--r);color:var(--r);}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(0,255,255,0.2);border-radius:2px}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME â€” Only 2 buttons + settings
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="homeScreen" class="screen active">
  <div class="logo">Bro AI</div>
  <div class="tagline">Your AI Robot Companion</div>
  <button class="main-btn p" onclick="goTo('faceScreen')">ğŸ¤– &nbsp;Bro Bot</button>
  <button class="main-btn s" onclick="goTo('chatScreen')">ğŸ’¬ &nbsp;Bro AI Chat</button>
  <button class="settings-link" onclick="goTo('settingsScreen')">âš™ Settings</button>
  <div style="font-size:9px;color:#1a1a2e;margin-top:10px;letter-spacing:3px;">v10.0</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FACE SCREEN â€” Everything runs here
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="faceScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="goTo('homeScreen')">â†</button>
    <div class="tb-title" id="faceTitle">Bro Bot</div>
    <div id="voiceStatus" style="font-size:10px;color:var(--g);font-family:'Orbitron',monospace;letter-spacing:1px;">OFF</div>
    <div class="dot r" id="botDot"></div>
  </div>

  <!-- Hidden bg camera + canvas for detection -->
  <video id="bgCamVideo" autoplay playsinline muted></video>
  <canvas id="bgCanvas"></canvas>

  <div id="faceArea">
    <!-- Status pills showing what's running -->
    <div class="face-status">
      <div class="fs-pill" id="pillVoice">ğŸ¤ VOICE</div>
      <div class="fs-pill" id="pillGuard">ğŸ›¡ GUARD</div>
      <div class="fs-pill" id="pillDetect">ğŸ‘ DETECT</div>
      <div class="fs-pill" id="pillNav">ğŸ§­ NAV</div>
      <div class="fs-pill" id="pillML">ML</div>
    </div>

    <button class="fs-btn" onclick="openFS()">â›¶</button>
    <div class="bat" id="batDisp">ğŸ”‹ --</div>
    <div class="nav-pill" id="navPill">ğŸ§­ EXPLORING</div>

    <div class="emo-lbl" id="emoLbl">NEUTRAL</div>
    <div class="eyes-row">
      <div class="eye" id="eyeL"><div class="pupil" id="pupL"></div><div class="shine"></div></div>
      <div class="eye" id="eyeR"><div class="pupil" id="pupR"></div><div class="shine"></div></div>
    </div>
    <div class="sub-area">
      <div class="sub-txt" id="subTxt">Hello! I am Bro Bot.</div>
      <div class="listen-lbl" id="listenLbl"></div>
    </div>
  </div>

  <div id="faceBar">
    <button class="fbar cy" id="voiceBtn" onclick="toggleVoice()">ğŸ¤ VOICE</button>
    <button class="fbar ol" id="camBtn" onclick="toggleBgCam()">ğŸ“· CAM</button>
    <button class="fbar ol" onclick="goTo('settingsScreen')">âš™ SET</button>
    <button class="fbar ol" onclick="openFS()">â›¶ FULL</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FULLSCREEN OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="fsOverlay">
  <button class="fs-exit" onclick="closeFS()">â›¶</button>
  <div class="fs-emo" id="fsEmo">NEUTRAL</div>
  <div class="fs-eyes">
    <div class="fs-eye" id="fsEyeL"><div class="fs-pupil" id="fsPupL"></div><div class="fs-shine"></div></div>
    <div class="fs-eye" id="fsEyeR"><div class="fs-pupil" id="fsPupR"></div><div class="fs-shine"></div></div>
  </div>
  <div class="fs-sub">
    <div class="fs-sub-txt" id="fsSub">Hello!</div>
    <div class="fs-listen" id="fsListen"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="chatScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="toggleSidebar()">â˜°</button>
    <button class="back" onclick="goTo('homeScreen')">â†</button>
    <div class="tb-title">Bro AI</div>
    <div class="mbadge" id="modelBadge">READY</div>
    <div class="dot"></div>
  </div>
  <div class="chat-wrap">
    <div class="sidebar" id="sidebar">
      <div class="sb-head"><div class="sb-ttl">HISTORY</div><button class="sb-new" onclick="newChat()">+ NEW</button></div>
      <div class="sb-list" id="sbList"></div>
    </div>
    <div class="chat-main">
      <div id="msgList"><div class="msg s">Bro AI v10 ready! All systems active.</div></div>
      <div class="typing" id="typingDiv"><div class="typing-in"><span></span><span></span><span></span></div></div>
      <div class="input-bar">
        <button class="mic-btn" id="chatMicBtn" onclick="chatMic()">ğŸ¤</button>
        <input id="chatInput" type="text" placeholder="Ask Bro AI..." onkeypress="if(event.key==='Enter'){event.preventDefault();sendChat();}">
        <button class="send-btn" onclick="sendChat()">â¤</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS â€” All features organized
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settingsScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="goTo('homeScreen')">â†</button>
    <div class="tb-title">Settings</div>
  </div>
  <div class="set-scroll">

    <!-- API KEYS -->
    <div class="sec-head">ğŸ”‘ API KEYS</div>
    <input type="password" class="sinp" id="kG" placeholder="Gemini Key â€” AIzaSy...">
    <input type="password" class="sinp" id="kGH" placeholder="GitHub AI Key â€” free with GitHub account">
    <button class="sbtn cy" onclick="saveKeys()">ğŸ’¾ SAVE KEYS</button>
    <div id="keyMsg" style="text-align:center;font-size:12px;color:var(--gr);min-height:16px;"></div>

    <!-- MODELS -->
    <div class="sec-head">ğŸ¤– AI MODELS</div>
    <div id="modelList"></div>
    <button class="sbtn gray" onclick="resetSkip()">ğŸ”„ RESET QUOTA SKIPS</button>

    <!-- ESP32 -->
    <div class="sec-head">ğŸ“¡ ESP32 CONNECTION</div>
    <input type="text" class="sinp" id="espIP" placeholder="ESP32 IP â€” e.g. 192.168.1.100">
    <button class="sbtn cy" onclick="connectESP()">CONNECT BRO BOT</button>
    <div id="espMsg" style="text-align:center;font-size:12px;color:var(--g);min-height:16px;"></div>

    <!-- VOICE & LANGUAGE -->
    <div class="sec-head">ğŸ”Š VOICE & LANGUAGE</div>
    <div class="srow"><div><div class="srl">Language</div></div>
      <select class="ssel" id="sLang" onchange="saveSett()">
        <option value="en-US">English (US)</option><option value="en-GB">English (UK)</option>
        <option value="hi-IN">Hindi</option><option value="ta-IN">Tamil</option>
        <option value="te-IN">Telugu</option><option value="ml-IN">Malayalam</option>
        <option value="kn-IN">Kannada</option><option value="fr-FR">French</option>
        <option value="de-DE">German</option><option value="ja-JP">Japanese</option>
        <option value="zh-CN">Chinese</option><option value="es-ES">Spanish</option>
        <option value="ar-SA">Arabic</option>
      </select>
    </div>
    <div class="srow"><div><div class="srl">Voice Speed</div><div class="srd">Jarvis speaking rate</div></div>
      <input type="range" class="sl" style="width:100px;" min="0.5" max="2" step="0.1" value="0.9" id="sSpeed" oninput="saveSett()">
    </div>
    <button class="sbtn gray" onclick="checkVoice()">ğŸ”Š TEST VOICE</button>
    <div id="voiceBox" style="font-size:11px;color:var(--gr);background:var(--d3);border-radius:8px;padding:10px;display:none;margin-top:4px;line-height:1.8;"></div>

    <!-- AI PERSONALITY -->
    <div class="sec-head">ğŸ§  AI PERSONALITY</div>
    <div class="srow"><div><div class="srl">Personality</div></div>
      <select class="ssel" id="sPers" onchange="saveSett()">
        <option value="friendly">Friendly Bro</option><option value="funny">Funny Bro</option>
        <option value="professional">Professional</option><option value="serious">Serious</option>
        <option value="jarvis">Jarvis Style</option>
      </select>
    </div>
    <div class="srow"><div><div class="srl">Auto Nav When Idle</div><div class="srd">Explore after 30s silence</div></div><div class="tog on" id="tNav" onclick="togSet(this,'autoNav')"></div></div>

    <!-- ROBOT BEHAVIOR -->
    <div class="sec-head">ğŸ¤– ROBOT BEHAVIOR</div>
    <div class="srow"><div><div class="srl">Auto Obstacle Avoid</div><div class="srd">Stop when sensors blocked</div></div><div class="tog on" id="tObs" onclick="togSet(this,'obstacle')"></div></div>
    <div class="srow"><div><div class="srl">Person Follow Mode</div><div class="srd">Follow detected person in frame</div></div><div class="tog" id="tFollow" onclick="togSet(this,'followPerson')"></div></div>
    <div class="srow"><div><div class="srl">Battery Alert</div><div class="srd">Voice warn below 15%</div></div><div class="tog on" id="tBat" onclick="togSet(this,'batAlert')"></div></div>
    <div class="srow"><div><div class="srl">Look At Speaker</div><div class="srd">Head turns when speaking</div></div><div class="tog on" id="tLook" onclick="togSet(this,'lookSpeak')"></div></div>

    <!-- SAFETY -->
    <div class="sec-head" style="color:var(--r);">ğŸ›¡ SAFETY â€” ALWAYS ON</div>
    <div class="srow" style="border-color:rgba(255,68,68,0.25);">
      <div><div class="srl" style="color:var(--r);">Guardian (Motion Watch)</div><div class="srd">Detect intruders any screen</div></div>
      <div class="tog on" id="tGuard" onclick="togGuardian(this)"></div>
    </div>
    <div class="srow" style="border-color:rgba(255,68,68,0.25);">
      <div><div class="srl" style="color:var(--r);">Emergency Listener</div><div class="srd">Say "help/SOS/danger" to trigger</div></div>
      <div class="tog on" id="tEmerg" onclick="togEmergency(this)"></div>
    </div>
    <div style="font-size:11px;color:var(--g);background:rgba(255,68,68,0.05);border:1px solid rgba(255,68,68,0.15);border-radius:10px;padding:10px;line-height:1.7;">
      Emergency words: <span style="color:var(--r);">help Â· SOS Â· danger Â· fire Â· intruder Â· attack Â· mayday Â· call police</span>
    </div>
    <button class="sbtn re" onclick="testSOS()">ğŸš¨ TEST SOS ALERT</button>

    <!-- VISION & DETECTION -->
    <div class="sec-head">ğŸ‘ VISION & DETECTION</div>
    <div class="srow"><div><div class="srl">Background Detection</div><div class="srd">Detect objects/people on face screen</div></div><div class="tog on" id="tDetect" onclick="togSet(this,'detection')"></div></div>
    <div class="srow"><div><div class="srl">Face Recognition</div><div class="srd">Greet known family members</div></div><div class="tog on" id="tFaceRec" onclick="togSet(this,'faceRec')"></div></div>
    <div class="srow"><div><div class="srl">OCR (Read Text)</div><div class="srd">Read text from camera</div></div><div class="tog on" id="tOCR" onclick="togSet(this,'ocrMode')"></div></div>
    <div class="srow"><div><div class="srl">Hand Gesture Control</div><div class="srd">Control robot with hand signs</div></div><div class="tog" id="tGest" onclick="togSet(this,'gestureCtrl')"></div></div>
    <div id="mlStatusRow" style="text-align:center;font-size:11px;color:var(--o);padding:8px;font-family:'Orbitron',monospace;letter-spacing:1px;">ML: LOADING...</div>

    <!-- VISION â€” FAMILY FACES -->
    <div class="sec-head">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ KNOWN FACES (FAMILY & FRIENDS)</div>
    <div style="font-size:12px;color:var(--g);margin-bottom:8px;">Register faces so Bro Bot greets them by name!</div>
    <div style="background:var(--d3);border-radius:12px;padding:12px;margin-bottom:8px;">
      <input type="text" class="sinp" id="fOrigName" placeholder="Original name (e.g. Rahul Sharma)">
      <input type="text" class="sinp" id="fNickname" placeholder="Nickname (e.g. Bro, Buddy)">
      <input type="text" class="sinp" id="fCallName" placeholder="How to call them (e.g. Hey Rahul / Buddy!)">
      <input type="text" class="sinp" id="fRelation" placeholder="Relation (e.g. Friend, Brother, Mom)">
      <button class="sbtn cy" onclick="captureFace()">ğŸ“¸ CAPTURE FACE FROM CAMERA</button>
    </div>
    <div id="knownFaceList"></div>

    <!-- VISION â€” UNKNOWNS DETECTED -->
    <div class="sec-head">ğŸ‘¤ UNKNOWN FACES DETECTED</div>
    <div style="font-size:11px;color:var(--g);margin-bottom:6px;">People seen but not registered</div>
    <div id="unknownFaceList"><div style="font-size:12px;color:#333;text-align:center;padding:12px;">No unknowns detected yet</div></div>
    <button class="sbtn gray" onclick="clearUnknowns()">ğŸ—‘ CLEAR UNKNOWNS</button>

    <!-- VISION â€” DETECTED OBJECTS LOG -->
    <div class="sec-head">ğŸ“¦ OBJECTS DETECTED LOG</div>
    <div id="objectLogDiv" style="max-height:160px;overflow-y:auto;"><div style="font-size:12px;color:#333;text-align:center;padding:12px;">No objects logged yet</div></div>
    <button class="sbtn gray" onclick="clearObjectLog()">ğŸ—‘ CLEAR LOG</button>

    <!-- VISION â€” DETECTION RESULTS -->
    <div class="sec-head">ğŸ“Š LIVE DETECTION STATUS</div>
    <div id="detectionStats" style="background:var(--d3);border-radius:10px;padding:12px;font-size:12px;line-height:2;color:#ccc;">
      Waiting for detection to start...
    </div>

    <!-- REMINDERS -->
    <div class="sec-head">â° REMINDERS</div>
    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
      <input type="time" class="sinp" id="remTime" style="margin:0;flex:1;min-width:100px;">
      <input type="text" class="sinp" id="remTxt" placeholder="Reminder..." style="margin:0;flex:2;min-width:120px;">
    </div>
    <button class="sbtn cy" onclick="addReminder()">+ ADD REMINDER</button>
    <div id="reminderList"></div>

    <!-- FUN & GAMES -->
    <div class="sec-head">ğŸ® FUN & GAMES</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
      <button class="sbtn cy" style="margin:0;" onclick="tellJoke()">ğŸ˜‚ JOKE</button>
      <button class="sbtn cy" style="margin:0;background:var(--pur);color:#fff;" onclick="tellStory()">ğŸ“– STORY</button>
      <button class="sbtn cy" style="margin:0;background:var(--gr);color:#000;" onclick="robotDance()">ğŸ•º DANCE</button>
      <button class="sbtn cy" style="margin:0;background:var(--gold);color:#000;" onclick="startTrivia()">ğŸ§© TRIVIA</button>
    </div>
    <div class="fun-result" id="funResult">Choose a fun activity!</div>
    <div id="triviaArea" style="display:none;margin-top:8px;">
      <div style="display:flex;justify-content:space-between;font-family:'Orbitron',monospace;font-size:11px;color:var(--c);margin-bottom:8px;">
        <span>Score: <span id="tScore">0</span></span><span>Q <span id="tNum">1</span>/10</span>
      </div>
      <div id="tQuestion" style="font-size:15px;color:#fff;margin-bottom:10px;min-height:50px;line-height:1.6;"></div>
      <div id="tOptions"></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="sbtn cy" style="margin:0;flex:1;" onclick="nextTrivia()">NEXT â–¶</button>
        <button class="sbtn gray" style="margin:0;flex:1;" onclick="document.getElementById('triviaArea').style.display='none'">CLOSE</button>
      </div>
    </div>

    <!-- AI REPORTS & LOGS -->
    <div class="sec-head">ğŸ“Š AI REPORTS & LOGS</div>
    <div style="background:var(--d3);border-radius:12px;padding:12px;margin-bottom:8px;" id="statsBlock"></div>
    <button class="sbtn cy" onclick="generateReport()">ğŸ“ GENERATE AI REPORT</button>
    <div id="aiReportDiv" style="font-size:13px;color:#ccc;background:var(--d3);border-radius:10px;padding:12px;min-height:60px;line-height:1.8;margin-top:6px;display:none;"></div>
    <div class="sec-head" style="margin-top:4px;">Movement Log</div>
    <div id="movLogDiv" style="max-height:120px;overflow-y:auto;background:var(--d3);border-radius:8px;padding:8px;"></div>
    <div class="sec-head">Detection Log</div>
    <div id="detLogDiv" style="max-height:120px;overflow-y:auto;background:var(--d3);border-radius:8px;padding:8px;"></div>
    <button class="sbtn gray" onclick="clearAllLogs()">ğŸ—‘ CLEAR ALL LOGS</button>

    <div style="height:20px;"></div>
  </div>
</div>

<!-- GLOBAL ALERT CONTAINER -->
<div id="globalAlert" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:rgba(255,0,0,0.93);color:#fff;font-family:'Orbitron',monospace;font-size:12px;letter-spacing:1px;padding:14px 16px;text-align:center;flex-direction:column;gap:8px;">
  <div id="globalAlertMsg">ALERT</div>
  <button onclick="dismissAlert()" style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:6px;padding:5px 16px;cursor:pointer;font-size:11px;">âœ• DISMISS</button>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODELS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODELS=[
  {name:'Gemini 2.5 Flash',p:'gemini',m:'gemini-2.5-flash-preview-04-17',k:'g',tier:10},
  {name:'Gemini 2.5 Pro',p:'gemini',m:'gemini-2.5-pro-preview-05-06',k:'g',tier:10},
  {name:'Gemini 2.5 Flash Lite',p:'gemini',m:'gemini-2.5-flash-lite-preview-06-17',k:'g',tier:9},
  {name:'Gemini 2.0 Flash',p:'gemini',m:'gemini-2.0-flash',k:'g',tier:9},
  {name:'Gemini 2.0 Flash Exp',p:'gemini',m:'gemini-2.0-flash-exp',k:'g',tier:8},
  {name:'Gemini 2.0 Flash Lite',p:'gemini',m:'gemini-2.0-flash-lite',k:'g',tier:8},
  {name:'Gemini 1.5 Pro',p:'gemini',m:'gemini-1.5-pro',k:'g',tier:7},
  {name:'Gemini 1.5 Flash',p:'gemini',m:'gemini-1.5-flash',k:'g',tier:7},
  {name:'Gemini 1.5 Flash-8B',p:'gemini',m:'gemini-1.5-flash-8b',k:'g',tier:6},
  {name:'Gemma 3 27B',p:'gemini',m:'gemma-3-27b-it',k:'g',tier:5},
  {name:'Gemma 3 12B',p:'gemini',m:'gemma-3-12b-it',k:'g',tier:4},
  {name:'GPT-4o Mini',p:'github',m:'gpt-4o-mini',k:'gh',tier:8},
  {name:'GPT-4o',p:'github',m:'gpt-4o',k:'gh',tier:9},
  {name:'Llama 3.3 70B',p:'github',m:'meta-llama-3.3-70b-instruct',k:'gh',tier:7},
  {name:'Mistral Large',p:'github',m:'mistral-large-2411',k:'gh',tier:6},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let keys     = JSON.parse(localStorage.getItem('bk')||'{}');
let sett     = JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"autoNav":true,"batAlert":true,"followPerson":false,"detection":true,"faceRec":true,"ocrMode":false,"gestureCtrl":false,"lookSpeak":true,"personality":"friendly","voiceSpeed":0.9,"lang":"en-US"}');
let mems     = JSON.parse(localStorage.getItem('bm')||'[]');
let skip     = JSON.parse(localStorage.getItem('bsk')||'{}');
let chats    = JSON.parse(localStorage.getItem('bchats')||'[]');
let habits   = JSON.parse(localStorage.getItem('bhab')||'{}');
let knownFaces   = JSON.parse(localStorage.getItem('bfaces')||'[]');
let unknownFaces = JSON.parse(localStorage.getItem('bunknown')||'[]');
let objectLog    = JSON.parse(localStorage.getItem('bobjlog')||'[]');
let reminders    = JSON.parse(localStorage.getItem('brem')||'[]');
let eIP      = localStorage.getItem('bi')||'';
let rOK=false, robotSpeed=50;

// Voice
let botVoiceOn=false;
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;

// Eyes
let eyeT=null, blinkT=null;

// Background systems
let bgCamOn=false, bgStream=null;
let bgDetectT=null, bgMotionT=null, bgEmergT=null;
let bgPrevFrame=null, bgAlertCooldown=0;
let bgGuardOn=true, bgEmergOn=true;
let cocoModel=null, mlReady=false;

// Navigation
let isIdle=false, lastActiveTime=Date.now();
let idleCheckT=null, autoNavT=null;
let patrolT=null, wallT=null, mazeT=null;
let pathRecording=false, recordedPath=[], startPos={x:0,y:0,h:0}, curPos={x:0,y:0,h:0};

// Stats
let stats={obstacles:0,detections:0,faces:0,people:0,motionAlerts:0,cmds:0,sessionStart:Date.now()};
let movLog=[], detLog=[];

// Chat
let curChatId=null, chatMsgCount=0;

// Trivia
const TRIVIA=[
  {q:'What is the capital of France?',opts:['London','Berlin','Paris','Madrid'],a:2},
  {q:'How many planets in our solar system?',opts:['7','8','9','10'],a:1},
  {q:'What is 15 Ã— 12?',opts:['150','170','180','160'],a:2},
  {q:'Who invented the telephone?',opts:['Edison','Bell','Tesla','Marconi'],a:1},
  {q:'Largest ocean on Earth?',opts:['Atlantic','Indian','Arctic','Pacific'],a:3},
  {q:'What gas do plants absorb?',opts:['Oxygen','Nitrogen','CO2','Hydrogen'],a:2},
  {q:'Sides of a hexagon?',opts:['5','6','7','8'],a:1},
  {q:'Fastest land animal?',opts:['Lion','Cheetah','Leopard','Horse'],a:1},
  {q:'WW2 ended in?',opts:['1943','1944','1945','1946'],a:2},
  {q:'H2O is commonly called?',opts:['Salt','Water','Oxygen','Acid'],a:1},
];
let triviaIdx=0, triviaScore=0;

(()=>{const t=+localStorage.getItem('bskt')||0;if(Date.now()-t>86400000){skip={};localStorage.setItem('bsk','{}');localStorage.setItem('bskt',''+Date.now());}})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='faceScreen') startEyes();
  else stopEyes();
  if(id==='chatScreen') renderSidebar();
  if(id==='settingsScreen') loadSettUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBest(){return[...MODELS].filter(m=>keys[m.k]&&!skip[m.name]).sort((a,b)=>b.tier-a.tier);}

async function callAI(msg, cb, sys){
  const pers=sett.personality||'friendly';
  const mc=mems.slice(0,4).map(m=>m.text).join('; ');
  const hc=Object.entries(habits).slice(0,2).map(([k,v])=>k+':'+v.substring(0,40)).join('; ');
  const system=sys||`You are Bro AI, a ${pers} AI robot assistant. Be concise. No emojis in spoken text. Robot commands in brackets: [MOVE_FORWARD][MOVE_BACKWARD][TURN_LEFT][TURN_RIGHT][STOP][HEAD_LEFT][HEAD_RIGHT][HEAD_CENTER][TILT_UP][TILT_DOWN][TURN_90L][TURN_90R][TURN_180]. Memory:${mc}. Habits:${hc}`;
  const models=getBest();
  if(!models.length){cb('No API keys configured. Go to Settings and add your Gemini key.');return;}
  for(const mdl of models){
    const el=document.getElementById('modelBadge');if(el)el.textContent=mdl.name;
    try{
      let url,body,headers={'Content-Type':'application/json'};
      if(mdl.p==='gemini'){
        url='https://generativelanguage.googleapis.com/v1beta/models/'+mdl.m+':generateContent?key='+keys[mdl.k];
        body=JSON.stringify({contents:[{parts:[{text:system+'\nUser: '+msg}]}]});
      } else {
        url='https://models.inference.ai.azure.com/chat/completions';
        headers['Authorization']='Bearer '+keys[mdl.k];
        body=JSON.stringify({model:mdl.m,messages:[{role:'system',content:system},{role:'user',content:msg}],max_tokens:600});
      }
      const r=await fetch(url,{method:'POST',headers,body,signal:AbortSignal.timeout(12000)});
      if([429,503,402].includes(r.status)){skip[mdl.name]=true;localStorage.setItem('bsk',JSON.stringify(skip));continue;}
      if(!r.ok) continue;
      const d=await r.json();
      const txt=mdl.p==='gemini'?d.candidates?.[0]?.content?.parts?.[0]?.text:d.choices?.[0]?.message?.content;
      if(txt?.trim().length>1){learnHabit(msg);stats.cmds++;cb(txt.trim());return;}
    }catch(e){continue;}
  }
  cb('All models are busy right now. Please try again.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HABIT LEARNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function learnHabit(msg){
  const h=new Date().getHours();
  const p=h<12?'morning':h<17?'afternoon':'evening';
  habits[p]=(habits[p]||'')+(msg.substring(0,20)+'|');
  if(habits[p].length>200) habits[p]=habits[p].slice(-200);
  localStorage.setItem('bhab',JSON.stringify(habits));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TTS â€” Jarvis British Voice
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cleanTxt(t){
  return t.replace(/[\u{1F000}-\u{1FFFF}]/gu,'').replace(/[\u2600-\u27FF]/g,'')
    .replace(/\[.*?\]/g,'').replace(/broai/gi,'Bro AI').replace(/brobot/gi,'Bro Bot')
    .trim().substring(0,400);
}
function getBritishVoice(){
  const v=window.speechSynthesis?.getVoices()||[];
  for(const n of['Google UK English Male','Microsoft George','Microsoft Ryan','Daniel','Arthur']){
    const f=v.find(x=>x.name===n||x.name.startsWith(n));if(f)return f;
  }
  return v.find(x=>x.lang==='en-GB')||v.find(x=>x.lang.startsWith('en'))||v[0];
}
function speak(text,onDone){
  if(!window.speechSynthesis){onDone?.();return;}
  window.speechSynthesis.cancel();
  const c=cleanTxt(text);if(!c){onDone?.();return;}
  const u=new SpeechSynthesisUtterance(c);
  u.lang=sett.lang||'en-US';u.rate=parseFloat(sett.voiceSpeed)||0.9;u.pitch=0.85;u.volume=1;
  u.onend=()=>onDone?.();u.onerror=()=>onDone?.();
  const go=()=>{const v=getBritishVoice();if(v)u.voice=v;window.speechSynthesis.speak(u);};
  if(window.speechSynthesis.getVoices().length) go();
  else{
    if('onvoiceschanged' in window.speechSynthesis) window.speechSynthesis.onvoiceschanged=()=>{go();window.speechSynthesis.onvoiceschanged=null;};
    setTimeout(go,300);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EYES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startEyes(){
  stopEyes();
  blinkT=setInterval(()=>{
    ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
      const e=document.getElementById(id);if(!e)return;
      e.classList.add('blink');setTimeout(()=>e.classList.remove('blink'),150);
    });
  },3000+Math.random()*2000);
  eyeT=setInterval(()=>{
    const x=(Math.random()-0.5)*16,y=(Math.random()-0.5)*12;
    ['pupL','pupR','fsPupL','fsPupR'].forEach(id=>{
      const p=document.getElementById(id);if(!p)return;
      p.style.transform=`translate(calc(-50% + ${x}px),calc(-50% + ${y}px))`;
      setTimeout(()=>p.style.transform='translate(-50%,-50%)',700);
    });
  },2500+Math.random()*1200);
}
function stopEyes(){clearInterval(blinkT);clearInterval(eyeT);}

function setEmotion(text){
  const t=text.toLowerCase();
  let col='#00FFFF',sh='rgba(0,255,255,0.8)',emo='NEUTRAL';
  if(/happy|great|awesome|love|wonderful/.test(t)){col='#00FF88';sh='rgba(0,255,136,0.8)';emo='HAPPY';}
  else if(/sorry|fail|error/.test(t)){col='#FF8800';sh='rgba(255,136,0,0.8)';emo='CONCERNED';}
  else if(/think|hmm|calculating|processing/.test(t)){col='#8800FF';sh='rgba(136,0,255,0.8)';emo='THINKING';}
  else if(/alert|danger|intruder|warning|emergency/.test(t)){col='#FF4444';sh='rgba(255,68,68,0.8)';emo='ALERT';}
  else if(/curious|interesting|wow/.test(t)){col='#FFD700';sh='rgba(255,215,0,0.8)';emo='CURIOUS';}
  ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
    const e=document.getElementById(id);if(!e)return;
    e.style.background=col;e.style.boxShadow='0 0 40px '+sh;
  });
  ['emoLbl','fsEmo'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=emo;});
}
function setSub(t){
  const c=cleanTxt(t).substring(0,140);
  ['subTxt','fsSub'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=c;});
}
function setListenLbl(t){['listenLbl','fsListen'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=t;});}
function openFS(){document.getElementById('fsOverlay').classList.add('show');}
function closeFS(){document.getElementById('fsOverlay').classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleVoice(){botVoiceOn?stopVoice():startVoice();}
function startVoice(){
  if(!SR){alert('Voice requires Chrome browser!');return;}
  botVoiceOn=true;
  const btn=document.getElementById('voiceBtn');
  btn.textContent='ğŸ”´ ON';btn.style.background='rgba(255,68,68,0.2)';btn.style.color='var(--r)';btn.style.border='1px solid var(--r)';
  document.getElementById('voiceStatus').textContent='ON';document.getElementById('voiceStatus').style.color='var(--gr)';
  setPill('pillVoice',true);setListenLbl('â— LISTENING...');
  startIdleWatch();listenLoop();
}
function stopVoice(){
  botVoiceOn=false;clearInterval(idleCheckT);stopAutoNav();
  const btn=document.getElementById('voiceBtn');
  btn.textContent='ğŸ¤ VOICE';btn.style.background='var(--c)';btn.style.color='#000';btn.style.border='none';
  document.getElementById('voiceStatus').textContent='OFF';document.getElementById('voiceStatus').style.color='var(--g)';
  setPill('pillVoice',false);setListenLbl('');
}
function listenLoop(){
  if(!botVoiceOn) return;
  let got=false;
  const r=new SR();
  r.lang=sett.lang||'en-US';r.continuous=false;r.interimResults=false;r.maxAlternatives=1;
  r.onresult=(e)=>{
    got=true;resetIdle();
    const cmd=e.results[0][0].transcript.trim();
    if(!cmd||cmd.length<2){if(botVoiceOn)setTimeout(listenLoop,400);return;}
    if(/disable voice|stop listening/i.test(cmd)){setSub('Voice off.');speak('Voice disabled.',stopVoice);return;}
    setListenLbl('â— THINKING...');setSub('Thinking...');setEmotion('thinking');
    callAI(cmd,(reply)=>{
      setSub(reply);setEmotion(reply);handleRobotCmds(reply);
      saveMem(reply.substring(0,200));
      setListenLbl('â— SPEAKING...');
      speak(reply,()=>{setListenLbl('â— LISTENING...');if(botVoiceOn)setTimeout(listenLoop,500);});
    });
  };
  r.onerror=()=>{if(botVoiceOn)setTimeout(listenLoop,1000);};
  r.onend=()=>{if(!got&&botVoiceOn)setTimeout(listenLoop,400);};
  try{r.start();}catch(ex){if(botVoiceOn)setTimeout(listenLoop,1500);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND CAMERA (face screen)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function toggleBgCam(){
  if(bgCamOn){
    bgStream?.getTracks().forEach(t=>t.stop());
    bgStream=null;bgCamOn=false;
    document.getElementById('camBtn').textContent='ğŸ“· CAM';
    stopBgDetection();
  } else {
    try{
      bgStream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment',width:{ideal:320},height:{ideal:240}},audio:false
      });
      const v=document.getElementById('bgCamVideo');
      v.srcObject=bgStream;bgCamOn=true;
      document.getElementById('camBtn').textContent='ğŸ“· ON';
      v.onloadedmetadata=()=>{
        const c=document.getElementById('bgCanvas');
        c.width=v.videoWidth;c.height=v.videoHeight;
        if(sett.detection) startBgDetection();
        startBgMotion();
      };
    }catch(e){
      setSub('Camera error: '+e.message);
    }
  }
}

// â”€â”€ Background ML Detection â”€â”€
async function loadML(){
  const el=document.getElementById('mlStatusRow');
  try{
    if(el) el.textContent='ML: Loading TensorFlow...';
    const tfOk=await loadTF();
    if(!tfOk) throw new Error('TF.js load failed');
    if(el) el.textContent='ML: Loading COCO-SSD...';
    const cocoOk=await loadCocoSsd();
    if(!cocoOk) throw new Error('COCO-SSD load failed');
    cocoModel=await cocoSsd.load();
    mlReady=true;
    if(el){el.textContent='ML: READY âœ“';el.style.color='var(--gr)';}
    setPill('pillML',true);
    addDetLog('ML object detection ready');
  }catch(e){
    mlReady=false;
    if(el){el.textContent='ML: Basic mode (no internet for ML)';el.style.color='var(--o)';}
    setPill('pillML',false);
  }
}

function startBgDetection(){
  clearInterval(bgDetectT);
  setPill('pillDetect',true);
  bgDetectT=setInterval(runBgDetect,1200);
}
function stopBgDetection(){
  clearInterval(bgDetectT);
  setPill('pillDetect',false);
}

async function runBgDetect(){
  if(!bgCamOn||!sett.detection) return;
  const v=document.getElementById('bgCamVideo');
  if(!v.videoWidth) return;
  const c=document.getElementById('bgCanvas');
  const ctx=c.getContext('2d');
  ctx.drawImage(v,0,0,c.width,c.height);

  let detectedClasses=[], personCount=0;

  // Real ML detection
  if(mlReady&&cocoModel){
    try{
      const preds=await cocoModel.detect(v);
      detectedClasses=preds.map(p=>p.class);
      preds.forEach(p=>{
        if(p.class==='person') personCount++;
        // log unique objects
        if(!objectLog.find(o=>o.name===p.class&&Date.now()-o.time<60000)){
          objectLog.unshift({name:p.class,conf:Math.round(p.score*100),time:Date.now(),ts:new Date().toLocaleTimeString()});
          if(objectLog.length>100) objectLog.splice(100);
          localStorage.setItem('bobjlog',JSON.stringify(objectLog));
        }
      });

      // Person follow
      if(sett.followPerson&&personCount>0&&rOK){
        const person=preds.find(p=>p.class==='person');
        if(person){
          const cx=(person.bbox[0]+person.bbox[2]/2)/c.width;
          if(cx<0.35) espCmd({action:'left',speed:30});
          else if(cx>0.65) espCmd({action:'right',speed:30});
          else espCmd({action:'forward',speed:35});
        }
      }

      stats.detections+=preds.length;
      stats.people=Math.max(stats.people,personCount);

      // Announce interesting detections
      if(personCount>0){
        stats.faces++;
        // try face recognition
        if(sett.faceRec) tryFaceRecognition(ctx,c,personCount);
        setSub('Person detected! '+personCount+' people in view.');
        addDetLog('Person detected: '+personCount);
      }

      // Update stats display
      const classes=[...new Set(detectedClasses)];
      document.getElementById('detectionStats').innerHTML=
        `<div class="rep-row"><span class="rep-k">Objects in view</span><span class="rep-v">${preds.length}</span></div>`+
        `<div class="rep-row"><span class="rep-k">People</span><span class="rep-v">${personCount}</span></div>`+
        `<div class="rep-row"><span class="rep-k">Detected</span><span class="rep-v" style="font-size:11px;">${classes.join(', ')||'None'}</span></div>`+
        `<div class="rep-row"><span class="rep-k">Total logged</span><span class="rep-v">${objectLog.length}</span></div>`;

    }catch(e){console.log('Detection error:',e.message);}
  } else {
    // Basic brightness/pixel fallback
    const d=ctx.getImageData(0,0,c.width,c.height);
    const brightness=getAvgBrightness(d);
    document.getElementById('detectionStats').innerHTML=
      `<div class="rep-row"><span class="rep-k">Mode</span><span class="rep-v" style="color:var(--o);">BASIC</span></div>`+
      `<div class="rep-row"><span class="rep-k">Brightness</span><span class="rep-v">${brightness}</span></div>`+
      `<div style="font-size:11px;color:var(--g);margin-top:6px;">Full detection needs internet to load ML models. Basic motion detection still works!</div>`;
  }
}

function getAvgBrightness(d){
  let t=0;for(let i=0;i<d.data.length;i+=16)t+=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
  return Math.round(t/(d.data.length/16));
}

// Face recognition against known faces
function tryFaceRecognition(ctx, canvas, count){
  const snap=canvas.toDataURL('image/jpeg',0.5);
  // Simple pixel comparison against known faces
  if(!knownFaces.length){
    // save as unknown if not already
    if(unknownFaces.length<20&&Date.now()-bgAlertCooldown>15000){
      unknownFaces.unshift({img:snap,time:new Date().toLocaleString(),ts:Date.now()});
      if(unknownFaces.length>20) unknownFaces.splice(20);
      localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
    }
    return;
  }
  // Greet first known face (basic match by timing)
  const face=knownFaces[0];
  if(Date.now()-bgAlertCooldown>20000){
    bgAlertCooldown=Date.now();
    const greeting=face.callName||('Hello '+face.nickname||face.name+'!');
    setSub(greeting);speak(greeting);
    addDetLog('Face recognized: '+face.name);
  }
}

// â”€â”€ Background Motion Watch (Guardian) â”€â”€
function startBgMotion(){
  clearInterval(bgMotionT);
  bgMotionT=setInterval(runBgMotion,600);
  setPill('pillGuard',true);
}

function runBgMotion(){
  if(!bgGuardOn||!bgCamOn) return;
  const v=document.getElementById('bgCamVideo');if(!v.videoWidth) return;
  const c=document.createElement('canvas');c.width=80;c.height=60;
  const ctx=c.getContext('2d');ctx.drawImage(v,0,0,80,60);
  const frame=ctx.getImageData(0,0,80,60);
  if(bgPrevFrame){
    let diff=0,changed=0;
    for(let i=0;i<frame.data.length;i+=4){
      const d=Math.abs(frame.data[i]-bgPrevFrame[i])+Math.abs(frame.data[i+1]-bgPrevFrame[i+1])+Math.abs(frame.data[i+2]-bgPrevFrame[i+2]);
      if(d>35)changed++;diff+=d;
    }
    const score=diff/(frame.data.length/4),pct=Math.round(changed/(frame.data.length/4)*100);
    if(score>30&&Date.now()>bgAlertCooldown+8000){
      bgAlertCooldown=Date.now();stats.motionAlerts++;
      onIntruder(pct);
    }
  }
  bgPrevFrame=Array.from(frame.data);
}

function onIntruder(pct){
  addDetLog('âš  INTRUDER! Motion: '+pct+'%');
  setSub('INTRUDER DETECTED!');setEmotion('alert danger');
  // Flash eyes red
  ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
    const e=document.getElementById(id);if(!e)return;
    const ob=e.style.background,os=e.style.boxShadow;
    e.style.background='#FF0000';e.style.boxShadow='0 0 60px red';
    setTimeout(()=>{e.style.background=ob;e.style.boxShadow=os;},3000);
  });
  showAlert('âš  INTRUDER DETECTED! Motion: '+pct+'%');
  speak('Warning! Intruder detected!');
  if(rOK){espCmd({action:'stop'});setTimeout(()=>espCmd({action:'alarm'}),400);}
  // capture snapshot
  const v=document.getElementById('bgCamVideo');
  if(v.videoWidth){
    const c=document.createElement('canvas');c.width=160;c.height=120;
    c.getContext('2d').drawImage(v,0,0,160,120);
    unknownFaces.unshift({img:c.toDataURL('image/jpeg',0.6),time:new Date().toLocaleString()+' (INTRUDER)',ts:Date.now()});
    if(unknownFaces.length>20) unknownFaces.splice(20);
    localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
  }
}

// â”€â”€ Background Emergency Listener â”€â”€
function startBgEmergency(){
  if(!SR||!bgEmergOn) return;
  listenEmerg();
}
function listenEmerg(){
  if(!bgEmergOn) return;
  if(botVoiceOn){setTimeout(listenEmerg,5000);return;} // voice loop handles it
  try{
    const r=new SR();r.lang=sett.lang||'en-US';r.continuous=false;r.interimResults=false;r.maxAlternatives=2;
    let got=false;
    r.onresult=(e)=>{
      got=true;
      let h='';for(let i=0;i<e.results[0].length;i++) h+=e.results[0][i].transcript.toLowerCase()+' ';
      const words=['help','emergency','sos','danger','intruder','attack','fire','call police','mayday'];
      const hit=words.find(w=>h.includes(w));
      if(hit) onEmergWord(hit);
    };
    r.onend=()=>{if(bgEmergOn) setTimeout(listenEmerg,1200);};
    r.onerror=()=>{if(bgEmergOn) setTimeout(listenEmerg,4000);};
    r.start();
  }catch(e){if(bgEmergOn) setTimeout(listenEmerg,5000);}
}

function onEmergWord(word){
  if(Date.now()<bgAlertCooldown+10000) return;
  bgAlertCooldown=Date.now();
  showAlert('ğŸš¨ EMERGENCY WORD: "'+word.toUpperCase()+'" DETECTED!');
  setSub('Emergency: '+word);setEmotion('alert emergency danger');
  speak('Emergency detected! Do you need help?',()=>{
    try{
      const c=new SR();c.lang=sett.lang||'en-US';c.continuous=false;
      c.onresult=(e)=>{
        const resp=e.results[0][0].transcript.toLowerCase();
        if(/yes|help|please/.test(resp)){
          activateSOS();
        } else {
          speak('Okay. Staying alert.');dismissAlert();
        }
      };c.onend=()=>{};c.start();
    }catch(ex){}
  });
}

let sosInterval=null;
function activateSOS(){
  speak('SOS activated! Calling for help!');
  showAlert('ğŸš¨ SOS ACTIVATED!');
  setEmotion('alert');setSub('SOS ACTIVE â€” EMERGENCY');
  clearInterval(sosInterval);
  sosInterval=setInterval(()=>speak('SOS! Emergency! Please help!'),8000);
  addDetLog('SOS activated');
}
function testSOS(){activateSOS();setTimeout(()=>{clearInterval(sosInterval);dismissAlert();speak('SOS test complete.');},5000);}

// â”€â”€ Global Alert Banner â”€â”€
function showAlert(msg){
  const el=document.getElementById('globalAlert');
  document.getElementById('globalAlertMsg').textContent=msg;
  el.style.display='flex';
}
function dismissAlert(){
  document.getElementById('globalAlert').style.display='none';
  clearInterval(sosInterval);
}

// â”€â”€ Status Pills â”€â”€
function setPill(id,on){const e=document.getElementById(id);if(e)e.className='fs-pill'+(on?' on':'');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IDLE + AUTO NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetIdle(){lastActiveTime=Date.now();if(isIdle){isIdle=false;stopAutoNav();setPill('pillNav',false);document.getElementById('navPill').style.display='none';}}
function startIdleWatch(){
  clearInterval(idleCheckT);
  idleCheckT=setInterval(()=>{
    if(!sett.autoNav||!rOK) return;
    if(Date.now()-lastActiveTime>30000&&!isIdle){
      isIdle=true;startAutoNav();
    }
  },5000);
}
function startAutoNav(){
  setPill('pillNav',true);
  document.getElementById('navPill').style.display='block';
  setSub('No one talking. Exploring...');setEmotion('curious');
  addMovLog('Auto-nav started (idle)');
  runAutoNav();
}
function stopAutoNav(){
  clearTimeout(autoNavT);isIdle=false;
  setPill('pillNav',false);
  document.getElementById('navPill').style.display='none';
  if(rOK) espCmd({action:'stop'});
}
async function runAutoNav(){
  if(!isIdle||!rOK) return;
  let sd={ultrasonic:100,ir1:false,ir2:false};
  try{const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(700)});sd=await r.json();}catch(e){}
  const us=sd.ultrasonic??100;
  if(us<25||sd.ir1||sd.ir2){
    espCmd({action:'stop'});stats.obstacles++;
    const d=Math.random()>0.5?'left':'right';
    espCmd({action:d,speed:robotSpeed});
    addMovLog('Auto: obstacleâ†’turn '+d);
    autoNavT=setTimeout(()=>{espCmd({action:'stop'});autoNavT=setTimeout(runAutoNav,400);},700+Math.random()*400);
  } else {
    espCmd({action:'forward',speed:Math.min(robotSpeed,45)});
    addMovLog('Auto: forward');
    autoNavT=setTimeout(runAutoNav,1800+Math.random()*800);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESP32
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function espCmd(obj){
  if(!eIP) return;
  try{await fetch('http://'+eIP+'/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj),signal:AbortSignal.timeout(1000)});}catch(e){}
}
async function connectESP(){
  const ip=document.getElementById('espIP')?.value.trim();if(!ip)return;
  eIP=ip;localStorage.setItem('bi',ip);
  const m=document.getElementById('espMsg');
  if(m){m.textContent='Connecting...';m.style.color='var(--o)';}
  try{
    const r=await fetch('http://'+ip+'/ping',{signal:AbortSignal.timeout(3000)});
    if(r.ok){
      rOK=true;document.getElementById('botDot')?.classList.remove('r');
      if(m){m.textContent='âœ“ Connected to Bro Bot!';m.style.color='var(--gr)';}
      startSensorLoop();
    } else throw new Error();
  }catch(e){rOK=false;if(m){m.textContent='âœ— Cannot connect. Check IP.';m.style.color='var(--r)';}}
}
let sensorLoopT=null;
function startSensorLoop(){
  clearInterval(sensorLoopT);
  sensorLoopT=setInterval(async()=>{
    if(!rOK||!eIP) return;
    try{
      const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(800)});
      const d=await r.json();
      const bat=d.battery??'--',us=d.ultrasonic??'--';
      const bd=document.getElementById('batDisp');
      if(bd){bd.style.display='block';bd.textContent='ğŸ”‹ '+bat+'%';bd.className='bat'+(bat<20?' low':'');}
      if(sett.batAlert&&bat<15&&bat>0) speak('Warning! Battery low. Please charge soon.');
      if(sett.obstacle&&(d.ir1||d.ir2||us<15)){espCmd({action:'stop'});stats.obstacles++;}
    }catch(e){}
  },500);
}
function handleRobotCmds(text){
  if(!rOK) return;const t=text.toUpperCase();
  if(t.includes('[MOVE_FORWARD]')) espCmd({action:'forward',speed:robotSpeed});
  else if(t.includes('[MOVE_BACKWARD]')) espCmd({action:'backward',speed:robotSpeed});
  else if(t.includes('[TURN_LEFT]')) espCmd({action:'left',speed:robotSpeed});
  else if(t.includes('[TURN_RIGHT]')) espCmd({action:'right',speed:robotSpeed});
  else if(t.includes('[STOP]')) espCmd({action:'stop'});
  else if(t.includes('[TURN_90L]')){espCmd({action:'left',speed:40});setTimeout(()=>espCmd({action:'stop'}),800);}
  else if(t.includes('[TURN_90R]')){espCmd({action:'right',speed:40});setTimeout(()=>espCmd({action:'stop'}),800);}
  else if(t.includes('[TURN_180]')){espCmd({action:'right',speed:40});setTimeout(()=>espCmd({action:'stop'}),1600);}
  if(t.includes('[HEAD_LEFT]')) espCmd({action:'servo_head',angle:45});
  else if(t.includes('[HEAD_RIGHT]')) espCmd({action:'servo_head',angle:135});
  else if(t.includes('[HEAD_CENTER]')) espCmd({action:'servo_head',angle:90});
  if(t.includes('[TILT_UP]')) espCmd({action:'servo_tilt',angle:60});
  else if(t.includes('[TILT_DOWN]')) espCmd({action:'servo_tilt',angle:120});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatRecOn=false;
function chatMic(){
  if(!SR||chatRecOn) return;
  const r=new SR();r.lang=sett.lang||'en-US';r.continuous=false;chatRecOn=true;
  document.getElementById('chatMicBtn').textContent='â¹';
  r.onresult=(e)=>{document.getElementById('chatInput').value=e.results[0][0].transcript;sendChat();};
  r.onend=()=>{chatRecOn=false;document.getElementById('chatMicBtn').textContent='ğŸ¤';};
  r.onerror=()=>{chatRecOn=false;document.getElementById('chatMicBtn').textContent='ğŸ¤';};
  try{r.start();}catch(ex){chatRecOn=false;document.getElementById('chatMicBtn').textContent='ğŸ¤';}
}
function sendChat(){
  const inp=document.getElementById('chatInput');const txt=inp.value.trim();if(!txt)return;inp.value='';
  if(/save this|remember this/i.test(txt)){const c=txt.replace(/save this|remember this/gi,'').trim();if(c){saveMem(c);addMsg('Memory saved: '+c.substring(0,50),'b');speak('Memory saved!');return;}}
  addMsg(txt,'u');saveChatMsg('user',txt);showTyping(true);
  callAI(txt,(reply)=>{showTyping(false);addMsg(reply,'b');saveChatMsg('bot',reply);setSub(reply);setEmotion(reply);speak(reply);handleRobotCmds(reply);saveMem(reply.substring(0,200));chatMsgCount++;if(chatMsgCount===2)autoName();});
}
function addMsg(txt,type){
  const l=document.getElementById('msgList');const d=document.createElement('div');
  d.className='msg '+(type==='u'?'u':type==='b'?'b':'s');d.textContent=txt;l.appendChild(d);
  setTimeout(()=>l.scrollTop=l.scrollHeight,50);
}
function showTyping(s){const t=document.getElementById('typingDiv');if(t)t.style.display=s?'block':'none';if(s){const l=document.getElementById('msgList');if(l)l.scrollTop=l.scrollHeight;}}
function newChat(){saveCurChat();curChatId=null;chatMsgCount=0;document.getElementById('msgList').innerHTML='<div class="msg s">New chat started!</div>';document.getElementById('sidebar').classList.remove('open');renderSidebar();}
function saveCurChat(){if(!curChatId)return;localStorage.setItem('bchats',JSON.stringify(chats));}
function saveChatMsg(role,text){
  if(!curChatId){curChatId=Date.now();chatMsgCount=0;chats.unshift({id:curChatId,name:'New Chat',msgs:[],time:new Date().toLocaleDateString()});}
  const c=chats.find(c=>c.id===curChatId);if(c){c.msgs.push({role,text});localStorage.setItem('bchats',JSON.stringify(chats));}
}
function autoName(){const c=chats.find(c=>c.id===curChatId);if(!c||c.name!=='New Chat')return;const f=c.msgs.find(m=>m.role==='user');if(!f)return;c.name=f.text.substring(0,35)+(f.text.length>35?'...':'');localStorage.setItem('bchats',JSON.stringify(chats));renderSidebar();}
function loadChat(id){saveCurChat();curChatId=id;chatMsgCount=0;const c=chats.find(c=>c.id===id);if(!c)return;const l=document.getElementById('msgList');l.innerHTML='';c.msgs.forEach(m=>addMsg(m.text,m.role==='user'?'u':'b'));setTimeout(()=>l.scrollTop=l.scrollHeight,50);document.getElementById('sidebar').classList.remove('open');renderSidebar();}
function deleteChat(id,ev){ev.stopPropagation();if(!confirm('Delete this chat?'))return;chats=chats.filter(c=>c.id!==id);if(curChatId===id){curChatId=null;document.getElementById('msgList').innerHTML='<div class="msg s">Chat deleted.</div>';}localStorage.setItem('bchats',JSON.stringify(chats));renderSidebar();}
function renderSidebar(){chats=JSON.parse(localStorage.getItem('bchats')||'[]');const l=document.getElementById('sbList');if(!l)return;if(!chats.length){l.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:20px;">No chats yet!</div>';return;}l.innerHTML='';chats.forEach(c=>{const d=document.createElement('div');d.className='sb-item'+(c.id===curChatId?' act':'');d.onclick=()=>loadChat(c.id);d.innerHTML=`<button class="sb-del" onclick="deleteChat(${c.id},event)">âœ•</button><div class="sb-name">${esc(c.name)}</div><div class="sb-date">${c.time}</div>`;l.appendChild(d);});}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');renderSidebar();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettUI(){
  keys=JSON.parse(localStorage.getItem('bk')||'{}');
  sett=JSON.parse(localStorage.getItem('bs')||'{}');
  if(keys.g) document.getElementById('kG').value=keys.g;
  if(keys.gh) document.getElementById('kGH').value=keys.gh;
  if(eIP) document.getElementById('espIP').value=eIP;
  [['tNav','autoNav'],['tObs','obstacle'],['tFollow','followPerson'],['tBat','batAlert'],['tLook','lookSpeak'],['tDetect','detection'],['tFaceRec','faceRec'],['tOCR','ocrMode'],['tGest','gestureCtrl']].forEach(([id,k])=>{const e=document.getElementById(id);if(e)e.className='tog'+(sett[k]?' on':'');});
  [['tGuard',bgGuardOn],['tEmerg',bgEmergOn]].forEach(([id,v])=>{const e=document.getElementById(id);if(e)e.className='tog'+(v?' on':'');});
  const p=document.getElementById('sPers');if(p)p.value=sett.personality||'friendly';
  const sp=document.getElementById('sSpeed');if(sp)sp.value=sett.voiceSpeed||0.9;
  const sl=document.getElementById('sLang');if(sl)sl.value=sett.lang||'en-US';
  renderModelList();renderKnownFaces();renderUnknownFaces();renderObjectLog();renderReminders();renderStats();
}
function saveKeys(){keys={g:document.getElementById('kG').value.trim(),gh:document.getElementById('kGH').value.trim()};localStorage.setItem('bk',JSON.stringify(keys));const m=document.getElementById('keyMsg');m.textContent='âœ“ Keys saved!';setTimeout(()=>m.textContent='',2000);renderModelList();}
function saveSett(){sett.personality=document.getElementById('sPers').value;sett.voiceSpeed=parseFloat(document.getElementById('sSpeed').value);sett.lang=document.getElementById('sLang').value;localStorage.setItem('bs',JSON.stringify(sett));}
function togSet(el,key){el.classList.toggle('on');sett[key]=el.classList.contains('on');localStorage.setItem('bs',JSON.stringify(sett));}
function togGuardian(el){el.classList.toggle('on');bgGuardOn=el.classList.contains('on');setPill('pillGuard',bgGuardOn);speak(bgGuardOn?'Guardian mode enabled.':'Guardian mode disabled.');}
function togEmergency(el){el.classList.toggle('on');bgEmergOn=el.classList.contains('on');if(bgEmergOn)listenEmerg();speak(bgEmergOn?'Emergency listener enabled.':'Emergency listener disabled.');}
function renderModelList(){
  const el=document.getElementById('modelList');if(!el)return;
  el.innerHTML='';
  [...MODELS].sort((a,b)=>b.tier-a.tier).forEach((m,i)=>{
    const h=!!keys[m.k],s=!!skip[m.name];
    const b=!h?'<span class="mbadge nokey">NO KEY</span>':s?'<span class="mbadge skip">QUOTA</span>':'<span class="mbadge ok">READY</span>';
    el.innerHTML+=`<div class="mrow"><span style="color:#ddd;font-size:12px;">${i+1}. ${m.name}</span>${b}</div>`;
  });
}
function resetSkip(){skip={};localStorage.setItem('bsk','{}');localStorage.setItem('bskt',''+Date.now());renderModelList();speak('Quota reset.');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KNOWN FACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function captureFace(){
  const name=document.getElementById('fOrigName').value.trim();
  const nick=document.getElementById('fNickname').value.trim();
  const call=document.getElementById('fCallName').value.trim();
  const rel=document.getElementById('fRelation').value.trim();
  if(!name){alert('Enter original name!');return;}
  if(!bgCamOn){alert('Enable camera first (tap ğŸ“· CAM on face screen)!');return;}
  const v=document.getElementById('bgCamVideo');
  if(!v.videoWidth){alert('Camera not ready!');return;}
  const c=document.createElement('canvas');c.width=80;c.height=80;
  c.getContext('2d').drawImage(v,0,0,80,80);
  knownFaces.push({id:Date.now(),name,nickname:nick,callName:call||'Hello '+name+'!',relation:rel,img:c.toDataURL('image/jpeg',0.7),time:new Date().toLocaleString()});
  localStorage.setItem('bfaces',JSON.stringify(knownFaces));
  ['fOrigName','fNickname','fCallName','fRelation'].forEach(id=>document.getElementById(id).value='');
  renderKnownFaces();speak('Face saved for '+name+'!');
}
function renderKnownFaces(){
  knownFaces=JSON.parse(localStorage.getItem('bfaces')||'[]');
  const el=document.getElementById('knownFaceList');if(!el)return;
  if(!knownFaces.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No faces registered yet</div>';return;}
  el.innerHTML='';
  knownFaces.forEach((f,i)=>{
    const d=document.createElement('div');d.className='face-card';
    d.innerHTML=`<img class="face-img" src="${f.img}"><div class="face-info"><div class="face-name">${esc(f.name)}</div><div class="face-sub">Nick: ${esc(f.nickname)||'â€”'} Â· Call: ${esc(f.callName)||'â€”'}</div><div class="face-sub">Relation: ${esc(f.relation)||'â€”'} Â· Added: ${f.time}</div></div><button class="face-del" onclick="deleteFace(${i})">âœ•</button>`;
    el.appendChild(d);
  });
}
function deleteFace(i){knownFaces.splice(i,1);localStorage.setItem('bfaces',JSON.stringify(knownFaces));renderKnownFaces();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNKNOWN FACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUnknownFaces(){
  unknownFaces=JSON.parse(localStorage.getItem('bunknown')||'[]');
  const el=document.getElementById('unknownFaceList');if(!el)return;
  if(!unknownFaces.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No unknowns detected yet</div>';return;}
  el.innerHTML='';
  unknownFaces.forEach((f,i)=>{
    const d=document.createElement('div');d.className='unk-card';
    d.innerHTML=`<img class="unk-img" src="${f.img}"><div style="flex:1;"><div style="font-size:12px;color:var(--o);">${f.time}</div></div><button onclick="registerUnknown(${i})" style="background:var(--c);border:none;border-radius:6px;color:#000;padding:4px 8px;font-size:11px;cursor:pointer;margin-right:6px;">REGISTER</button><button onclick="deleteUnknown(${i})" style="background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;">âœ•</button>`;
    el.appendChild(d);
  });
}
function deleteUnknown(i){unknownFaces.splice(i,1);localStorage.setItem('bunknown',JSON.stringify(unknownFaces));renderUnknownFaces();}
function registerUnknown(i){
  const f=unknownFaces[i];
  const name=prompt('Enter name for this person:');if(!name)return;
  knownFaces.push({id:Date.now(),name,nickname:'',callName:'Hello '+name+'!',relation:'Unknown',img:f.img,time:new Date().toLocaleString()});
  localStorage.setItem('bfaces',JSON.stringify(knownFaces));
  unknownFaces.splice(i,1);localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
  renderKnownFaces();renderUnknownFaces();speak('Face registered for '+name+'!');
}
function clearUnknowns(){unknownFaces=[];localStorage.removeItem('bunknown');renderUnknownFaces();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OBJECT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderObjectLog(){
  objectLog=JSON.parse(localStorage.getItem('bobjlog')||'[]');
  const el=document.getElementById('objectLogDiv');if(!el)return;
  if(!objectLog.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No objects logged yet</div>';return;}
  // Group by class and count
  const counts={};objectLog.forEach(o=>{counts[o.name]=(counts[o.name]||0)+1;});
  el.innerHTML=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([name,cnt])=>`<div class="det-item object"><b style="color:var(--o);">${name}</b> â€” seen ${cnt} time${cnt>1?'s':''}</div>`).join('');
}
function clearObjectLog(){objectLog=[];localStorage.removeItem('bobjlog');renderObjectLog();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addReminder(){
  const t=document.getElementById('remTime').value,tx=document.getElementById('remTxt').value.trim();
  if(!t||!tx){alert('Enter time and text!');return;}
  reminders.push({id:Date.now(),time:t,text:tx});
  localStorage.setItem('brem',JSON.stringify(reminders));
  document.getElementById('remTxt').value='';renderReminders();
}
function renderReminders(){
  reminders=JSON.parse(localStorage.getItem('brem')||'[]');
  const el=document.getElementById('reminderList');if(!el)return;
  if(!reminders.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:10px;">No reminders set</div>';return;}
  el.innerHTML='';
  reminders.forEach((r,i)=>{
    const d=document.createElement('div');d.className='rem-item';
    d.innerHTML=`<div class="rem-time">${r.time}</div><div style="flex:1;font-size:14px;">${esc(r.text)}</div><button class="rem-del" onclick="delReminder(${i})">âœ•</button>`;
    el.appendChild(d);
  });
}
function delReminder(i){reminders.splice(i,1);localStorage.setItem('brem',JSON.stringify(reminders));renderReminders();}
function checkReminders(){
  const now=new Date();
  const cur=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  reminders.forEach(r=>{if(r.time===cur&&Date.now()-(r.lastFired||0)>60000){r.lastFired=Date.now();speak('Reminder: '+r.text);setSub('â° '+r.text);}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUN & GAMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tellJoke(){
  document.getElementById('funResult').textContent='Loading joke...';
  callAI('Tell me a funny short joke.',(r)=>{document.getElementById('funResult').textContent=r;speak(r);},'You are a comedian. Tell one funny clean joke in 2 sentences. No emojis.');
}
function tellStory(){
  document.getElementById('funResult').textContent='Creating story...';
  callAI('Tell me a short 3-sentence exciting story.',(r)=>{document.getElementById('funResult').textContent=r;speak(r);},'You are a storyteller. Tell a short exciting story in exactly 3 sentences. No emojis.');
}
function robotDance(){
  if(!rOK){document.getElementById('funResult').textContent='Connect robot first to dance!';return;}
  document.getElementById('funResult').textContent='Dancing! Watch me move!';speak('Let me dance!');
  const moves=[{action:'left'},{action:'right'},{action:'left'},{action:'right'},{action:'forward'},{action:'backward'},{action:'stop'}];
  let i=0;const d=setInterval(()=>{if(i>=moves.length){clearInterval(d);return;}espCmd({...moves[i++],speed:60});},600);
}
function startTrivia(){
  triviaIdx=0;triviaScore=0;
  document.getElementById('tScore').textContent=0;document.getElementById('tNum').textContent=1;
  document.getElementById('triviaArea').style.display='block';
  document.getElementById('funResult').textContent='Trivia started! Answer the questions below.';
  showTrivia();
}
function showTrivia(){
  if(triviaIdx>=TRIVIA.length){document.getElementById('tQuestion').textContent='Game over! Score: '+triviaScore+'/'+TRIVIA.length;document.getElementById('tOptions').innerHTML='';speak('Game over! Score: '+triviaScore+' out of '+TRIVIA.length);return;}
  const q=TRIVIA[triviaIdx];document.getElementById('tQuestion').textContent=q.q;
  const opts=document.getElementById('tOptions');opts.innerHTML='';
  q.opts.forEach((o,i)=>{const b=document.createElement('button');b.className='t-opt';b.textContent=o;b.onclick=()=>ansTrivia(i,q.a,opts);opts.appendChild(b);});
}
function ansTrivia(ch,cor,opts){
  opts.querySelectorAll('.t-opt').forEach((b,i)=>{b.onclick=null;if(i===cor)b.classList.add('correct');else if(i===ch)b.classList.add('wrong');});
  if(ch===cor){triviaScore++;document.getElementById('tScore').textContent=triviaScore;speak('Correct!');}
  else speak('Wrong! Answer: '+TRIVIA[triviaIdx].opts[cor]);
}
function nextTrivia(){triviaIdx++;document.getElementById('tNum').textContent=triviaIdx+1;showTrivia();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS & LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMovLog(msg){movLog.unshift(new Date().toLocaleTimeString()+' â€” '+msg);if(movLog.length>50)movLog.splice(50);}
function addDetLog(msg){detLog.unshift(new Date().toLocaleTimeString()+' â€” '+msg);if(detLog.length>50)detLog.splice(50);}
function renderStats(){
  const el=document.getElementById('statsBlock');if(!el)return;
  const min=Math.round((Date.now()-stats.sessionStart)/60000);
  el.innerHTML=[
    ['Session Time',min+' min'],['Obstacles Hit',stats.obstacles],
    ['Objects Detected',stats.detections],['People Seen',stats.people],
    ['Motion Alerts',stats.motionAlerts],['AI Commands',stats.cmds],
  ].map(([k,v])=>`<div class="rep-row"><span class="rep-k">${k}</span><span class="rep-v">${v}</span></div>`).join('');
  const ml=document.getElementById('movLogDiv');if(ml)ml.innerHTML=movLog.map(l=>`<div class="log-entry">${l}</div>`).join('')||'<div style="color:#333;font-size:12px;text-align:center;padding:8px;">No movement logged</div>';
  const dl=document.getElementById('detLogDiv');if(dl)dl.innerHTML=detLog.map(l=>`<div class="log-entry">${l}</div>`).join('')||'<div style="color:#333;font-size:12px;text-align:center;padding:8px;">No detections logged</div>';
}
async function generateReport(){
  const el=document.getElementById('aiReportDiv');el.style.display='block';el.textContent='Generating report...';
  const min=Math.round((Date.now()-stats.sessionStart)/60000);
  const data=`Session: ${min}min, Obstacles: ${stats.obstacles}, Detections: ${stats.detections}, People: ${stats.people}, Motion alerts: ${stats.motionAlerts}, Commands: ${stats.cmds}`;
  callAI('Generate a short professional robot activity report. Data: '+data,
    (r)=>{el.textContent=r;speak(r.substring(0,200));},
    'You are a robot activity analyst. Write a 3-sentence professional report with one insight and efficiency estimate. No emojis.');
}
function clearAllLogs(){movLog=[];detLog=[];renderStats();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMORY & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveMem(text){if(!text||text.length<3)return;mems.unshift({id:Date.now(),text,time:new Date().toLocaleString()});if(mems.length>500)mems=mems.slice(0,500);localStorage.setItem('bm',JSON.stringify(mems));}
function esc(s){return(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function checkVoice(){const el=document.getElementById('voiceBox');el.style.display='block';const v=window.speechSynthesis.getVoices();const s=getBritishVoice();el.innerHTML='<b style="color:var(--c)">Selected:</b> '+(s?s.name+' ('+s.lang+')':'None')+'<br><b style="color:var(--c)">All English:</b><br>'+v.filter(x=>x.lang.startsWith('en')).map((x,i)=>`${i+1}. ${x.name}`).join('<br>');speak('Hello! I am Bro AI, your robot companion.');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
keys     = JSON.parse(localStorage.getItem('bk')||'{}');
sett     = JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"autoNav":true,"batAlert":true,"followPerson":false,"detection":true,"faceRec":true,"ocrMode":false,"gestureCtrl":false,"lookSpeak":true,"personality":"friendly","voiceSpeed":0.9,"lang":"en-US"}');
mems     = JSON.parse(localStorage.getItem('bm')||'[]');
skip     = JSON.parse(localStorage.getItem('bsk')||'{}');
chats    = JSON.parse(localStorage.getItem('bchats')||'[]');
habits   = JSON.parse(localStorage.getItem('bhab')||'{}');
knownFaces   = JSON.parse(localStorage.getItem('bfaces')||'[]');
unknownFaces = JSON.parse(localStorage.getItem('bunknown')||'[]');
objectLog    = JSON.parse(localStorage.getItem('bobjlog')||'[]');
reminders    = JSON.parse(localStorage.getItem('brem')||'[]');
if(eIP) document.getElementById('espIP').value=eIP;
if(window.speechSynthesis) window.speechSynthesis.getVoices();

// Load ML in background (non-blocking)
loadML();

// Start emergency listener
setTimeout(startBgEmergency, 3000);

// Reminder checker every minute
setInterval(checkReminders, 60000);
</script>
</body>
</html>
