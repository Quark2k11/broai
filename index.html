<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>BroAI</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');
:root{--c:#00FFFF;--d:#000;--d2:#0A0A1A;--d3:#0D0D2B;--g:#AAA;--gr:#00FF88;--r:#FF4444;--o:#FF8800;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;height:-webkit-fill-available;}
body{background:var(--d);color:#fff;font-family:'Rajdhani',sans-serif;height:100vh;height:-webkit-fill-available;overflow:hidden;}
.screen{display:none;width:100%;height:100%;flex-direction:column;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1;}
.screen.active{display:flex;}

/* HOME */
#homeScreen{background:radial-gradient(ellipse at center,#0D0D2B 0%,#000 70%);justify-content:center;align-items:center;gap:18px;}
.hl{font-family:'Orbitron',monospace;font-size:50px;font-weight:900;color:var(--c);text-shadow:0 0 30px rgba(0,255,255,0.8);letter-spacing:8px;animation:glow 2s infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 30px rgba(0,255,255,0.8)}50%{text-shadow:0 0 60px rgba(0,255,255,1)}}
.hs{color:var(--g);font-size:13px;letter-spacing:4px;text-transform:uppercase;margin-bottom:8px;}
.hb{width:82%;max-width:320px;height:56px;border:none;border-radius:30px;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:2px;cursor:pointer;}
.hb.p{background:var(--c);color:#000;box-shadow:0 0 20px rgba(0,255,255,0.4);}
.hb.s{background:transparent;color:var(--c);border:2px solid var(--c);}

/* CHAT SCREEN - KEY FIX */
#chatScreen{background:var(--d);}
.chat-wrap{display:flex;flex-direction:column;flex:1;overflow:hidden;position:relative;}
#cL{flex:1;overflow-y:auto;padding:12px 12px 8px;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;}

/* INPUT BAR - ALWAYS VISIBLE */
.ib{display:flex;align-items:center;padding:8px 10px 8px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.2);gap:8px;flex-shrink:0;position:sticky;bottom:0;z-index:100;}
#uI{flex:1;background:#1A1A3E;border:2px solid rgba(0,255,255,0.4);border-radius:24px;padding:11px 16px;color:#fff;font-size:16px;font-family:'Rajdhani',sans-serif;outline:none;min-width:0;-webkit-appearance:none;}
#uI::placeholder{color:#666;}
#uI:focus{border-color:var(--c);background:#1f1f4a;}
.ib-btn{width:46px;height:46px;border-radius:50%;border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sb{background:var(--c);color:#000;}
.vb{background:var(--d2);color:var(--c);border:1px solid rgba(0,255,255,0.3);}
.vb.on{background:var(--r);color:#fff;}

/* MESSAGES */
.msg{max-width:85%;padding:11px 15px;border-radius:18px;font-size:15px;line-height:1.5;word-break:break-word;}
.msg.u{align-self:flex-end;background:var(--c);color:#000;font-weight:600;border-bottom-right-radius:4px;}
.msg.b{align-self:flex-start;background:var(--d3);color:#fff;border:1px solid rgba(0,255,255,0.2);border-bottom-left-radius:4px;}
.msg.e{align-self:flex-start;background:rgba(255,68,68,0.1);color:var(--r);border:1px solid var(--r);border-radius:12px;font-size:13px;}
.msg.sy{align-self:center;background:rgba(0,255,255,0.05);color:var(--g);font-size:12px;border-radius:12px;text-align:center;max-width:92%;}
.tw{padding:0 12px 4px;flex-shrink:0;display:none;}
.td{display:inline-flex;background:var(--d3);border:1px solid rgba(0,255,255,0.2);border-radius:18px;padding:12px 16px;}
.dd{display:flex;gap:6px;}
.dd span{width:8px;height:8px;border-radius:50%;background:var(--c);animation:dot 1.2s infinite;}
.dd span:nth-child(2){animation-delay:0.2s}.dd span:nth-child(3){animation-delay:0.4s}
@keyframes dot{0%,100%{opacity:0.3;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}

/* TOPBAR */
.tb{display:flex;align-items:center;padding:10px 14px;background:var(--d3);border-bottom:1px solid rgba(0,255,255,0.2);min-height:52px;gap:10px;flex-shrink:0;}
.tt{font-family:'Orbitron',monospace;font-size:14px;color:var(--c);font-weight:700;flex:1;}
.ts{font-size:11px;color:var(--gr);display:flex;align-items:center;gap:4px;flex-shrink:0;}
.sd{width:8px;height:8px;border-radius:50%;background:var(--gr);animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.bb{background:none;border:none;color:var(--c);font-size:22px;cursor:pointer;padding:4px 8px;flex-shrink:0;}
.al{font-size:10px;color:var(--o);background:rgba(255,136,0,0.15);border:1px solid var(--o);border-radius:10px;padding:2px 8px;letter-spacing:1px;flex-shrink:0;}

/* BROBOT */
#brobotScreen{background:var(--d);}
.mt{display:flex;background:var(--d2);border-bottom:1px solid rgba(0,255,255,0.15);overflow-x:auto;scrollbar-width:none;flex-shrink:0;}
.mt::-webkit-scrollbar{display:none;}
.tb2{flex-shrink:0;padding:10px 13px;background:none;border:none;color:var(--g);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;letter-spacing:1px;}
.tb2.a{color:var(--c);border-bottom-color:var(--c);}
.mc{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.mc.a{display:flex;flex-direction:column;}

/* FACE MODE */
#faceMode{background:#000;justify-content:center;align-items:center;position:relative;flex:1;}
.ew{display:flex;gap:44px;justify-content:center;align-items:center;flex:1;}
.eye{width:100px;height:100px;background:var(--c);border-radius:50%;position:relative;box-shadow:0 0 40px rgba(0,255,255,0.8);transition:all 0.2s;overflow:hidden;}
.eye.blink{height:8px!important;border-radius:4px!important;}
.pu{position:absolute;width:40px;height:40px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:all 0.3s;}
.sh{position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.el{position:absolute;top:28px;font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;}
.sub{width:100%;background:rgba(0,0,0,0.88);border-top:1px solid rgba(0,255,255,0.2);padding:12px 18px;text-align:center;font-size:15px;color:#fff;min-height:50px;display:flex;align-items:center;justify-content:center;flex-shrink:0;word-break:break-word;}

/* CONTROL */
#controlMode{padding:14px;gap:14px;}
.st{font-family:'Orbitron',monospace;font-size:10px;color:var(--c);letter-spacing:3px;opacity:0.7;margin-bottom:8px;}
.dp{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:210px;margin:0 auto;}
.db{height:56px;border-radius:12px;border:1px solid rgba(0,255,255,0.3);background:var(--d3);color:var(--c);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.db:active{background:rgba(0,255,255,0.2);}
.de{background:none!important;border:none!important;cursor:default!important;}
.stop{background:rgba(255,68,68,0.15)!important;border-color:var(--r)!important;color:var(--r)!important;font-size:12px!important;font-weight:700;font-family:'Orbitron',monospace;}
.sl{width:100%;-webkit-appearance:none;height:6px;border-radius:3px;background:var(--d3);outline:none;border:1px solid rgba(0,255,255,0.2);}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--c);cursor:pointer;}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sc{background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-radius:12px;padding:10px;}
.sla{font-size:10px;color:var(--g);margin-bottom:3px;}
.sv{font-family:'Orbitron',monospace;font-size:16px;color:var(--c);}
.wi{width:100%;background:var(--d3);border:1px solid rgba(0,255,255,0.3);border-radius:10px;padding:10px 14px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;margin-bottom:8px;-webkit-appearance:none;}
.ab{width:100%;height:44px;background:var(--c);color:#000;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;}
.ab.red{background:rgba(255,68,68,0.15);color:var(--r);border:1px solid var(--r);}

/* CAMERA */
#cameraMode{background:#000;justify-content:center;align-items:center;position:relative;flex:1;}
#cf{width:100%;height:100%;object-fit:cover;}
.ci{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,255,0.3);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--c);font-family:'Orbitron',monospace;}
.cbtn{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:var(--c);color:#000;border:none;border-radius:24px;padding:12px 28px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;cursor:pointer;}

/* MEMORY */
#memoryMode{padding:14px;gap:10px;}
.madd{background:var(--d3);border:1px solid rgba(0,255,255,0.2);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;}
.mi{background:var(--d2);border:1px solid rgba(0,255,255,0.2);border-radius:8px;padding:10px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;resize:none;width:100%;height:60px;}
.mcard{background:var(--d3);border:1px solid rgba(0,255,255,0.1);border-radius:12px;padding:12px;position:relative;margin-bottom:8px;}
.mtime{font-size:10px;color:var(--g);margin-bottom:4px;}
.mtext{font-size:14px;color:#fff;line-height:1.4;padding-right:60px;}
.mtag{display:inline-block;font-size:10px;color:var(--o);background:rgba(255,136,0,0.1);border:1px solid var(--o);border-radius:8px;padding:1px 7px;margin-top:4px;}
.mdel{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--r);font-size:16px;cursor:pointer;}
.medit{position:absolute;top:10px;right:36px;background:none;border:none;color:var(--c);font-size:14px;cursor:pointer;}

/* SETTINGS */
#settingsMode{padding:14px;gap:10px;}
.sr{display:flex;align-items:center;justify-content:space-between;background:var(--d3);border:1px solid rgba(0,255,255,0.1);border-radius:12px;padding:12px 14px;}
.slb{font-size:15px;font-weight:600;}
.sdb{font-size:11px;color:var(--g);margin-top:2px;}
.tog{width:48px;height:26px;background:var(--d2);border-radius:13px;border:1px solid rgba(0,255,255,0.3);position:relative;cursor:pointer;transition:all 0.3s;flex-shrink:0;}
.tog.on{background:var(--c);border-color:var(--c);}
.tog::after{content:'';position:absolute;width:20px;height:20px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all 0.3s;}
.tog.on::after{left:24px;}
.sel{background:var(--d2);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:6px 10px;font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:var(--d2)}::-webkit-scrollbar-thumb{background:rgba(0,255,255,0.3);border-radius:2px}
</style>
</head>
<body>

<!-- HOME -->
<div id="homeScreen" class="screen active">
  <div class="hl">BroAI</div>
  <div class="hs">Unified AI ¬∑ Robot Brain</div>
  <button class="hb p" onclick="go('chatScreen')">üí¨ &nbsp;BroAI Mode</button>
  <button class="hb s" onclick="go('brobotScreen')">ü§ñ &nbsp;BroBot Mode</button>
  <div style="font-size:10px;color:#333;margin-top:14px;letter-spacing:2px;">v3.0 ¬∑ UNIFIED AI BRAIN</div>
</div>

<!-- CHAT SCREEN -->
<div id="chatScreen" class="screen">
  <div class="tb">
    <button class="bb" onclick="go('homeScreen')">‚Üê</button>
    <div class="tt">BroAI</div>
    <div class="al" id="aiL">GEMINI</div>
    <div class="ts"><div class="sd"></div>Online</div>
  </div>
  <div class="chat-wrap">
    <div id="cL">
      <div class="msg sy">BroAI Unified Brain v3 ‚úÖ<br>Go to BroBot ‚Üí Settings ‚Üí Enter API keys first!</div>
    </div>
    <div class="tw" id="tW"><div class="td"><div class="dd"><span></span><span></span><span></span></div></div></div>
    <div class="ib">
      <button class="ib-btn vb" id="vBtn" onclick="toggleVoice()">üé§</button>
      <input type="text" id="uI" placeholder="Ask BroAI..." onkeypress="onK(event)" autocomplete="off">
      <button class="ib-btn sb" onclick="sendMsg()">‚û§</button>
    </div>
  </div>
</div>

<!-- BROBOT -->
<div id="brobotScreen" class="screen">
  <div class="tb">
    <button class="bb" onclick="go('homeScreen')">‚Üê</button>
    <div class="tt">BroBot</div>
    <div class="ts" id="rSt"><div class="sd" style="background:var(--r)"></div>Disconnected</div>
  </div>
  <div class="mt">
    <button class="tb2 a" onclick="tab('faceMode',this)">üëÅ FACE</button>
    <button class="tb2" onclick="tab('controlMode',this)">üïπ CONTROL</button>
    <button class="tb2" onclick="tab('cameraMode',this)">üì∑ CAMERA</button>
    <button class="tb2" onclick="tab('memoryMode',this)">üß† MEMORY</button>
    <button class="tb2" onclick="tab('settingsMode',this)">‚öôÔ∏è SETTINGS</button>
  </div>

  <div id="faceMode" class="mc a" style="position:relative;background:#000;flex:1;">
    <div class="el" id="eL">NEUTRAL</div>
    <div class="ew">
      <div class="eye" id="eLeft"><div class="pu" id="pL"></div><div class="sh"></div></div>
      <div class="eye" id="eRight"><div class="pu" id="pR"></div><div class="sh"></div></div>
    </div>
    <div class="sub" id="sub">Hello! I am BroBot. How can I help you?</div>
  </div>

  <div id="controlMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:14px;">
      <div><div class="st">MOVEMENT</div>
        <div class="dp">
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('forward')" onpointerup="cmd('stop')">‚ñ≤</button>
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('left')" onpointerup="cmd('stop')">‚óÑ</button>
          <button class="db stop" onclick="cmd('stop')">STOP</button>
          <button class="db" onpointerdown="cmd('right')" onpointerup="cmd('stop')">‚ñ∫</button>
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('backward')" onpointerup="cmd('stop')">‚ñº</button>
          <div class="db de"></div>
        </div>
      </div>
      <div><div class="st">HEAD ROTATE: <span id="hV">90</span>¬∞</div><input type="range" class="sl" min="0" max="180" value="90" oninput="moveHead(this.value)"></div>
      <div><div class="st">HEAD TILT UP/DOWN: <span id="tV">90</span>¬∞</div><input type="range" class="sl" min="30" max="150" value="90" oninput="moveTilt(this.value)"></div>
      <div><div class="st">SPEED: <span id="spV">50</span>%</div><input type="range" class="sl" min="10" max="100" value="50" oninput="updSp(this.value)"></div>
      <div><div class="st">SENSORS</div>
        <div class="sg">
          <div class="sc"><div class="sla">ULTRASONIC</div><div class="sv" id="us">--</div><div style="font-size:10px;color:var(--g)">cm</div></div>
          <div class="sc"><div class="sla">BATTERY</div><div class="sv" id="bat">--</div><div style="font-size:10px;color:var(--g)">%</div></div>
          <div class="sc"><div class="sla">IR FRONT-L</div><div class="sv" id="i1" style="font-size:13px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR FRONT-R</div><div class="sv" id="i2" style="font-size:13px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR REAR-L</div><div class="sv" id="i3" style="font-size:13px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR REAR-R</div><div class="sv" id="i4" style="font-size:13px">CLEAR</div></div>
        </div>
      </div>
      <div><div class="st">ESP32 CONNECTION</div>
        <input type="text" class="wi" id="eIP" placeholder="ESP32 IP e.g. 192.168.1.100">
        <button class="ab" onclick="connectESP()">CONNECT TO BROBOT</button>
        <div id="cMsg" style="text-align:center;font-size:12px;color:var(--g);margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div id="cameraMode" class="mc" style="position:relative;background:#000;flex:1;">
    <video id="cf" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;"></video>
    <div class="ci" id="camI">CAMERA OFF</div>
    <button class="cbtn" id="camB" onclick="toggleCam()">START CAMERA</button>
  </div>

  <div id="memoryMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:10px;">
      <div class="st">ADD MEMORY</div>
      <div class="madd">
        <textarea class="mi" id="mInp" placeholder="Type memory... or say 'save this [info]' in chat!"></textarea>
        <div style="display:flex;gap:8px;">
          <select class="sel" id="mCat" style="flex:1;">
            <option value="general">General</option>
            <option value="preference">My Preference</option>
            <option value="fact">Important Fact</option>
            <option value="task">Task/Goal</option>
            <option value="person">Person Info</option>
          </select>
          <button class="ab" style="flex:1;" onclick="addMem()">SAVE</button>
        </div>
      </div>
      <div class="st">ALL MEMORIES (<span id="mCount">0</span>) ‚Äî UNLIMITED</div>
      <div id="mList"></div>
      <button class="ab red" onclick="clearMems()">üóë CLEAR ALL</button>
    </div>
  </div>

  <div id="settingsMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:10px;">
      <div class="st">API KEYS ‚Äî SAVED PERMANENTLY</div>
      <input type="password" class="wi" id="kG" placeholder="Gemini API Key">
      <input type="password" class="wi" id="kO" placeholder="OpenRouter API Key">
      <input type="password" class="wi" id="kT" placeholder="Together AI Key">
      <input type="password" class="wi" id="kH" placeholder="HuggingFace Key">
      <input type="password" class="wi" id="kGH" placeholder="GitHub AI Key">
      <button class="ab" onclick="saveKeys()">üíæ SAVE ALL KEYS</button>
      <div id="kMsg" style="text-align:center;font-size:12px;color:var(--gr);"></div>
      <div class="st" style="margin-top:6px;">BROBOT SETTINGS</div>
      <div class="sr"><div><div class="slb">Auto Obstacle Avoid</div><div class="sdb">Stop when sensor detects obstacle</div></div><div class="tog on" id="tO" onclick="tog(this,'obstacle')"></div></div>
      <div class="sr"><div><div class="slb">Face Tracking</div><div class="sdb">Head follows detected faces</div></div><div class="tog on" id="tF" onclick="tog(this,'face')"></div></div>
      <div class="sr"><div><div class="slb">Look At Speaker</div><div class="sdb">Head turns when BroAI talks</div></div><div class="tog on" id="tLS" onclick="tog(this,'lookSpeak')"></div></div>
      <div class="sr"><div><div class="slb">Auto Navigation</div><div class="sdb">BroBot moves on its own</div></div><div class="tog" id="tN" onclick="tog(this,'nav')"></div></div>
      <div class="sr"><div><div class="slb">Personality</div></div><select class="sel" id="sP" onchange="saveSett()"><option value="friendly">Friendly</option><option value="funny">Funny Bro</option><option value="professional">Professional</option><option value="serious">Serious</option></select></div>
      <div class="sr"><div><div class="slb">Voice Speed</div></div><input type="range" min="0.5" max="2" step="0.1" value="1" id="sVS" style="width:100px;" oninput="saveSett()"></div>
    </div>
  </div>
</div>

<script>
let keys=JSON.parse(localStorage.getItem('bk')||'{}');
let sett=JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"face":true,"lookSpeak":true,"nav":false,"personality":"friendly","voiceSpeed":1}');
let mems=JSON.parse(localStorage.getItem('bm')||'[]');
let eIP=localStorage.getItem('bi')||'';
let rOK=false,camOn=false,vOn=false,sp=50;
let curAI='gemini',lastM='',hist='';
let bT,eT,sT,rec;

// Fix keyboard pushing input bar on Android Chrome
window.addEventListener('resize',()=>{
  if(document.activeElement===document.getElementById('uI')){
    setTimeout(()=>{
      const l=document.getElementById('cL');
      if(l)l.scrollTop=l.scrollHeight;
    },100);
  }
});

function go(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='brobotScreen'){startEyes();renderMems();loadSett();loadKeysUI();if(eIP)document.getElementById('eIP').value=eIP;}
  else stopEyes();
}

function tab(id,btn){
  document.querySelectorAll('.mc').forEach(m=>m.classList.remove('a'));
  document.querySelectorAll('.tb2').forEach(b=>b.classList.remove('a'));
  document.getElementById(id).classList.add('a');btn.classList.add('a');
}

function onK(e){if(e.key==='Enter'){e.preventDefault();sendMsg();}}

function sendMsg(){
  const inp=document.getElementById('uI');
  const txt=inp.value.trim();if(!txt)return;
  inp.value='';lastM=txt;
  addMsg(txt,'u');
  if(memCmd(txt))return;
  showTy(true);callAI(txt);
}

function memCmd(txt){
  const t=txt.toLowerCase();
  if(t.includes('save this')||t.includes('remember this')||t.includes('save memory')||t.includes('add to memory')){
    const c=txt.replace(/save this|remember this|save memory|add to memory/gi,'').trim();
    if(c){saveMem(c,'preference','manual');addMsg('‚úÖ Memory saved: "'+c.substring(0,60)+'"','b');speak('Memory saved!');return true;}
  }
  if(t.includes('what do you remember')||t.includes('show memories')){
    const r=mems.slice(0,5).map(m=>m.text).join(', ');
    addMsg(r?'I remember: '+r:'No saved memories yet!','b');return true;
  }
  return false;
}

function addMsg(text,type){
  const l=document.getElementById('cL');
  const d=document.createElement('div');
  d.className='msg '+type;d.textContent=text;l.appendChild(d);
  setTimeout(()=>l.scrollTop=l.scrollHeight,50);
  if(type==='b'){saveMem(text.substring(0,200),'general','auto');speak(text);setEmo(text);checkCmds(text);setSub(text);}
}

function showTy(s){
  document.getElementById('tW').style.display=s?'block':'none';
  if(s){setTimeout(()=>{const l=document.getElementById('cL');l.scrollTop=l.scrollHeight;},50);}
}

async function callAI(msg){
  const pers=sett.personality||'friendly';
  const mc=mems.slice(0,8).map(m=>'['+m.category+']: '+m.text).join('; ');
  const sys=`You are BroAI, a ${pers} AI robot companion. Hardware: 4 wheels, 4 IR sensors, ultrasonic on servo, phone as head on tilt servo. Movement brackets: [MOVE_FORWARD] [MOVE_BACKWARD] [TURN_LEFT] [TURN_RIGHT] [STOP] [HEAD_LEFT] [HEAD_RIGHT] [HEAD_CENTER] [TILT_UP] [TILT_DOWN]. Memories: ${mc}. Context: ${hist.slice(-400)}`;
  const ok=await tryG(msg,sys)||await tryOR(msg,sys)||await tryTog(msg,sys)||await tryHF(msg)||await tryGH(msg,sys);
  if(!ok){showTy(false);addMsg('All AI systems busy. Check API keys in Settings!','e');}
}

async function tryG(msg,sys){
  if(!keys.g)return false;
  try{
    document.getElementById('aiL').textContent='GEMINI';
    const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key='+keys.g,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:sys+'\nUser: '+msg}]}]})});
    if(!r.ok)return false;
    const d=await r.json();const t=d.candidates?.[0]?.content?.parts?.[0]?.text;if(!t)return false;
    showTy(false);hist+='U:'+msg+' B:'+t+' ';addMsg(t,'b');return true;
  }catch(e){return false;}
}

async function tryOR(msg,sys){
  if(!keys.o)return false;
  try{
    document.getElementById('aiL').textContent='OPENROUTER';
    const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+keys.o},body:JSON.stringify({model:'mistralai/mistral-7b-instruct:free',messages:[{role:'system',content:sys},{role:'user',content:msg}]})});
    if(!r.ok)return false;
    const d=await r.json();const t=d.choices?.[0]?.message?.content;if(!t)return false;
    showTy(false);hist+='U:'+msg+' B:'+t+' ';addMsg(t,'b');return true;
  }catch(e){return false;}
}

async function tryTog(msg,sys){
  if(!keys.t)return false;
  try{
    document.getElementById('aiL').textContent='TOGETHER';
    const r=await fetch('https://api.together.xyz/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+keys.t},body:JSON.stringify({model:'mistralai/Mistral-7B-Instruct-v0.1',messages:[{role:'system',content:sys},{role:'user',content:msg}]})});
    if(!r.ok)return false;
    const d=await r.json();const t=d.choices?.[0]?.message?.content;if(!t)return false;
    showTy(false);hist+='U:'+msg+' B:'+t+' ';addMsg(t,'b');return true;
  }catch(e){return false;}
}

async function tryHF(msg){
  if(!keys.h)return false;
  try{
    document.getElementById('aiL').textContent='HUGGINGFACE';
    const r=await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+keys.h},body:JSON.stringify({inputs:'You are BroAI. Answer: '+msg,parameters:{max_new_tokens:200}})});
    if(!r.ok)return false;
    const d=await r.json();
    let t=Array.isArray(d)?d[0]?.generated_text:d?.generated_text;
    if(!t)return false;
    t=t.replace('You are BroAI. Answer: '+msg,'').trim();
    showTy(false);hist+='U:'+msg+' B:'+t+' ';addMsg(t,'b');return true;
  }catch(e){return false;}
}

async function tryGH(msg,sys){
  if(!keys.gh)return false;
  try{
    document.getElementById('aiL').textContent='GITHUB AI';
    const r=await fetch('https://models.inference.ai.azure.com/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+keys.gh},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:sys},{role:'user',content:msg}]})});
    if(!r.ok)return false;
    const d=await r.json();const t=d.choices?.[0]?.message?.content;if(!t)return false;
    showTy(false);hist+='U:'+msg+' B:'+t+' ';addMsg(t,'b');return true;
  }catch(e){return false;}
}

function checkCmds(text){
  if(!rOK)return;const t=text.toUpperCase();
  if(t.includes('[MOVE_FORWARD]'))cmd('forward');
  else if(t.includes('[MOVE_BACKWARD]'))cmd('backward');
  else if(t.includes('[TURN_LEFT]'))cmd('left');
  else if(t.includes('[TURN_RIGHT]'))cmd('right');
  else if(t.includes('[STOP]'))cmd('stop');
  if(t.includes('[HEAD_LEFT]'))sendE({action:'servo_head',angle:45});
  else if(t.includes('[HEAD_RIGHT]'))sendE({action:'servo_head',angle:135});
  else if(t.includes('[HEAD_CENTER]'))sendE({action:'servo_head',angle:90});
  if(t.includes('[TILT_UP]'))sendE({action:'servo_tilt',angle:60});
  else if(t.includes('[TILT_DOWN]'))sendE({action:'servo_tilt',angle:120});
}

function lookAtSpeaker(){if(!rOK||!sett.lookSpeak)return;sendE({action:'servo_head',angle:90});sendE({action:'servo_tilt',angle:75});}

async function cmd(a){await sendE({action:a,speed:sp,duration:0});}

async function sendE(obj){
  if(!eIP)return;
  try{await fetch('http://'+eIP+'/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj),signal:AbortSignal.timeout(1000)});}
  catch(e){}
}

function moveHead(v){document.getElementById('hV').textContent=v;sendE({action:'servo_head',angle:parseInt(v)});}
function moveTilt(v){document.getElementById('tV').textContent=v;sendE({action:'servo_tilt',angle:parseInt(v)});}
function updSp(v){sp=parseInt(v);document.getElementById('spV').textContent=v;}

async function connectESP(){
  const ip=document.getElementById('eIP').value.trim();
  if(!ip){alert('Enter ESP32 IP!');return;}
  eIP=ip;localStorage.setItem('bi',ip);
  const m=document.getElementById('cMsg');m.textContent='Connecting...';m.style.color='var(--o)';
  try{
    const r=await fetch('http://'+ip+'/ping',{signal:AbortSignal.timeout(3000)});
    if(r.ok){rOK=true;m.textContent='‚úÖ BroBot Connected!';m.style.color='var(--gr)';document.getElementById('rSt').innerHTML='<div class="sd"></div>Connected';startSensors();}
    else throw new Error();
  }catch(e){rOK=false;m.textContent='‚ùå Cannot connect. Check IP & WiFi!';m.style.color='var(--r)';}
}

function startSensors(){
  clearInterval(sT);
  sT=setInterval(async()=>{
    if(!rOK||!eIP)return;
    try{
      const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(800)});
      const d=await r.json();
      if(d.ultrasonic!==undefined)document.getElementById('us').textContent=d.ultrasonic;
      if(d.battery!==undefined)document.getElementById('bat').textContent=d.battery;
      [['ir1','i1'],['ir2','i2'],['ir3','i3'],['ir4','i4']].forEach(([k,id])=>{if(d[k]!==undefined)document.getElementById(id).textContent=d[k]?'BLOCKED':'CLEAR';});
      if(sett.obstacle&&(d.ir1||d.ir2||d.ultrasonic<15))cmd('stop');
    }catch(e){}
  },500);
}

let vOn2=false;
function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){alert('Use Chrome for voice!');return;}
  if(vOn2){rec?.stop();return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  rec=new SR();rec.lang='en-US';rec.continuous=false;rec.interimResults=false;
  rec.onstart=()=>{vOn2=true;document.getElementById('vBtn').classList.add('on');document.getElementById('vBtn').textContent='‚èπ';};
  rec.onresult=(e)=>{const t=e.results[0][0].transcript;document.getElementById('uI').value=t;sendMsg();};
  rec.onend=()=>{vOn2=false;document.getElementById('vBtn').classList.remove('on');document.getElementById('vBtn').textContent='üé§';};
  rec.start();
}

function speak(text){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  lookAtSpeaker();
  const c=text.replace(/\[.*?\]/g,'').trim().substring(0,300);
  const u=new SpeechSynthesisUtterance(c);
  u.rate=sett.voiceSpeed||1;u.pitch=1.1;
  window.speechSynthesis.speak(u);
}

function startEyes(){stopEyes();bT=setInterval(doBlink,3000+Math.random()*2000);eT=setInterval(doEyeMove,2500+Math.random()*1000);}
function stopEyes(){clearInterval(bT);clearInterval(eT);}
function doBlink(){['eLeft','eRight'].forEach(id=>{const e=document.getElementById(id);if(e){e.classList.add('blink');setTimeout(()=>e.classList.remove('blink'),160);}});}
function doEyeMove(){
  const x=(Math.random()-0.5)*16,y=(Math.random()-0.5)*12;
  ['pL','pR'].forEach(id=>{const p=document.getElementById(id);if(p){p.style.transform='translate(calc(-50% + '+x+'px), calc(-50% + '+y+'px))';setTimeout(()=>p.style.transform='translate(-50%,-50%)',700);}});
}
function setEmo(text){
  const t=text.toLowerCase();
  const el=document.getElementById('eL');const eyes=['eLeft','eRight'];
  let col='#00FFFF',shad='rgba(0,255,255,0.8)',emo='NEUTRAL';
  if(t.includes('happy')||t.includes('great')||t.includes('awesome')||t.includes('love')){col='#00FF88';shad='rgba(0,255,136,0.8)';emo='HAPPY';}
  else if(t.includes('sorry')||t.includes('error')||t.includes('fail')){col='#FF8800';shad='rgba(255,136,0,0.8)';emo='CONCERNED';}
  else if(t.includes('think')||t.includes('hmm')||t.includes('let me')){col='#8800FF';shad='rgba(136,0,255,0.8)';emo='THINKING';}
  else if(t.includes('alert')||t.includes('warning')||t.includes('danger')){col='#FF4444';shad='rgba(255,68,68,0.8)';emo='ALERT';}
  else if(t.includes('curious')||t.includes('interesting')){col='#FFD700';shad='rgba(255,215,0,0.8)';emo='CURIOUS';}
  eyes.forEach(id=>{const e=document.getElementById(id);if(e){e.style.background=col;e.style.boxShadow='0 0 40px '+shad;}});
  if(el)el.textContent=emo;
}
function setSub(text){const sb=document.getElementById('sub');if(sb)sb.textContent=text.replace(/\[.*?\]/g,'').trim().substring(0,150)+(text.length>150?'...':'');}

async function toggleCam(){
  const btn=document.getElementById('camB'),info=document.getElementById('camI');
  if(camOn){const v=document.getElementById('cf');v.srcObject?.getTracks().forEach(t=>t.stop());v.srcObject=null;camOn=false;btn.textContent='START CAMERA';info.textContent='CAMERA OFF';return;}
  try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});document.getElementById('cf').srcObject=s;camOn=true;btn.textContent='STOP CAMERA';info.textContent='üì∑ ACTIVE';}
  catch(e){info.textContent='ERROR: '+e.message;}
}

function saveMem(text,cat,src){
  if(!text||text.length<3)return;
  mems.unshift({id:Date.now(),text,category:cat||'general',source:src||'auto',time:new Date().toLocaleString()});
  localStorage.setItem('bm',JSON.stringify(mems));
}
function addMem(){
  const inp=document.getElementById('mInp'),cat=document.getElementById('mCat').value,txt=inp.value.trim();
  if(!txt){alert('Type something!');return;}
  saveMem(txt,cat,'manual');inp.value='';renderMems();
}
function renderMems(){
  mems=JSON.parse(localStorage.getItem('bm')||'[]');
  const l=document.getElementById('mList'),c=document.getElementById('mCount');
  if(c)c.textContent=mems.length;if(!l)return;
  if(!mems.length){l.innerHTML='<div style="color:var(--g);text-align:center;padding:20px;font-size:13px;">No memories yet!</div>';return;}
  l.innerHTML='';
  mems.forEach((m)=>{
    const d=document.createElement('div');d.className='mcard';
    d.innerHTML='<div class="mtime">'+m.time+' ¬∑ '+(m.source==='manual'?'üë§':'ü§ñ')+'</div><div class="mtext" id="mt'+m.id+'">'+m.text+'</div><span class="mtag">'+m.category+'</span><button class="medit" onclick="editMem('+m.id+')">‚úèÔ∏è</button><button class="mdel" onclick="delMem('+m.id+')">‚úï</button>';
    l.appendChild(d);
  });
}
function editMem(id){
  const el=document.getElementById('mt'+id);if(!el)return;
  const n=prompt('Edit memory:',el.textContent);
  if(n&&n.trim()){const i=mems.findIndex(m=>m.id===id);if(i>-1){mems[i].text=n.trim();mems[i].time='Edited: '+new Date().toLocaleString();}localStorage.setItem('bm',JSON.stringify(mems));renderMems();}
}
function delMem(id){mems=mems.filter(m=>m.id!==id);localStorage.setItem('bm',JSON.stringify(mems));renderMems();}
function clearMems(){if(!confirm('Clear ALL memories?'))return;mems=[];hist='';localStorage.setItem('bm','[]');renderMems();}

function tog(el,key){el.classList.toggle('on');sett[key]=el.classList.contains('on');localStorage.setItem('bs',JSON.stringify(sett));}
function saveSett(){sett.personality=document.getElementById('sP').value;sett.voiceSpeed=parseFloat(document.getElementById('sVS').value);localStorage.setItem('bs',JSON.stringify(sett));}
function loadSett(){
  sett=JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"face":true,"lookSpeak":true,"nav":false,"personality":"friendly","voiceSpeed":1}');
  [['tO','obstacle'],['tF','face'],['tLS','lookSpeak'],['tN','nav']].forEach(([id,k])=>{const e=document.getElementById(id);if(e)e.className='tog'+(sett[k]?' on':'');});
  const p=document.getElementById('sP');if(p)p.value=sett.personality||'friendly';
  const v=document.getElementById('sVS');if(v)v.value=sett.voiceSpeed||1;
}
function saveKeys(){
  keys={g:document.getElementById('kG').value.trim(),o:document.getElementById('kO').value.trim(),t:document.getElementById('kT').value.trim(),h:document.getElementById('kH').value.trim(),gh:document.getElementById('kGH').value.trim()};
  localStorage.setItem('bk',JSON.stringify(keys));
  const m=document.getElementById('kMsg');m.textContent='‚úÖ Keys saved permanently!';setTimeout(()=>m.textContent='',3000);
}
function loadKeysUI(){
  keys=JSON.parse(localStorage.getItem('bk')||'{}');
  if(keys.g)document.getElementById('kG').value=keys.g;
  if(keys.o)document.getElementById('kO').value=keys.o;
  if(keys.t)document.getElementById('kT').value=keys.t;
  if(keys.h)document.getElementById('kH').value=keys.h;
  if(keys.gh)document.getElementById('kGH').value=keys.gh;
}
keys=JSON.parse(localStorage.getItem('bk')||'{}');
sett=JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"face":true,"lookSpeak":true,"nav":false,"personality":"friendly","voiceSpeed":1}');
mems=JSON.parse(localStorage.getItem('bm')||'[]');
</script>
</body>
</html>
