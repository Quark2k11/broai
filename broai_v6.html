<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Bro AI</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
:root{--c:#00FFFF;--d:#000;--d2:#0A0A1A;--d3:#0D0D2B;--g:#888;--gr:#00FF88;--r:#FF4444;--o:#FF8800;--pur:#8800FF;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;height:-webkit-fill-available;overflow:hidden;background:#000;}
body{font-family:'Rajdhani',sans-serif;color:#fff;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;flex-direction:column;position:fixed;inset:0;z-index:1;}
.screen.active{display:flex;}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
#homeScreen{background:radial-gradient(ellipse at 50% 40%,#0D0D2B 0%,#000 70%);justify-content:center;align-items:center;gap:20px;}
.hl{font-family:'Orbitron',monospace;font-size:46px;font-weight:900;color:var(--c);letter-spacing:8px;animation:glow 2s infinite ease-in-out;}
@keyframes glow{0%,100%{text-shadow:0 0 30px rgba(0,255,255,0.8),0 0 60px rgba(0,255,255,0.3)}50%{text-shadow:0 0 60px rgba(0,255,255,1),0 0 120px rgba(0,255,255,0.5)}}
.hs{color:var(--g);font-size:12px;letter-spacing:5px;text-transform:uppercase;margin-bottom:10px;}
.hb{width:80%;max-width:300px;height:54px;border:none;border-radius:30px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all 0.2s;}
.hb.p{background:var(--c);color:#000;box-shadow:0 0 25px rgba(0,255,255,0.4);}
.hb.p:active{transform:scale(0.97);}
.hb.s{background:transparent;color:var(--c);border:2px solid var(--c);}
.hb.s:active{background:rgba(0,255,255,0.1);}
.ver{font-size:10px;color:#222;margin-top:14px;letter-spacing:3px;}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.tb{display:flex;align-items:center;padding:10px 12px;background:var(--d3);border-bottom:1px solid rgba(0,255,255,0.15);min-height:52px;gap:8px;flex-shrink:0;z-index:10;}
.tt{font-family:'Orbitron',monospace;font-size:13px;color:var(--c);font-weight:700;flex:1;}
.bb{background:none;border:none;color:var(--c);font-size:20px;cursor:pointer;padding:4px 6px;flex-shrink:0;}
.al{font-size:9px;color:var(--o);background:rgba(255,136,0,0.12);border:1px solid rgba(255,136,0,0.4);border-radius:10px;padding:2px 7px;flex-shrink:0;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ost{font-size:10px;color:var(--gr);display:flex;align-items:center;gap:4px;flex-shrink:0;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--gr);animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

/* ‚îÄ‚îÄ CHAT SCREEN ‚îÄ‚îÄ */
#chatScreen{background:#000;}
.chat-outer{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:0;overflow:hidden;background:var(--d2);border-right:1px solid rgba(0,255,255,0.1);transition:width 0.3s ease;flex-shrink:0;display:flex;flex-direction:column;}
.sidebar.open{width:240px;}
.sb-head{padding:14px 12px 10px;border-bottom:1px solid rgba(0,255,255,0.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sb-title{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:2px;}
.sb-new{background:var(--c);color:#000;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Orbitron',monospace;}
.sb-list{flex:1;overflow-y:auto;padding:8px;}
.sb-item{padding:10px 10px;border-radius:10px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;transition:all 0.15s;}
.sb-item:hover,.sb-item.active{background:rgba(0,255,255,0.08);border-color:rgba(0,255,255,0.2);}
.sb-iname{font-size:13px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sb-idate{font-size:10px;color:var(--g);margin-top:2px;}
.sb-del{float:right;background:none;border:none;color:var(--r);font-size:14px;cursor:pointer;padding:0 2px;}

/* CHAT AREA */
.chat-wrap{display:flex;flex-direction:column;flex:1;overflow:hidden;}
#cL{flex:1;overflow-y:auto;padding:12px 12px 8px;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch;}
.msg{max-width:86%;padding:11px 15px;border-radius:18px;font-size:15px;line-height:1.5;word-break:break-word;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.u{align-self:flex-end;background:var(--c);color:#000;font-weight:600;border-bottom-right-radius:4px;}
.msg.b{align-self:flex-start;background:var(--d3);color:#fff;border:1px solid rgba(0,255,255,0.15);border-bottom-left-radius:4px;}
.msg.e{align-self:flex-start;background:rgba(255,68,68,0.08);color:var(--r);border:1px solid rgba(255,68,68,0.3);border-radius:12px;font-size:13px;}
.msg.sy{align-self:center;background:rgba(0,255,255,0.04);color:var(--g);font-size:12px;border-radius:12px;text-align:center;max-width:92%;padding:8px 14px;}
.tw{padding:0 12px 4px;flex-shrink:0;display:none;}
.td{display:inline-flex;background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-radius:18px;padding:12px 16px;}
.dd{display:flex;gap:5px;}
.dd span{width:7px;height:7px;border-radius:50%;background:var(--c);animation:dot 1.2s infinite;}
.dd span:nth-child(2){animation-delay:.2s}.dd span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,100%{opacity:0.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
.ib{display:flex;align-items:center;padding:8px 10px 10px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.15);gap:8px;flex-shrink:0;}
#uI{flex:1;background:#111830;border:2px solid rgba(0,255,255,0.3);border-radius:24px;padding:11px 16px;color:#fff;font-size:16px;font-family:'Rajdhani',sans-serif;outline:none;min-width:0;}
#uI:focus{border-color:var(--c);}
#uI::placeholder{color:#444;}
.ib-btn{width:46px;height:46px;border-radius:50%;border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sb2{background:var(--c);color:#000;}
.vb{background:var(--d2);color:var(--c);border:1px solid rgba(0,255,255,0.25);}
.vb.on{background:var(--r);color:#fff;animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,68,68,0.4)}50%{box-shadow:0 0 0 8px rgba(255,68,68,0)}}

/* ‚îÄ‚îÄ BROBOT ‚îÄ‚îÄ */
#brobotScreen{background:#000;}
.mt{display:flex;background:var(--d2);border-bottom:1px solid rgba(0,255,255,0.12);overflow-x:auto;scrollbar-width:none;flex-shrink:0;}
.mt::-webkit-scrollbar{display:none;}
.tb2{flex-shrink:0;padding:10px 14px;background:none;border:none;color:var(--g);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;letter-spacing:1px;}
.tb2.a{color:var(--c);border-bottom-color:var(--c);}
.mc{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.mc.a{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ FACE MODE ‚îÄ‚îÄ */
#faceMode{background:#000;flex:1;position:relative;justify-content:center;align-items:center;}
.face-fullbtn{position:absolute;top:10px;right:10px;z-index:20;background:rgba(0,0,0,0.6);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 9px;cursor:pointer;font-size:16px;line-height:1;}
/* FULLSCREEN face overlay */
#faceOverlay{display:none;position:fixed;inset:0;z-index:999;background:#000;flex-direction:column;justify-content:center;align-items:center;}
#faceOverlay.show{display:flex;}
.fov-exit{position:absolute;top:14px;right:14px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 9px;cursor:pointer;font-size:16px;line-height:1;z-index:10;}
.fo-emo{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:5px;opacity:0.6;margin-bottom:20px;}
.fo-eyes{display:flex;gap:44px;justify-content:center;align-items:center;}
.fo-eye{width:110px;height:110px;background:var(--c);border-radius:50%;position:relative;box-shadow:0 0 50px rgba(0,255,255,0.9);overflow:hidden;transition:all 0.2s;}
.fo-eye.blink{height:8px!important;border-radius:4px!important;}
.fo-pu{position:absolute;width:44px;height:44px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:all 0.3s;}
.fo-sh{position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
/* subtitle: 45px below eyes, width = both eyes + gap */
.fo-sub-wrap{margin-top:45px;width:264px;/* 110+44+110 */text-align:center;}
.fo-sub{font-size:15px;color:#fff;line-height:1.5;min-height:24px;word-break:break-word;}

/* NORMAL FACE */
.face-inner{display:flex;flex-direction:column;justify-content:center;align-items:center;flex:1;width:100%;}
.ew{display:flex;gap:44px;justify-content:center;align-items:center;}
.eye{width:100px;height:100px;background:var(--c);border-radius:50%;position:relative;box-shadow:0 0 40px rgba(0,255,255,0.8);transition:all 0.2s;overflow:hidden;}
.eye.blink{height:8px!important;border-radius:4px!important;}
.pu{position:absolute;width:40px;height:40px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:all 0.3s;}
.sh{position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.el{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;margin-bottom:16px;}
/* subtitle 45px below eyes, width of both eyes (100+44+100=244) */
.sub-wrap{margin-top:45px;width:244px;text-align:center;}
.sub{font-size:14px;color:#ddd;line-height:1.5;min-height:22px;word-break:break-word;}

/* CONTROL */
.st{font-family:'Orbitron',monospace;font-size:10px;color:var(--c);letter-spacing:3px;opacity:0.7;margin-bottom:8px;}
.dp{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:210px;margin:0 auto;}
.db{height:56px;border-radius:12px;border:1px solid rgba(0,255,255,0.3);background:var(--d3);color:var(--c);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.db:active{background:rgba(0,255,255,0.2);}
.de{background:none!important;border:none!important;}
.stopb{background:rgba(255,68,68,0.12)!important;border-color:var(--r)!important;color:var(--r)!important;font-size:11px!important;font-weight:700;font-family:'Orbitron',monospace;letter-spacing:1px;}
.sl{width:100%;-webkit-appearance:none;height:5px;border-radius:3px;background:#1a1a3a;outline:none;}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--c);cursor:pointer;}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sc{background:var(--d3);border:1px solid rgba(0,255,255,0.12);border-radius:12px;padding:10px;}
.sla{font-size:10px;color:var(--g);margin-bottom:3px;}
.sv{font-family:'Orbitron',monospace;font-size:15px;color:var(--c);}
.wi{width:100%;background:var(--d3);border:1px solid rgba(0,255,255,0.25);border-radius:10px;padding:10px 14px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;margin-bottom:8px;}
.ab{width:100%;height:44px;background:var(--c);color:#000;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:4px;}
.ab.red{background:rgba(255,68,68,0.12);color:var(--r);border:1px solid rgba(255,68,68,0.4);}
.ab.gray{background:#111;color:var(--g);border:1px solid #333;}

/* MEMORY */
.madd{background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;}
.mi{background:var(--d2);border:1px solid rgba(0,255,255,0.2);border-radius:8px;padding:10px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;outline:none;resize:none;width:100%;height:60px;}
.mcard{background:var(--d3);border:1px solid rgba(0,255,255,0.08);border-radius:12px;padding:12px;position:relative;margin-bottom:8px;}
.mtime{font-size:10px;color:var(--g);margin-bottom:4px;}
.mtext{font-size:14px;color:#fff;line-height:1.4;padding-right:60px;}
.mtag{display:inline-block;font-size:10px;color:var(--o);background:rgba(255,136,0,0.08);border:1px solid rgba(255,136,0,0.4);border-radius:8px;padding:1px 7px;margin-top:4px;}
.mdel{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;}
.medit{position:absolute;top:10px;right:32px;background:none;border:none;color:var(--c);font-size:13px;cursor:pointer;}

/* SETTINGS */
.sr{display:flex;align-items:center;justify-content:space-between;background:var(--d3);border:1px solid rgba(0,255,255,0.08);border-radius:12px;padding:12px 14px;margin-bottom:6px;}
.slb{font-size:15px;font-weight:600;}
.sdb{font-size:11px;color:var(--g);margin-top:2px;}
.tog{width:46px;height:24px;background:var(--d2);border-radius:12px;border:1px solid rgba(0,255,255,0.25);position:relative;cursor:pointer;transition:all 0.3s;flex-shrink:0;}
.tog.on{background:var(--c);border-color:var(--c);}
.tog::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all 0.3s;}
.tog.on::after{left:24px;}
.sel{background:var(--d2);border:1px solid rgba(0,255,255,0.25);color:var(--c);border-radius:8px;padding:6px 10px;font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;}
.mrow{display:flex;justify-content:space-between;align-items:center;background:var(--d3);border-radius:8px;padding:8px 12px;margin-bottom:4px;font-size:12px;gap:8px;}
.mname{color:#ddd;flex:1;font-size:12px;}
.mbadge{font-size:10px;padding:2px 8px;border-radius:8px;font-family:'Orbitron',monospace;white-space:nowrap;}
.mbadge.ok{background:rgba(0,255,136,0.1);color:var(--gr);border:1px solid rgba(0,255,136,0.3);}
.mbadge.skip{background:rgba(255,68,68,0.1);color:var(--r);border:1px solid rgba(255,68,68,0.3);}
.mbadge.nokey{background:rgba(80,80,80,0.15);color:#555;border:1px solid #333;}

/* FACE RECOGNITION */
.face-card{background:var(--d3);border:1px solid rgba(0,255,255,0.1);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;}
.face-avatar{width:44px;height:44px;border-radius:50%;background:#1a1a3a;border:2px solid var(--c);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.face-info{flex:1;}
.face-name{font-size:15px;font-weight:600;color:#fff;}
.face-sub{font-size:11px;color:var(--g);}
.face-del{background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;}

/* cam overlay */
#camMode{background:#000;position:relative;flex:1;}
#cf{width:100%;height:100%;object-fit:cover;}
.cam-ui{position:absolute;inset:0;pointer-events:none;}
.cam-status{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,255,0.3);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--c);font-family:'Orbitron',monospace;}
.cam-name{position:absolute;top:50%;left:50%;transform:translate(-50%,-80px);background:rgba(0,0,0,0.8);border:1px solid var(--gr);border-radius:8px;padding:6px 14px;font-size:14px;color:var(--gr);display:none;}
.cbtn{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:var(--c);color:#000;border:none;border-radius:24px;padding:12px 28px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;cursor:pointer;pointer-events:all;}

::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:#050510}::-webkit-scrollbar-thumb{background:rgba(0,255,255,0.25);border-radius:2px}
</style>
</head>
<body>

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div id="homeScreen" class="screen active">
  <div class="hl">Bro AI</div>
  <div class="hs">Your AI Companion ¬∑ Robot Brain</div>
  <button class="hb p" onclick="go('chatScreen')">üí¨ &nbsp;Bro AI Chat</button>
  <button class="hb s" onclick="go('brobotScreen')">ü§ñ &nbsp;Bro Bot Control</button>
  <div class="ver">v6.0 ¬∑ HEY BRO ¬∑ 20 MODEL FALLBACK</div>
</div>

<!-- ‚ïê‚ïê CHAT SCREEN ‚ïê‚ïê -->
<div id="chatScreen" class="screen">
  <div class="tb">
    <button class="bb" id="sideBtn" onclick="toggleSidebar()">‚ò∞</button>
    <button class="bb" onclick="go('homeScreen')" style="font-size:16px;">‚Üê</button>
    <div class="tt">Bro AI</div>
    <div class="al" id="aiL">READY</div>
    <div class="ost"><div class="dot"></div>Online</div>
  </div>
  <div class="chat-outer">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sb-head">
        <div class="sb-title">HISTORY</div>
        <button class="sb-new" onclick="newChat()">+ NEW</button>
      </div>
      <div class="sb-list" id="sbList"></div>
    </div>
    <!-- Chat -->
    <div class="chat-wrap">
      <div id="cL">
        <div class="msg sy">Bro AI v6 ready! ü§ñ<br>Say <b style="color:var(--c)">"Hey Bro"</b> to activate voice!<br>20 model fallback ‚Äî unlimited responses!</div>
      </div>
      <div class="tw" id="tW"><div class="td"><div class="dd"><span></span><span></span><span></span></div></div></div>
      <div class="ib">
        <button class="ib-btn vb" id="vBtn" onclick="toggleVoice()">üé§</button>
        <input type="text" id="uI" placeholder="Ask Bro AI... or say Hey Bro!" onkeypress="onK(event)" autocomplete="off">
        <button class="ib-btn sb2" onclick="sendMsg()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê BROBOT SCREEN ‚ïê‚ïê -->
<div id="brobotScreen" class="screen">
  <div class="tb">
    <button class="bb" onclick="go('homeScreen')">‚Üê</button>
    <div class="tt">Bro Bot</div>
    <div class="ost" id="rSt"><div class="dot" style="background:var(--r)"></div>Disconnected</div>
  </div>
  <div class="mt">
    <button class="tb2 a" onclick="tab('faceMode',this)">üëÅ FACE</button>
    <button class="tb2" onclick="tab('controlMode',this)">üïπ CONTROL</button>
    <button class="tb2" onclick="tab('camMode',this)">üì∑ CAMERA</button>
    <button class="tb2" onclick="tab('memoryMode',this)">üß† MEMORY</button>
    <button class="tb2" onclick="tab('facesMode',this)">üë§ FACES</button>
    <button class="tb2" onclick="tab('settingsMode',this)">‚öôÔ∏è SETTINGS</button>
  </div>

  <!-- FACE TAB -->
  <div id="faceMode" class="mc a" style="background:#000;flex:1;position:relative;justify-content:center;align-items:center;">
    <button class="face-fullbtn" onclick="openFullFace()" title="Fullscreen">‚õ∂</button>
    <div class="face-inner">
      <div class="el" id="eL">NEUTRAL</div>
      <div class="ew">
        <div class="eye" id="eLeft"><div class="pu" id="pL"></div><div class="sh"></div></div>
        <div class="eye" id="eRight"><div class="pu" id="pR"></div><div class="sh"></div></div>
      </div>
      <div class="sub-wrap">
        <div class="sub" id="sub">Hello! I am Bro Bot. How can I help you?</div>
      </div>
    </div>
  </div>

  <!-- CONTROL TAB -->
  <div id="controlMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:14px;">
      <div><div class="st">MOVEMENT</div>
        <div class="dp">
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('forward')" onpointerup="cmd('stop')">‚ñ≤</button>
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('left')" onpointerup="cmd('stop')">‚óÑ</button>
          <button class="db stopb" onclick="cmd('stop')">STOP</button>
          <button class="db" onpointerdown="cmd('right')" onpointerup="cmd('stop')">‚ñ∫</button>
          <div class="db de"></div>
          <button class="db" onpointerdown="cmd('backward')" onpointerup="cmd('stop')">‚ñº</button>
          <div class="db de"></div>
        </div>
      </div>
      <div><div class="st">HEAD ROTATE: <span id="hV">90</span>¬∞</div><input type="range" class="sl" min="0" max="180" value="90" oninput="moveHead(this.value)"></div>
      <div><div class="st">HEAD TILT: <span id="tV">90</span>¬∞</div><input type="range" class="sl" min="30" max="150" value="90" oninput="moveTilt(this.value)"></div>
      <div><div class="st">SPEED: <span id="spV">50</span>%</div><input type="range" class="sl" min="10" max="100" value="50" oninput="updSp(this.value)"></div>
      <div><div class="st">SENSORS</div>
        <div class="sg">
          <div class="sc"><div class="sla">ULTRASONIC</div><div class="sv" id="us">--</div><div style="font-size:10px;color:var(--g)">cm</div></div>
          <div class="sc"><div class="sla">BATTERY</div><div class="sv" id="bat">--</div><div style="font-size:10px;color:var(--g)">%</div></div>
          <div class="sc"><div class="sla">IR FRONT-L</div><div class="sv" id="i1" style="font-size:12px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR FRONT-R</div><div class="sv" id="i2" style="font-size:12px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR REAR-L</div><div class="sv" id="i3" style="font-size:12px">CLEAR</div></div>
          <div class="sc"><div class="sla">IR REAR-R</div><div class="sv" id="i4" style="font-size:12px">CLEAR</div></div>
        </div>
      </div>
      <div><div class="st">ESP32 CONNECTION</div>
        <input type="text" class="wi" id="eIP" placeholder="ESP32 IP e.g. 192.168.1.100">
        <button class="ab" onclick="connectESP()">CONNECT TO BRO BOT</button>
        <div id="cMsg" style="text-align:center;font-size:12px;color:var(--g);margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <!-- CAMERA TAB -->
  <div id="camMode" class="mc" style="position:relative;background:#000;flex:1;">
    <video id="cf" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;display:block;"></video>
    <div class="cam-ui">
      <div class="cam-status" id="camI">CAMERA OFF</div>
      <div class="cam-name" id="camName"></div>
    </div>
    <button class="cbtn" id="camB" onclick="toggleCam()">START CAMERA</button>
  </div>

  <!-- MEMORY TAB -->
  <div id="memoryMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:10px;">
      <div class="st">ADD MEMORY</div>
      <div class="madd">
        <textarea class="mi" id="mInp" placeholder="Type memory... or say 'save this [info]' in chat!"></textarea>
        <div style="display:flex;gap:8px;">
          <select class="sel" id="mCat" style="flex:1;">
            <option value="general">General</option>
            <option value="preference">My Preference</option>
            <option value="fact">Important Fact</option>
            <option value="task">Task/Goal</option>
            <option value="person">Person Info</option>
          </select>
          <button class="ab" style="flex:1;margin:0;" onclick="addMem()">SAVE</button>
        </div>
      </div>
      <div class="st">ALL MEMORIES (<span id="mCount">0</span>)</div>
      <div id="mList"></div>
      <button class="ab red" onclick="clearMems()">üóë CLEAR ALL</button>
    </div>
  </div>

  <!-- FACES TAB -->
  <div id="facesMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:10px;">
      <div class="st">FACE RECOGNITION</div>
      <div style="font-size:12px;color:var(--g);margin-bottom:4px;">Save faces so Bro Bot recognizes and greets everyone by name!</div>
      <div style="display:flex;gap:8px;margin-bottom:4px;">
        <input type="text" class="wi" id="faceNameInp" placeholder="Person's name..." style="margin:0;flex:1;">
        <button class="ab" style="width:auto;padding:0 16px;margin:0;" onclick="captureFace()">üì∏ CAPTURE</button>
      </div>
      <div style="font-size:11px;color:var(--o);margin-bottom:6px;">‚ö†Ô∏è Open Camera tab first, aim at person's face, then come here to capture!</div>
      <div class="st">SAVED FACES (<span id="faceCount">0</span>)</div>
      <div id="faceList"></div>
      <div style="background:rgba(0,255,255,0.04);border:1px solid rgba(0,255,255,0.15);border-radius:10px;padding:12px;font-size:12px;color:var(--g);line-height:1.6;">
        <b style="color:var(--c)">How face recognition works:</b><br>
        1. Start camera in Camera tab<br>
        2. Aim at person's face<br>
        3. Come here, type their name & tap Capture<br>
        4. Bro Bot will greet them by name when it sees them!<br>
        5. It speaks differently for each person based on memory
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="settingsMode" class="mc">
    <div style="padding:14px;display:flex;flex-direction:column;gap:6px;">
      <div class="st">API KEYS ‚Äî FREE ONLY</div>
      <input type="password" class="wi" id="kG" placeholder="Gemini Key (AIzaSy...) ‚Äî Google AI Studio FREE">
      <input type="password" class="wi" id="kGH" placeholder="GitHub AI Key ‚Äî FREE with GitHub account">
      <button class="ab" onclick="saveKeys()">üíæ SAVE KEYS</button>
      <div id="kMsg" style="text-align:center;font-size:12px;color:var(--gr);margin-bottom:4px;"></div>
      <div class="st" style="margin-top:4px;">MODEL QUEUE ‚Äî SMART FALLBACK</div>
      <div style="font-size:11px;color:var(--g);margin-bottom:6px;">Always picks best available model. Skips quota-hit ones automatically!</div>
      <div id="modelList"></div>
      <button class="ab gray" onclick="resetSkip()">üîÑ RESET QUOTA SKIPS</button>
      <div class="st" style="margin-top:8px;">BRO BOT SETTINGS</div>
      <div class="sr"><div><div class="slb">Auto Obstacle Avoid</div><div class="sdb">Stop when blocked</div></div><div class="tog on" id="tO" onclick="tog(this,'obstacle')"></div></div>
      <div class="sr"><div><div class="slb">Look At Speaker</div><div class="sdb">Head turns when Bro AI speaks</div></div><div class="tog on" id="tLS" onclick="tog(this,'lookSpeak')"></div></div>
      <div class="sr"><div><div class="slb">Face Recognition Active</div><div class="sdb">Recognize & greet by name</div></div><div class="tog on" id="tFR" onclick="tog(this,'faceRecog')"></div></div>
      <div class="sr"><div><div class="slb">Hey Bro Wake Word</div><div class="sdb">Say "Hey Bro" to activate</div></div><div class="tog on" id="tHB" onclick="tog(this,'heyBro')"></div></div>
      <div class="sr"><div><div class="slb">Auto Navigation</div><div class="sdb">Bro Bot moves autonomously</div></div><div class="tog" id="tN" onclick="tog(this,'nav')"></div></div>
      <div class="sr"><div><div class="slb">Personality</div></div>
        <select class="sel" id="sP" onchange="saveSett()">
          <option value="friendly">Friendly</option>
          <option value="funny">Funny Bro</option>
          <option value="professional">Professional</option>
          <option value="serious">Serious</option>
        </select>
      </div>
      <div class="sr"><div><div class="slb">Voice Speed</div></div>
        <input type="range" min="0.5" max="2" step="0.1" value="0.9" id="sVS" style="width:100px;" oninput="saveSett()">
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê FULLSCREEN FACE OVERLAY ‚ïê‚ïê -->
<div id="faceOverlay">
  <button class="fov-exit" onclick="closeFullFace()">‚õ∂</button>
  <div class="fo-emo" id="foEmo">NEUTRAL</div>
  <div class="fo-eyes">
    <div class="fo-eye" id="foLeft"><div class="fo-pu" id="foPL"></div><div class="fo-sh"></div></div>
    <div class="fo-eye" id="foRight"><div class="fo-pu" id="foPR"></div><div class="fo-sh"></div></div>
  </div>
  <div class="fo-sub-wrap">
    <div class="fo-sub" id="foSub">Hello! I am Bro Bot.</div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODEL QUEUE ‚Äî all Gemini + GitHub free models
// Smart: picks BEST available (not quota-hit, has key)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODELS = [
  {name:'Gemini 2.5 Flash',     p:'gemini', m:'gemini-2.5-flash-preview-04-17',    k:'g', tier:10},
  {name:'Gemini 2.5 Pro',       p:'gemini', m:'gemini-2.5-pro-preview-05-06',      k:'g', tier:10},
  {name:'Gemini 2.5 Flash Lite',p:'gemini', m:'gemini-2.5-flash-lite-preview-06-17',k:'g',tier:9},
  {name:'Gemini 2.0 Flash',     p:'gemini', m:'gemini-2.0-flash',                  k:'g', tier:9},
  {name:'Gemini 2.0 Flash Exp', p:'gemini', m:'gemini-2.0-flash-exp',              k:'g', tier:8},
  {name:'Gemini 2.0 Flash Lite',p:'gemini', m:'gemini-2.0-flash-lite',             k:'g', tier:8},
  {name:'Gemini 2.0 Pro Exp',   p:'gemini', m:'gemini-2.0-pro-exp',               k:'g', tier:9},
  {name:'Gemini 3 Flash',       p:'gemini', m:'gemini-3-flash',                    k:'g', tier:9},
  {name:'Gemini 1.5 Pro',       p:'gemini', m:'gemini-1.5-pro',                    k:'g', tier:7},
  {name:'Gemini 1.5 Flash',     p:'gemini', m:'gemini-1.5-flash',                  k:'g', tier:7},
  {name:'Gemini 1.5 Flash-8B',  p:'gemini', m:'gemini-1.5-flash-8b',              k:'g', tier:6},
  {name:'Gemma 3 27B',          p:'gemini', m:'gemma-3-27b-it',                    k:'g', tier:5},
  {name:'Gemma 3 12B',          p:'gemini', m:'gemma-3-12b-it',                    k:'g', tier:4},
  {name:'Gemma 3 4B',           p:'gemini', m:'gemma-3-4b-it',                     k:'g', tier:3},
  {name:'Gemma 3 2B',           p:'gemini', m:'gemma-3-2b-it',                     k:'g', tier:2},
  {name:'Gemma 3 1B',           p:'gemini', m:'gemma-3-1b-it',                     k:'g', tier:1},
  {name:'GPT-4o Mini',          p:'github', m:'gpt-4o-mini',                       k:'gh',tier:8},
  {name:'GPT-4o',               p:'github', m:'gpt-4o',                            k:'gh',tier:9},
  {name:'Llama 3.3 70B',        p:'github', m:'meta-llama-3.3-70b-instruct',       k:'gh',tier:7},
  {name:'Mistral Large',        p:'github', m:'mistral-large-2411',                k:'gh',tier:6},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let keys  = JSON.parse(localStorage.getItem('bk')  ||'{}');
let sett  = JSON.parse(localStorage.getItem('bs')  ||'{"obstacle":true,"lookSpeak":true,"nav":false,"faceRecog":true,"heyBro":true,"personality":"friendly","voiceSpeed":0.9}');
let mems  = JSON.parse(localStorage.getItem('bm')  ||'[]');
let skip  = JSON.parse(localStorage.getItem('bsk') ||'{}');
let faces = JSON.parse(localStorage.getItem('bfaces')||'[]');
let chats = JSON.parse(localStorage.getItem('bchats')||'[]');
let curChatId = null;
let eIP   = localStorage.getItem('bi')||'';
let rOK=false, camOn=false, sp=50, hist='', msgCount=0;
let bT,eT,sT,rec,vActive=false,wakeRec,wakeOn=false;

// auto-reset skips every 24h
(()=>{const t=+localStorage.getItem('bskt')||0;if(Date.now()-t>86400000){skip={};localStorage.setItem('bsk','{}');localStorage.setItem('bskt',''+Date.now());}})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SMART MODEL SELECTION
// picks highest tier model that's ready
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getBestModel(){
  const available = MODELS.filter(m => keys[m.k] && !skip[m.name]);
  if(!available.length) return null;
  return available.sort((a,b)=>b.tier-a.tier)[0];
}

async function callAI(msg){
  const pers  = sett.personality||'friendly';
  const mc    = mems.slice(0,6).map(m=>'['+m.category+']: '+m.text).join('; ');
  const faceCtx = faces.length ? 'Known people: '+faces.map(f=>f.name).join(', ')+'. ' : '';
  const sys   = `You are Bro AI, a ${pers} AI robot companion. ${faceCtx}Robot: 4 wheels, 4 IR sensors, ultrasonic on servo, phone head on tilt servo. Robot commands in brackets: [MOVE_FORWARD] [MOVE_BACKWARD] [TURN_LEFT] [TURN_RIGHT] [STOP] [HEAD_LEFT] [HEAD_RIGHT] [HEAD_CENTER] [TILT_UP] [TILT_DOWN]. Be helpful and concise. Never say emoji out loud. Memories: ${mc}. Context: ${hist.slice(-400)}`;

  // try best model first, then fall down
  const sorted = MODELS.filter(m=>keys[m.k]&&!skip[m.name]).sort((a,b)=>b.tier-a.tier);
  if(!sorted.length){
    showTy(false);
    addMsg('No models available! Enter API keys in Bro Bot ‚Üí Settings.','e');
    return;
  }

  for(const model of sorted){
    document.getElementById('aiL').textContent = model.name;
    const ok = await tryModel(model, msg, sys);
    if(ok) return;
  }
  showTy(false);
  addMsg('All models quota hit! Tap Settings ‚Üí Reset Quota Skips, or wait 24hrs.','e');
  document.getElementById('aiL').textContent='NO MODEL';
}

async function tryModel(model, msg, sys){
  try{
    let url, body, hdr={'Content-Type':'application/json'};
    if(model.p==='gemini'){
      url='https://generativelanguage.googleapis.com/v1beta/models/'+model.m+':generateContent?key='+keys[model.k];
      body=JSON.stringify({contents:[{parts:[{text:sys+'\nUser: '+msg}]}]});
    } else {
      url='https://models.inference.ai.azure.com/chat/completions';
      hdr['Authorization']='Bearer '+keys[model.k];
      body=JSON.stringify({model:model.m,messages:[{role:'system',content:sys},{role:'user',content:msg}],max_tokens:500});
    }
    const r=await fetch(url,{method:'POST',headers:hdr,body,signal:AbortSignal.timeout(12000)});
    if(r.status===429||r.status===503||r.status===402||r.status===400){
      skip[model.name]=true; localStorage.setItem('bsk',JSON.stringify(skip)); return false;
    }
    if(!r.ok) return false;
    const d=await r.json();
    let text = model.p==='gemini'
      ? d.candidates?.[0]?.content?.parts?.[0]?.text
      : d.choices?.[0]?.message?.content;
    if(!text||text.trim().length<2) return false;
    // clean emojis for TTS
    showTy(false);
    hist+='U:'+msg+' B:'+text+' ';
    msgCount++;
    addMsg(text,'b');
    saveChatMsg('user', msg);
    saveChatMsg('bot', text);
    if(msgCount===2) autoNameChat();
    return true;
  }catch(e){return false;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newChat(){
  saveCurChat();
  curChatId = Date.now();
  hist=''; msgCount=0;
  document.getElementById('cL').innerHTML='<div class="msg sy">New conversation started! Say "Hey Bro" or type anything!</div>';
  document.getElementById('aiL').textContent='READY';
  renderSidebar();
  // close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
}

function saveCurChat(){
  if(!curChatId) return;
  const existing = chats.find(c=>c.id===curChatId);
  if(!existing) return;
  localStorage.setItem('bchats', JSON.stringify(chats));
}

function saveChatMsg(role, text){
  if(!curChatId){
    curChatId=Date.now();
    chats.unshift({id:curChatId, name:'New Chat', msgs:[], time:new Date().toLocaleDateString()});
  }
  const chat=chats.find(c=>c.id===curChatId);
  if(chat) chat.msgs.push({role,text,t:Date.now()});
  localStorage.setItem('bchats',JSON.stringify(chats));
}

async function autoNameChat(){
  if(!curChatId) return;
  const chat=chats.find(c=>c.id===curChatId);
  if(!chat||chat.name!=='New Chat') return;
  // get first user msg to make a name
  const firstUser=chat.msgs.find(m=>m.role==='user');
  if(!firstUser) return;
  const name=firstUser.text.substring(0,30)+(firstUser.text.length>30?'...':'');
  chat.name=name;
  localStorage.setItem('bchats',JSON.stringify(chats));
  renderSidebar();
}

function loadChat(id){
  saveCurChat();
  const chat=chats.find(c=>c.id===id);
  if(!chat) return;
  curChatId=id; hist=''; msgCount=chat.msgs.length;
  const l=document.getElementById('cL'); l.innerHTML='';
  chat.msgs.forEach(m=>{
    const d=document.createElement('div');
    d.className='msg '+(m.role==='user'?'u':'b');
    d.textContent=m.text; l.appendChild(d);
    if(m.role==='bot') hist+='B:'+m.text+' ';
    else hist+='U:'+m.text+' ';
  });
  setTimeout(()=>l.scrollTop=l.scrollHeight,50);
  document.getElementById('sidebar').classList.remove('open');
  renderSidebar();
}

function deleteChat(id,e){
  e.stopPropagation();
  if(!confirm('Delete this chat?')) return;
  chats=chats.filter(c=>c.id!==id);
  if(curChatId===id){curChatId=null;hist='';msgCount=0;document.getElementById('cL').innerHTML='<div class="msg sy">Chat deleted. Start a new conversation!</div>';}
  localStorage.setItem('bchats',JSON.stringify(chats));
  renderSidebar();
}

function renderSidebar(){
  chats=JSON.parse(localStorage.getItem('bchats')||'[]');
  const l=document.getElementById('sbList'); if(!l) return;
  if(!chats.length){l.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:20px;">No history yet!<br>Start chatting!</div>';return;}
  l.innerHTML='';
  chats.forEach(c=>{
    const d=document.createElement('div');
    d.className='sb-item'+(c.id===curChatId?' active':'');
    d.onclick=()=>loadChat(c.id);
    d.innerHTML='<button class="sb-del" onclick="deleteChat('+c.id+',event)">‚úï</button><div class="sb-iname">'+escHtml(c.name)+'</div><div class="sb-idate">'+c.time+'</div>';
    l.appendChild(d);
  });
}

function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE ‚Äî HEY BRO wake word
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startWakeWord(){
  if(!sett.heyBro) return;
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)) return;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  wakeRec=new SR(); wakeRec.continuous=true; wakeRec.interimResults=true; wakeRec.lang='en-US';
  wakeRec.onresult=(e)=>{
    let t='';
    for(let i=e.resultIndex;i<e.results.length;i++) t+=e.results[i][0].transcript.toLowerCase();
    if(t.includes('hey bro')){
      // activate!
      speak('Yes?');
      setSub('Yes?');
      setFoSub('Yes?');
      wakeRec.stop();
      setTimeout(()=>toggleVoice(),800); // start listening for command
    }
  };
  wakeRec.onend=()=>{if(sett.heyBro&&!vActive) setTimeout(startWakeWord,1000);}; // restart
  try{wakeRec.start(); wakeOn=true;}catch(e){}
}

function stopWakeWord(){wakeRec?.stop(); wakeOn=false;}

let vActive2=false;
function toggleVoice(){
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){alert('Use Chrome for voice!');return;}
  if(vActive2){rec?.stop();return;}
  stopWakeWord();
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  rec=new SR(); rec.lang='en-US'; rec.continuous=false; rec.interimResults=false;
  rec.onstart=()=>{vActive2=true;document.getElementById('vBtn').classList.add('on');document.getElementById('vBtn').textContent='‚èπ';};
  rec.onresult=(e)=>{const t=e.results[0][0].transcript;document.getElementById('uI').value=t;sendMsg();};
  rec.onend=()=>{
    vActive2=false;
    document.getElementById('vBtn').classList.remove('on');
    document.getElementById('vBtn').textContent='üé§';
    if(sett.heyBro) setTimeout(startWakeWord,500);
  };
  try{rec.start();}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPEECH ‚Äî Jarvis-like male voice, no emoji
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanForTTS(text){
  // remove emoji
  text = text.replace(/[\u{1F000}-\u{1FFFF}]|[\u{2600}-\u{27FF}]|[\u{2300}-\u{23FF}]|[\u{1F300}-\u{1F9FF}]/gu,'');
  // fix "broai" ‚Üí "Bro AI", "brobot" ‚Üí "Bro Bot"
  text = text.replace(/broai/gi,'Bro AI');
  text = text.replace(/brobot/gi,'Bro Bot');
  // remove brackets
  text = text.replace(/\[.*?\]/g,'');
  return text.trim().substring(0,400);
}

function getJarvisVoice(){
  const voices=window.speechSynthesis.getVoices();
  // prefer deep male English voices
  const preferred=['Google UK English Male','Microsoft David','Daniel','Alex','Fred','Microsoft Mark'];
  for(const name of preferred){
    const v=voices.find(v=>v.name.includes(name));
    if(v) return v;
  }
  // fallback: any male English
  const male=voices.find(v=>v.lang.startsWith('en')&&(v.name.toLowerCase().includes('male')||v.name.toLowerCase().includes('david')||v.name.toLowerCase().includes('mark')));
  if(male) return male;
  // fallback: any English
  return voices.find(v=>v.lang.startsWith('en'))||voices[0];
}

function speak(text){
  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  lookAtSpeaker();
  const c=cleanForTTS(text);
  if(!c) return;
  const u=new SpeechSynthesisUtterance(c);
  u.rate=sett.voiceSpeed||0.9;
  u.pitch=0.85; // lower = more Jarvis-like
  u.volume=1;
  // wait for voices to load
  const setVoice=()=>{u.voice=getJarvisVoice();};
  if(speechSynthesis.getVoices().length) setVoice();
  else speechSynthesis.onvoiceschanged=setVoice;
  window.speechSynthesis.speak(u);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FULLSCREEN FACE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openFullFace(){document.getElementById('faceOverlay').classList.add('show');}
function closeFullFace(){document.getElementById('faceOverlay').classList.remove('show');}

// sync overlay eyes with main eyes
function syncOverlayEyes(col, shad, emo){
  ['foLeft','foRight'].forEach(id=>{
    const e=document.getElementById(id);
    if(e){e.style.background=col;e.style.boxShadow='0 0 50px '+shad;}
  });
  const el=document.getElementById('foEmo'); if(el) el.textContent=emo;
}

function setFoSub(text){
  const s=document.getElementById('foSub');
  if(s) s.textContent=cleanForTTS(text).substring(0,120)+(text.length>120?'...':'');
}

function blinkOverlay(){
  ['foLeft','foRight'].forEach(id=>{
    const e=document.getElementById(id);
    if(e){e.classList.add('blink');setTimeout(()=>e.classList.remove('blink'),160);}
  });
}

function moveOverlayPupils(x,y){
  ['foPL','foPR'].forEach(id=>{
    const p=document.getElementById(id);
    if(p){p.style.transform='translate(calc(-50% + '+x+'px), calc(-50% + '+y+'px))';setTimeout(()=>p.style.transform='translate(-50%,-50%)',700);}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI CORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function go(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='brobotScreen'){startEyes();renderMems();loadSett();loadKeysUI();renderModels();renderFaceList();if(eIP)document.getElementById('eIP').value=eIP;}
  else{stopEyes();}
  if(id==='chatScreen'){renderSidebar();if(sett.heyBro&&!wakeOn) startWakeWord();}
}

function tab(id,btn){
  document.querySelectorAll('.mc').forEach(m=>m.classList.remove('a'));
  document.querySelectorAll('.tb2').forEach(b=>b.classList.remove('a'));
  document.getElementById(id).classList.add('a'); btn.classList.add('a');
  if(id==='settingsMode') renderModels();
  if(id==='facesMode') renderFaceList();
}

function onK(e){if(e.key==='Enter'){e.preventDefault();sendMsg();}}

function sendMsg(){
  const inp=document.getElementById('uI');
  const txt=inp.value.trim(); if(!txt) return;
  inp.value='';
  addMsg(txt,'u');
  saveChatMsg('user',txt);
  if(memCmd(txt)) return;
  showTy(true); callAI(txt);
}

function memCmd(txt){
  const t=txt.toLowerCase();
  if(t.includes('save this')||t.includes('remember this')||t.includes('save memory')){
    const c=txt.replace(/save this|remember this|save memory/gi,'').trim();
    if(c){saveMem(c,'preference','manual');addMsg('Memory saved: "'+c.substring(0,60)+'"','b');speak('Memory saved!');return true;}
  }
  if(t.includes('what do you remember')||t.includes('show memories')){
    const r=mems.slice(0,5).map(m=>m.text).join(', ');
    addMsg(r?'I remember: '+r:'No memories saved yet!','b');return true;
  }
  return false;
}

function addMsg(text,type){
  const l=document.getElementById('cL');
  const d=document.createElement('div');
  d.className='msg '+type; d.textContent=text; l.appendChild(d);
  setTimeout(()=>l.scrollTop=l.scrollHeight,50);
  if(type==='b'){
    speak(text); setEmo(text); checkCmds(text);
    const cleaned=cleanForTTS(text);
    setSub(cleaned); setFoSub(cleaned);
    saveMem(text.substring(0,200),'general','auto');
  }
}

function showTy(s){
  document.getElementById('tW').style.display=s?'block':'none';
  if(s) setTimeout(()=>{const l=document.getElementById('cL');l.scrollTop=l.scrollHeight;},50);
}

window.addEventListener('resize',()=>{
  if(document.activeElement===document.getElementById('uI'))
    setTimeout(()=>{const l=document.getElementById('cL');if(l)l.scrollTop=l.scrollHeight;},100);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EYES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startEyes(){
  stopEyes();
  bT=setInterval(()=>{
    doBlink();
    if(document.getElementById('faceOverlay').classList.contains('show')) blinkOverlay();
  }, 3000+Math.random()*2000);
  eT=setInterval(()=>{
    const x=(Math.random()-0.5)*16, y=(Math.random()-0.5)*12;
    ['pL','pR'].forEach(id=>{const p=document.getElementById(id);if(p){p.style.transform='translate(calc(-50% + '+x+'px), calc(-50% + '+y+'px))';setTimeout(()=>p.style.transform='translate(-50%,-50%)',700);}});
    moveOverlayPupils(x,y);
  }, 2500+Math.random()*1000);
}
function stopEyes(){clearInterval(bT);clearInterval(eT);}
function doBlink(){['eLeft','eRight'].forEach(id=>{const e=document.getElementById(id);if(e){e.classList.add('blink');setTimeout(()=>e.classList.remove('blink'),160);}});}

function setEmo(text){
  const t=text.toLowerCase(); const eyes=['eLeft','eRight'];
  const el=document.getElementById('eL');
  let col='#00FFFF',shad='rgba(0,255,255,0.8)',emo='NEUTRAL';
  if(t.includes('happy')||t.includes('great')||t.includes('awesome')||t.includes('love')){col='#00FF88';shad='rgba(0,255,136,0.8)';emo='HAPPY';}
  else if(t.includes('sorry')||t.includes('error')||t.includes('fail')){col='#FF8800';shad='rgba(255,136,0,0.8)';emo='CONCERNED';}
  else if(t.includes('think')||t.includes('hmm')||t.includes('let me')){col='#8800FF';shad='rgba(136,0,255,0.8)';emo='THINKING';}
  else if(t.includes('alert')||t.includes('danger')||t.includes('warning')){col='#FF4444';shad='rgba(255,68,68,0.8)';emo='ALERT';}
  else if(t.includes('curious')||t.includes('interesting')||t.includes('wow')){col='#FFD700';shad='rgba(255,215,0,0.8)';emo='CURIOUS';}
  eyes.forEach(id=>{const e=document.getElementById(id);if(e){e.style.background=col;e.style.boxShadow='0 0 40px '+shad;}});
  if(el) el.textContent=emo;
  syncOverlayEyes(col,shad,emo);
}

function setSub(text){
  const sb=document.getElementById('sub');
  if(sb) sb.textContent=text.substring(0,120)+(text.length>120?'...':'');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACE RECOGNITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function captureFace(){
  const nameInp=document.getElementById('faceNameInp');
  const name=nameInp.value.trim();
  if(!name){alert('Enter person\'s name first!');return;}
  const vid=document.getElementById('cf');
  if(!camOn||!vid.srcObject){alert('Start camera first in Camera tab!');return;}
  // capture frame as base64
  const canvas=document.createElement('canvas');
  canvas.width=80; canvas.height=80;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(vid,0,0,80,80);
  const img=canvas.toDataURL('image/jpeg',0.7);
  // save
  const existing=faces.findIndex(f=>f.name.toLowerCase()===name.toLowerCase());
  if(existing>=0) faces[existing]={name,img,time:new Date().toLocaleString()};
  else faces.push({name,img,time:new Date().toLocaleString()});
  localStorage.setItem('bfaces',JSON.stringify(faces));
  nameInp.value='';
  renderFaceList();
  speak('Face saved for '+name+'!');
  addMsg('Face saved for '+name+'! Bro Bot will recognize and greet them!','sy');
}

function renderFaceList(){
  faces=JSON.parse(localStorage.getItem('bfaces')||'[]');
  const l=document.getElementById('faceList'), c=document.getElementById('faceCount');
  if(c) c.textContent=faces.length; if(!l) return;
  if(!faces.length){l.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:16px;">No faces saved yet!</div>';return;}
  l.innerHTML='';
  faces.forEach((f,i)=>{
    const d=document.createElement('div'); d.className='face-card';
    d.innerHTML='<div class="face-avatar"><img src="'+f.img+'" style="width:100%;height:100%;border-radius:50%;object-fit:cover;"></div><div class="face-info"><div class="face-name">'+escHtml(f.name)+'</div><div class="face-sub">Saved: '+f.time+'</div></div><button class="face-del" onclick="deleteFace('+i+')">‚úï</button>';
    l.appendChild(d);
  });
}

function deleteFace(i){
  faces.splice(i,1);
  localStorage.setItem('bfaces',JSON.stringify(faces));
  renderFaceList();
}

// simple face match check (compares current frame to saved faces)
function checkFaceInFrame(){
  if(!sett.faceRecog||!camOn||!faces.length) return;
  const vid=document.getElementById('cf');
  if(!vid.srcObject) return;
  const canvas=document.createElement('canvas');
  canvas.width=80; canvas.height=80;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(vid,0,0,80,80);
  const frameData=canvas.getContext('2d').getImageData(0,0,80,80).data;
  let bestMatch=null, bestScore=0;
  faces.forEach(f=>{
    const img=new Image(); img.src=f.img;
    const c2=document.createElement('canvas'); c2.width=80; c2.height=80;
    const ctx2=c2.getContext('2d');
    ctx2.drawImage(img,0,0,80,80);
    try{
      const saved=ctx2.getImageData(0,0,80,80).data;
      // pixel similarity score
      let diff=0;
      for(let i=0;i<frameData.length;i+=16) diff+=Math.abs(frameData[i]-saved[i]);
      const score=1-(diff/(frameData.length/16*255));
      if(score>bestScore){bestScore=score;bestMatch=f;}
    }catch(e){}
  });
  if(bestScore>0.7&&bestMatch){
    const cn=document.getElementById('camName');
    if(cn){cn.style.display='block';cn.textContent='Hi '+bestMatch.name+'!';}
    // greet if not greeted recently
    const now=Date.now();
    if(!bestMatch.lastGreet||(now-bestMatch.lastGreet)>30000){
      bestMatch.lastGreet=now;
      speak('Hello '+bestMatch.name+', good to see you!');
      setSub('Hello '+bestMatch.name+'!');
    }
  } else {
    const cn=document.getElementById('camName');
    if(cn) cn.style.display='none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROBOT / ESP32
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkCmds(text){
  if(!rOK) return; const t=text.toUpperCase();
  if(t.includes('[MOVE_FORWARD]'))cmd('forward');
  else if(t.includes('[MOVE_BACKWARD]'))cmd('backward');
  else if(t.includes('[TURN_LEFT]'))cmd('left');
  else if(t.includes('[TURN_RIGHT]'))cmd('right');
  else if(t.includes('[STOP]'))cmd('stop');
  if(t.includes('[HEAD_LEFT]'))sendE({action:'servo_head',angle:45});
  else if(t.includes('[HEAD_RIGHT]'))sendE({action:'servo_head',angle:135});
  else if(t.includes('[HEAD_CENTER]'))sendE({action:'servo_head',angle:90});
  if(t.includes('[TILT_UP]'))sendE({action:'servo_tilt',angle:60});
  else if(t.includes('[TILT_DOWN]'))sendE({action:'servo_tilt',angle:120});
}
function lookAtSpeaker(){if(!rOK||!sett.lookSpeak)return;sendE({action:'servo_head',angle:90});sendE({action:'servo_tilt',angle:75});}
async function cmd(a){await sendE({action:a,speed:sp,duration:0});}
async function sendE(obj){
  if(!eIP) return;
  try{await fetch('http://'+eIP+'/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj),signal:AbortSignal.timeout(1000)});}catch(e){}
}
function moveHead(v){document.getElementById('hV').textContent=v;sendE({action:'servo_head',angle:+v});}
function moveTilt(v){document.getElementById('tV').textContent=v;sendE({action:'servo_tilt',angle:+v});}
function updSp(v){sp=+v;document.getElementById('spV').textContent=v;}

async function connectESP(){
  const ip=document.getElementById('eIP').value.trim();
  if(!ip){alert('Enter ESP32 IP!');return;}
  eIP=ip; localStorage.setItem('bi',ip);
  const m=document.getElementById('cMsg');
  m.textContent='Connecting...'; m.style.color='var(--o)';
  try{
    const r=await fetch('http://'+ip+'/ping',{signal:AbortSignal.timeout(3000)});
    if(r.ok){rOK=true;m.textContent='Connected to Bro Bot!';m.style.color='var(--gr)';document.getElementById('rSt').innerHTML='<div class="dot"></div>Connected';startSensors();}
    else throw new Error();
  }catch(e){rOK=false;m.textContent='Cannot connect! Check IP & WiFi.';m.style.color='var(--r)';}
}

function startSensors(){
  clearInterval(sT);
  sT=setInterval(async()=>{
    if(!rOK||!eIP) return;
    try{
      const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(800)});
      const d=await r.json();
      if(d.ultrasonic!==undefined)document.getElementById('us').textContent=d.ultrasonic;
      if(d.battery!==undefined)document.getElementById('bat').textContent=d.battery;
      [['ir1','i1'],['ir2','i2'],['ir3','i3'],['ir4','i4']].forEach(([k,id])=>{if(d[k]!==undefined)document.getElementById(id).textContent=d[k]?'BLOCKED':'CLEAR';});
      if(sett.obstacle&&(d.ir1||d.ir2||d.ultrasonic<15))cmd('stop');
    }catch(e){}
  },500);
}

// camera
async function toggleCam(){
  const btn=document.getElementById('camB'),info=document.getElementById('camI');
  if(camOn){
    const v=document.getElementById('cf');
    v.srcObject?.getTracks().forEach(t=>t.stop());
    v.srcObject=null; camOn=false;
    btn.textContent='START CAMERA'; info.textContent='CAMERA OFF';
    clearInterval(window.faceTimer);
    return;
  }
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    document.getElementById('cf').srcObject=s; camOn=true;
    btn.textContent='STOP CAMERA'; info.textContent='CAMERA ACTIVE';
    window.faceTimer=setInterval(checkFaceInFrame,2000);
  }catch(e){info.textContent='Error: '+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveMem(text,cat,src){
  if(!text||text.length<3) return;
  mems.unshift({id:Date.now(),text,category:cat||'general',source:src||'auto',time:new Date().toLocaleString()});
  localStorage.setItem('bm',JSON.stringify(mems));
}
function addMem(){
  const inp=document.getElementById('mInp'),cat=document.getElementById('mCat').value,txt=inp.value.trim();
  if(!txt){alert('Type something!');return;}
  saveMem(txt,cat,'manual'); inp.value=''; renderMems();
}
function renderMems(){
  mems=JSON.parse(localStorage.getItem('bm')||'[]');
  const l=document.getElementById('mList'),c=document.getElementById('mCount');
  if(c) c.textContent=mems.length; if(!l) return;
  if(!mems.length){l.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:20px;">No memories yet!</div>';return;}
  l.innerHTML='';
  mems.forEach(m=>{
    const d=document.createElement('div'); d.className='mcard';
    d.innerHTML='<div class="mtime">'+m.time+' ¬∑ '+(m.source==='manual'?'üë§':'ü§ñ')+'</div><div class="mtext" id="mt'+m.id+'">'+escHtml(m.text)+'</div><span class="mtag">'+m.category+'</span><button class="medit" onclick="editMem('+m.id+')">‚úèÔ∏è</button><button class="mdel" onclick="delMem('+m.id+')">‚úï</button>';
    l.appendChild(d);
  });
}
function editMem(id){
  const el=document.getElementById('mt'+id); if(!el) return;
  const n=prompt('Edit memory:',el.textContent);
  if(n&&n.trim()){const i=mems.findIndex(m=>m.id===id);if(i>-1){mems[i].text=n.trim();mems[i].time='Edited: '+new Date().toLocaleString();}localStorage.setItem('bm',JSON.stringify(mems));renderMems();}
}
function delMem(id){mems=mems.filter(m=>m.id!==id);localStorage.setItem('bm',JSON.stringify(mems));renderMems();}
function clearMems(){if(!confirm('Clear ALL memories?'))return;mems=[];localStorage.setItem('bm','[]');renderMems();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderModels(){
  const el=document.getElementById('modelList'); if(!el) return;
  const sorted=[...MODELS].sort((a,b)=>b.tier-a.tier);
  el.innerHTML='';
  sorted.forEach((m,i)=>{
    const hasKey=!!keys[m.k];
    const isSkip=!!skip[m.name];
    const badge=!hasKey?'<span class="mbadge nokey">NO KEY</span>':isSkip?'<span class="mbadge skip">QUOTA</span>':'<span class="mbadge ok">READY</span>';
    el.innerHTML+=`<div class="mrow"><span class="mname">${i+1}. ${m.name}</span>${badge}</div>`;
  });
}
function resetSkip(){
  skip={};localStorage.setItem('bsk','{}');localStorage.setItem('bskt',''+Date.now());
  renderModels(); addMsg('All quota skips reset! All models ready!','sy');
}
function tog(el,key){el.classList.toggle('on');sett[key]=el.classList.contains('on');localStorage.setItem('bs',JSON.stringify(sett));}
function saveSett(){
  sett.personality=document.getElementById('sP').value;
  sett.voiceSpeed=parseFloat(document.getElementById('sVS').value);
  localStorage.setItem('bs',JSON.stringify(sett));
}
function loadSett(){
  sett=JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"lookSpeak":true,"nav":false,"faceRecog":true,"heyBro":true,"personality":"friendly","voiceSpeed":0.9}');
  [['tO','obstacle'],['tLS','lookSpeak'],['tFR','faceRecog'],['tHB','heyBro'],['tN','nav']].forEach(([id,k])=>{const e=document.getElementById(id);if(e)e.className='tog'+(sett[k]?' on':'');});
  const p=document.getElementById('sP'); if(p) p.value=sett.personality||'friendly';
  const v=document.getElementById('sVS'); if(v) v.value=sett.voiceSpeed||0.9;
}
function saveKeys(){
  keys={g:document.getElementById('kG').value.trim(), gh:document.getElementById('kGH').value.trim()};
  localStorage.setItem('bk',JSON.stringify(keys));
  const m=document.getElementById('kMsg'); m.textContent='Keys saved!';
  setTimeout(()=>m.textContent='',2000); renderModels();
}
function loadKeysUI(){
  keys=JSON.parse(localStorage.getItem('bk')||'{}');
  if(keys.g) document.getElementById('kG').value=keys.g;
  if(keys.gh) document.getElementById('kGH').value=keys.gh;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
keys  = JSON.parse(localStorage.getItem('bk')  ||'{}');
sett  = JSON.parse(localStorage.getItem('bs')  ||'{"obstacle":true,"lookSpeak":true,"nav":false,"faceRecog":true,"heyBro":true,"personality":"friendly","voiceSpeed":0.9}');
mems  = JSON.parse(localStorage.getItem('bm')  ||'[]');
skip  = JSON.parse(localStorage.getItem('bsk') ||'{}');
faces = JSON.parse(localStorage.getItem('bfaces')||'[]');
chats = JSON.parse(localStorage.getItem('bchats')||'[]');

// load voices
if(window.speechSynthesis) window.speechSynthesis.getVoices();
</script>
</body>
</html>
