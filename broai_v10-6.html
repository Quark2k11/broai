<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<title>Bro AI</title>
<!-- TF.js bundled via reliable CDN with fallback -->
<script>
window.TF_LOADED=false;
function loadTF(){
  return new Promise((res)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js';
    s.onload=()=>{window.TF_LOADED=true;res(true);};
    s.onerror=()=>{res(false);};
    document.head.appendChild(s);
  });
}
function loadCocoSsd(){
  return new Promise((res)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js';
    s.onload=()=>res(true);s.onerror=()=>res(false);
    document.head.appendChild(s);
  });
}
</script>
<script src="https://js.puter.com/v2/"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/dist/face-api.js" crossorigin="anonymous" onerror="console.warn('[FaceAPI] CDN failed, using AI fallback')"></script>
<!-- MediaPipe: using pixel-based gesture detection instead -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
:root{--c:#00FFFF;--d:#000;--d2:#0A0A1A;--d3:#0D0D2B;--g:#888;--gr:#00FF88;--r:#FF4444;--o:#FF8800;--pur:#8800FF;--gold:#FFD700;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:#000;color:#fff;font-family:'Rajdhani',sans-serif;}
.screen{display:none;flex-direction:column;position:fixed;inset:0;z-index:1;}
.screen.active{display:flex;}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
#homeScreen{background:radial-gradient(ellipse at center,#0D0D2B 0%,#000 70%);justify-content:center;align-items:center;gap:18px;}
.logo{font-family:'Orbitron',monospace;font-size:48px;font-weight:900;color:var(--c);letter-spacing:8px;animation:glow 2s infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 30px #00FFFF60}50%{text-shadow:0 0 60px #00FFFFcc}}
.tagline{color:var(--g);font-size:11px;letter-spacing:5px;}
.main-btn{width:80%;max-width:290px;height:58px;border:none;border-radius:32px;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:3px;cursor:pointer;transition:transform 0.15s;}
.main-btn:active{transform:scale(0.97);}
.main-btn.p{background:var(--c);color:#000;}
.main-btn.s{background:transparent;color:var(--c);border:2px solid var(--c);}
.settings-link{color:var(--g);font-size:12px;letter-spacing:2px;background:none;border:none;cursor:pointer;margin-top:6px;padding:6px 16px;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.tb{display:flex;align-items:center;padding:10px 12px;background:var(--d3);border-bottom:1px solid rgba(0,255,255,0.15);min-height:52px;gap:8px;flex-shrink:0;}
.tb-title{font-family:'Orbitron',monospace;font-size:13px;color:var(--c);font-weight:700;flex:1;}
.back{background:none;border:none;color:var(--c);font-size:22px;cursor:pointer;padding:2px 6px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--gr);animation:blink 1.5s infinite;flex-shrink:0;}
.dot.r{background:var(--r);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.mbadge{font-size:9px;color:var(--o);background:rgba(255,136,0,0.12);border:1px solid rgba(255,136,0,0.4);border-radius:10px;padding:2px 8px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ‚îÄ‚îÄ FACE SCREEN ‚îÄ‚îÄ */
#faceScreen{background:#000;position:relative;}
#faceArea{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;overflow:hidden;}
/* Hidden background camera */
#bgCamVideo{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;}
#bgCanvas{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;}
/* Status strip */
.face-status{position:absolute;top:10px;left:10px;right:52px;display:flex;flex-wrap:wrap;gap:5px;z-index:5;}
.fs-pill{font-family:'Orbitron',monospace;font-size:9px;padding:3px 8px;border-radius:10px;background:rgba(0,0,0,0.8);border:1px solid rgba(0,255,255,0.2);color:var(--g);letter-spacing:1px;}
.fs-pill.on{border-color:var(--gr);color:var(--gr);}
.fs-pill.alert{border-color:var(--r);color:var(--r);animation:blink 0.7s infinite;}
.fs-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 10px;cursor:pointer;font-size:15px;z-index:5;}
.bat{position:absolute;bottom:10px;right:10px;font-family:'Orbitron',monospace;font-size:10px;background:rgba(0,0,0,0.8);border:1px solid rgba(0,255,136,0.3);border-radius:8px;padding:3px 9px;color:var(--gr);z-index:5;display:none;}
.bat.low{border-color:var(--r);color:var(--r);}
.nav-pill{position:absolute;bottom:10px;left:10px;font-family:'Orbitron',monospace;font-size:9px;color:var(--o);background:rgba(0,0,0,0.8);border:1px solid rgba(255,136,0,0.3);border-radius:8px;padding:3px 9px;z-index:5;display:none;}
/* Eyes */
.emo-lbl{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;margin-bottom:18px;}
.eyes-row{display:flex;gap:44px;}
.eye{width:100px;height:100px;border-radius:50%;background:var(--c);position:relative;overflow:hidden;box-shadow:0 0 40px rgba(0,255,255,0.8);transition:background 0.4s,box-shadow 0.4s,height 0.1s,border-radius 0.1s;}
.eye.blink{height:6px!important;border-radius:3px!important;}
.pupil{position:absolute;width:40px;height:40px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform 0.4s;}
.shine{position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.sub-area{margin-top:45px;width:244px;min-height:52px;text-align:center;}
.sub-txt{font-size:15px;color:#fff;line-height:1.6;word-break:break-word;}
.listen-lbl{font-size:11px;color:var(--gr);font-family:'Orbitron',monospace;letter-spacing:2px;margin-top:8px;min-height:18px;}
/* Face bar */
#faceBar{display:flex;padding:8px 10px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.15);gap:6px;flex-shrink:0;}
.fbar{flex:1;height:42px;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:9px;font-weight:700;cursor:pointer;letter-spacing:1px;}
.fbar.cy{background:var(--c);color:#000;}
.fbar.ol{background:transparent;color:var(--c);border:1px solid rgba(0,255,255,0.4);}
.fbar.re{background:rgba(255,68,68,0.15);color:var(--r);border:1px solid var(--r);}

/* ‚îÄ‚îÄ FULLSCREEN ‚îÄ‚îÄ */
#fsOverlay{display:none;position:fixed;inset:0;z-index:999;background:#000;flex-direction:column;justify-content:center;align-items:center;}
#fsOverlay.show{display:flex;}
.fs-exit{position:absolute;top:14px;right:14px;background:rgba(0,0,0,0.6);border:1px solid rgba(0,255,255,0.3);color:var(--c);border-radius:8px;padding:7px 10px;cursor:pointer;font-size:15px;}
.fs-eyes{display:flex;gap:44px;}
.fs-eye{width:110px;height:110px;border-radius:50%;background:var(--c);position:relative;overflow:hidden;box-shadow:0 0 50px rgba(0,255,255,0.9);transition:background 0.4s,box-shadow 0.4s,height 0.1s,border-radius 0.1s;}
.fs-eye.blink{height:6px!important;border-radius:3px!important;}
.fs-pupil{position:absolute;width:44px;height:44px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform 0.4s;}
.fs-shine{position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:18%;left:58%;opacity:0.85;}
.fs-sub{margin-top:45px;width:264px;min-height:52px;text-align:center;}
.fs-sub-txt{font-size:16px;color:#fff;line-height:1.6;word-break:break-word;}
.fs-listen{font-size:11px;color:var(--gr);font-family:'Orbitron',monospace;letter-spacing:2px;margin-top:8px;min-height:18px;}
.fs-emo{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:4px;opacity:0.6;margin-bottom:18px;}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
#chatScreen{background:#000;}
.chat-wrap{flex:1;display:flex;overflow:hidden;}
.sidebar{width:0;overflow:hidden;background:var(--d2);border-right:1px solid rgba(0,255,255,0.1);transition:width 0.3s;flex-shrink:0;display:flex;flex-direction:column;}
.sidebar.open{width:230px;}
.sb-head{padding:12px;border-bottom:1px solid rgba(0,255,255,0.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sb-ttl{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);}
.sb-new{background:var(--c);color:#000;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;}
.sb-list{flex:1;overflow-y:auto;padding:8px;}
.sb-item{padding:10px;border-radius:10px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;position:relative;}
.sb-item:hover,.sb-item.act{background:rgba(0,255,255,0.08);border-color:rgba(0,255,255,0.2);}
.sb-name{font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:20px;}
.sb-date{font-size:10px;color:var(--g);margin-top:2px;}
.sb-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--r);font-size:13px;cursor:pointer;}
.chat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#msgList{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;}
.msg{max-width:86%;padding:11px 15px;border-radius:18px;font-size:15px;line-height:1.5;word-break:break-word;animation:fu 0.2s ease;}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.u{align-self:flex-end;background:var(--c);color:#000;font-weight:600;border-bottom-right-radius:4px;}
.msg.b{align-self:flex-start;background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-bottom-left-radius:4px;}
.msg.s{align-self:center;background:rgba(0,255,255,0.04);color:var(--g);font-size:12px;border-radius:12px;text-align:center;max-width:90%;padding:8px 14px;}
.typing{display:none;padding:0 12px 4px;flex-shrink:0;}
.typing-in{display:inline-flex;background:var(--d3);border:1px solid rgba(0,255,255,0.15);border-radius:18px;padding:12px 16px;gap:5px;}
.typing-in span{width:7px;height:7px;border-radius:50%;background:var(--c);animation:td 1.2s infinite;}
.typing-in span:nth-child(2){animation-delay:.2s}.typing-in span:nth-child(3){animation-delay:.4s}
@keyframes td{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
.input-bar{display:flex;align-items:center;padding:8px 10px 10px;background:var(--d3);border-top:1px solid rgba(0,255,255,0.15);gap:8px;flex-shrink:0;}
#chatInput{flex:1;background:#111830;border:2px solid rgba(0,255,255,0.3);border-radius:24px;padding:11px 16px;color:#fff;font-size:16px;font-family:'Rajdhani',sans-serif;outline:none;min-width:0;}
#chatInput:focus{border-color:var(--c);}
#chatInput::placeholder{color:#444;}
.mic-btn{width:46px;height:46px;border-radius:50%;border:1px solid rgba(0,255,255,0.3);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;background:var(--d2);color:var(--c);flex-shrink:0;}
.send-btn{width:46px;height:46px;border-radius:50%;border:none;cursor:pointer;font-size:18px;background:var(--c);color:#000;flex-shrink:0;}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
#settingsScreen{background:#000;}
.set-scroll{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;}
/* Section headers */
.sec-head{font-family:'Orbitron',monospace;font-size:10px;color:var(--c);letter-spacing:3px;opacity:0.8;margin:12px 0 6px;padding-left:2px;border-left:2px solid var(--c);padding-left:8px;}
/* Row */
.srow{display:flex;align-items:center;justify-content:space-between;background:var(--d3);border:1px solid rgba(0,255,255,0.08);border-radius:12px;padding:12px 14px;gap:10px;}
.srl{font-size:15px;font-weight:600;}
.srd{font-size:11px;color:var(--g);margin-top:2px;}
/* Toggle */
.tog{width:46px;height:24px;background:var(--d2);border-radius:12px;border:1px solid rgba(0,255,255,0.25);position:relative;cursor:pointer;transition:all 0.3s;flex-shrink:0;}
.tog.on{background:var(--c);border-color:var(--c);}
.tog::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all 0.3s;}
.tog.on::after{left:24px;}
/* Input */
.sinp{width:100%;background:var(--d3);border:1px solid rgba(0,255,255,0.25);border-radius:10px;padding:10px 14px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;outline:none;margin-bottom:6px;}
.sinp:focus{border-color:var(--c);}
/* Select */
.ssel{background:var(--d2);border:1px solid rgba(0,255,255,0.25);color:var(--c);border-radius:8px;padding:6px 10px;font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;}
/* Buttons */
.sbtn{width:100%;height:44px;border:none;border-radius:10px;font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:4px;}
.sbtn.cy{background:var(--c);color:#000;}
.sbtn.gray{background:#111;color:var(--g);border:1px solid #333;}
.sbtn.re{background:rgba(255,68,68,0.1);color:var(--r);border:1px solid rgba(255,68,68,0.3);}
/* Model row */
.mrow{display:flex;justify-content:space-between;align-items:center;background:var(--d3);border-radius:8px;padding:8px 12px;margin-bottom:3px;}
.mbadge{font-size:10px;padding:2px 8px;border-radius:8px;font-family:'Orbitron',monospace;}
.mbadge.ok{background:rgba(0,255,136,0.1);color:var(--gr);border:1px solid rgba(0,255,136,0.3);}
.mbadge.skip{background:rgba(255,68,68,0.1);color:var(--r);border:1px solid rgba(255,68,68,0.3);}
.mbadge.nokey{background:rgba(80,80,80,0.1);color:#555;border:1px solid #333;}
/* Slider */
.sl{width:100%;-webkit-appearance:none;height:5px;border-radius:3px;background:#1a1a3a;outline:none;margin:6px 0;}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--c);cursor:pointer;}
/* Face card */
.face-card{display:flex;align-items:center;gap:10px;background:var(--d3);border:1px solid rgba(0,255,255,0.1);border-radius:10px;padding:10px;margin-bottom:6px;}
.face-img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--c);flex-shrink:0;}
.face-info{flex:1;}
.face-name{font-size:14px;font-weight:600;}
.face-sub{font-size:11px;color:var(--g);}
.face-del{background:none;border:none;color:var(--r);font-size:16px;cursor:pointer;}
/* Unknown face card */
.unk-card{display:flex;align-items:center;gap:10px;background:rgba(255,136,0,0.06);border:1px solid rgba(255,136,0,0.2);border-radius:10px;padding:10px;margin-bottom:6px;}
.unk-img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--o);flex-shrink:0;}
/* Detection log */
.det-item{padding:8px 12px;border-radius:8px;background:var(--d3);border-left:3px solid var(--c);margin-bottom:4px;font-size:12px;line-height:1.6;}
.det-item.person{border-color:var(--gr);}
.det-item.motion{border-color:var(--r);}
.det-item.object{border-color:var(--o);}
/* Reminder item */
.rem-item{display:flex;align-items:center;gap:10px;background:var(--d3);border-radius:10px;padding:10px;margin-bottom:6px;}
.rem-time{font-family:'Orbitron',monospace;font-size:13px;color:var(--c);flex-shrink:0;}
.rem-del{background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;}
/* Report stat */
.rep-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,255,255,0.06);}
.rep-row:last-child{border:none;}
.rep-k{color:var(--g);font-size:13px;}
.rep-v{font-family:'Orbitron',monospace;font-size:14px;color:var(--c);}
/* Log entry */
.log-entry{font-size:11px;color:#aaa;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);line-height:1.6;}
/* Fun section */
.fun-result{font-size:14px;color:#fff;background:rgba(136,0,255,0.08);border:1px solid rgba(136,0,255,0.2);border-radius:10px;padding:12px;min-height:60px;line-height:1.6;margin-top:8px;}
/* Trivia */
.t-opt{padding:11px 14px;border-radius:10px;border:1px solid rgba(0,255,255,0.2);background:var(--d3);font-size:14px;cursor:pointer;text-align:left;width:100%;margin-bottom:6px;}
.t-opt.correct{background:rgba(0,255,136,0.15);border-color:var(--gr);color:var(--gr);}
.t-opt.wrong{background:rgba(255,68,68,0.12);border-color:var(--r);color:var(--r);}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(0,255,255,0.2);border-radius:2px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FACE SCREEN SPLIT LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#faceScreen{display:none;flex-direction:column;position:fixed;inset:0;z-index:1;background:var(--d1);}
#faceScreen.active{display:flex;}
#faceArea{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  position:relative;min-height:0;transition:flex 0.3s ease;}
#faceArea.shrunk{flex:0 0 42%;justify-content:flex-start;padding-top:6px;}

/* ‚ïê‚ïê VISION PANEL (bottom half) ‚ïê‚ïê */
#visionPanel{display:none;flex-direction:column;background:#000;
  border-top:2px solid rgba(0,255,255,0.25);flex:0 0 54%;min-height:0;}
#visionPanel.open{display:flex;}

#visionPanelBar{display:flex;align-items:center;gap:8px;padding:6px 10px;
  background:rgba(10,10,22,0.98);border-bottom:1px solid rgba(0,255,255,0.1);flex-shrink:0;}
#visionFlipBtn{background:rgba(0,255,255,0.08);border:1px solid rgba(0,255,255,0.25);
  color:var(--c);border-radius:50%;width:32px;height:32px;font-size:15px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;}
#visionStartBtn{background:var(--c);color:#000;border:none;border-radius:8px;
  padding:5px 14px;font-family:'Orbitron',monospace;font-size:10px;font-weight:700;cursor:pointer;}
#visionStartBtn.running{background:var(--r);}

#visionCamWrap{position:relative;width:100%;flex:1;min-height:0;background:#000;overflow:hidden;}
#visionVideo{width:100%;height:100%;object-fit:cover;display:block;}
#visionOverlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
#visionNoStream{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  color:rgba(0,255,255,0.3);font-size:13px;font-family:'Orbitron',monospace;letter-spacing:2px;}
#gestureIndicator{position:absolute;top:8px;right:8px;font-family:'Orbitron',monospace;
  font-size:14px;font-weight:700;color:#fff;background:rgba(0,0,0,0.6);
  border-radius:8px;padding:4px 10px;display:none;letter-spacing:1px;}

#visionDetPanel{max-height:100px;overflow-y:auto;flex-shrink:0;background:#080812;}
.vdet-empty{font-size:11px;color:#333;text-align:center;padding:10px;font-family:'Orbitron',monospace;}
.vdet-row{display:flex;align-items:center;gap:8px;padding:5px 10px;
  border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px;}
.vdet-row.known{border-left:3px solid var(--c);}
.vdet-row.intruder{border-left:3px solid var(--r);background:rgba(255,50,50,0.05);}
.vdet-row.person{border-left:3px solid var(--gr);}
.vdet-row.object{border-left:3px solid var(--o);}
.vdet-row.gesture{border-left:3px solid var(--pur);}
.vdet-name{flex:1;color:#ddd;font-weight:600;}
.vdet-type{font-size:10px;color:var(--g);}
.vdet-conf{font-size:10px;color:var(--g);margin-left:4px;}

#visionAskBar{display:flex;gap:6px;padding:5px 8px;background:#080812;
  border-top:1px solid rgba(0,255,255,0.08);flex-shrink:0;}
#visionAskBar input{flex:1;background:#0A0A1A;border:1px solid rgba(0,255,255,0.2);
  border-radius:16px;padding:6px 12px;color:#fff;font-size:13px;outline:none;
  font-family:'Rajdhani',sans-serif;}
#visionAskBar button{background:var(--c);color:#000;border:none;border-radius:16px;
  padding:6px 14px;font-weight:700;cursor:pointer;font-size:12px;}
#visionAskReply{padding:5px 12px;font-size:12px;color:#aaa;line-height:1.5;
  background:#080812;display:none;max-height:60px;overflow-y:auto;flex-shrink:0;
  border-top:1px solid rgba(0,255,255,0.05);}

/* faceArea adjustments when vision open */
#faceArea.shrunk .emo-lbl{font-size:10px;margin-bottom:2px;}
#faceArea.shrunk .eyes-row{gap:12px;}
#faceArea.shrunk .eye{width:60px;height:60px;}
#faceArea.shrunk .sub-area{padding:4px 12px;}
#faceArea.shrunk .sub-txt{font-size:13px;}
#faceArea.shrunk .face-status{top:0px;}
#faceArea.shrunk .listen-lbl{font-size:10px;}

/* ‚ïê‚ïê FACEBAR ‚ïê‚ïê */
#faceBar{display:flex;padding:6px 8px;background:var(--d3);
  border-top:1px solid rgba(0,255,255,0.12);gap:5px;flex-shrink:0;}
.fbar{flex:1;height:42px;border-radius:10px;border:none;font-family:'Orbitron',monospace;
  font-size:9px;font-weight:700;cursor:pointer;letter-spacing:0.5px;}
.fbar.cy{background:var(--c);color:#000;}
.fbar.ol{background:rgba(0,255,255,0.06);color:var(--c);border:1px solid rgba(0,255,255,0.25);}
.fbar.active{background:rgba(0,255,255,0.15);border-color:var(--c);}

/* ‚îÄ‚îÄ VISION TAB ‚îÄ‚îÄ */
#visionTab{display:none;position:absolute;bottom:47px;left:0;right:0;z-index:15;
  background:#0a0a16;border-top:2px solid rgba(0,255,255,0.3);flex-direction:column;
  max-height:calc(100% - 90px);box-shadow:0 -8px 32px rgba(0,0,0,0.8);}
#visionTab.open{display:flex;}
.vtab-bar{display:flex;align-items:center;gap:6px;padding:7px 10px;
  background:rgba(13,13,43,0.98);border-bottom:1px solid rgba(0,255,255,0.1);flex-shrink:0;}
.vtab-title{font-family:'Orbitron',monospace;font-size:11px;color:var(--c);letter-spacing:2px;flex:1;}
.vtab-close{background:none;border:none;color:var(--g);font-size:20px;cursor:pointer;padding:0 4px;}
#visionCamWrap{position:relative;width:100%;background:#000;flex-shrink:0;
  overflow:hidden;height:210px;max-height:42vh;}
#visionVideo{width:100%;height:100%;object-fit:cover;display:block;}
#visionOverlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
#visionDetPanel{overflow-y:auto;max-height:150px;padding:6px 10px;background:#0a0a16;flex-shrink:0;}
.vdet-row{display:flex;align-items:center;gap:8px;padding:6px 10px;
  border-radius:8px;margin-bottom:4px;font-size:13px;background:rgba(255,255,255,0.02);}
.vdet-row.person{background:rgba(0,255,136,0.06);border-left:3px solid var(--gr);}
.vdet-row.intruder{background:rgba(255,68,68,0.08);border-left:3px solid var(--r);animation:blink 0.8s infinite;}
.vdet-row.known{background:rgba(0,255,255,0.06);border-left:3px solid var(--c);}
.vdet-row.object{background:rgba(255,136,0,0.05);border-left:3px solid var(--o);}
.vdet-conf{font-size:10px;color:var(--g);margin-left:auto;white-space:nowrap;}
.vtab-btn{height:34px;padding:0 12px;border-radius:8px;border:none;
  font-family:'Orbitron',monospace;font-size:9px;font-weight:700;cursor:pointer;}
.vtab-btn.on{background:var(--c);color:#000;}
.vtab-btn.off{background:rgba(0,255,255,0.07);color:var(--c);border:1px solid rgba(0,255,255,0.3);}
#visionAskRow{display:flex;gap:6px;padding:6px 8px;border-top:1px solid rgba(0,255,255,0.08);flex-shrink:0;}
#visionAskInput{flex:1;background:#0A0A1A;border:1px solid rgba(0,255,255,0.2);border-radius:18px;
  padding:7px 12px;color:#fff;font-size:14px;outline:none;font-family:'Rajdhani',sans-serif;}
#visionAskSend{background:var(--c);color:#000;border:none;border-radius:18px;
  padding:7px 14px;font-weight:700;cursor:pointer;font-size:13px;white-space:nowrap;}
#visionAskReply{padding:6px 12px;font-size:13px;color:#ccc;line-height:1.5;
  background:rgba(0,255,255,0.02);border-top:1px solid rgba(0,255,255,0.05);
  flex-shrink:0;display:none;max-height:80px;overflow-y:auto;}

/* ‚îÄ‚îÄ ACCORDION / DROPDOWN SECTIONS ‚îÄ‚îÄ */
.acc-wrap{border:1px solid rgba(0,255,255,0.1);border-radius:12px;overflow:hidden;margin-bottom:4px;}
.acc-head{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--d3);cursor:pointer;user-select:none;}
.acc-head:active{background:rgba(0,255,255,0.08);}
.acc-title{font-size:14px;font-weight:600;}
.acc-sub{font-size:10px;color:var(--g);margin-top:2px;}
.acc-arrow{font-size:14px;color:var(--c);transition:transform 0.25s;flex-shrink:0;}
.acc-arrow.open{transform:rotate(180deg);}
.acc-body{max-height:0;overflow:hidden;transition:max-height 0.35s ease,padding 0.2s;}
.acc-body.open{max-height:2000px;padding:10px 12px 14px;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HOME ‚Äî Only 2 buttons + settings
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="homeScreen" class="screen active">
  <div class="logo">Bro AI</div>
  <div class="tagline">Your AI Robot Companion</div>
  <button class="main-btn p" onclick="goTo('faceScreen')">ü§ñ &nbsp;Bro Bot</button>
  <button class="main-btn s" onclick="goTo('chatScreen')">üí¨ &nbsp;Bro AI Chat</button>
  <button class="settings-link" onclick="goTo('settingsScreen')">‚öô Settings</button>
  <div style="font-size:9px;color:#1a1a2e;margin-top:10px;letter-spacing:3px;">v10.0</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FACE SCREEN ‚Äî Everything runs here
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="faceScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="goTo('homeScreen')">‚Üê</button>
    <div class="tb-title" id="faceTitle">Bro Bot</div>
    <div id="voiceStatus" style="font-size:10px;color:var(--g);font-family:'Orbitron',monospace;letter-spacing:1px;">OFF</div>
    <div class="dot r" id="botDot"></div>
  </div>

  <!-- Hidden bg camera for guardian detection (invisible) -->
  <video id="bgCamVideo" autoplay playsinline muted style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;"></video>
  <canvas id="bgCanvas" style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;"></canvas>

  <!-- TOP HALF: Robot face -->
  <div id="faceArea">
    <div class="face-status">
      <div class="fs-pill" id="pillVoice">üé§ VOICE</div>
      <div class="fs-pill" id="pillGuard">üõ° GUARD</div>
      <div class="fs-pill" id="pillDetect">üëÅ DETECT</div>
      <div class="fs-pill" id="pillNav">üß≠ NAV</div>
      <div class="fs-pill" id="pillML">ML</div>
    </div>
    <button class="fs-btn" onclick="openFS()">‚õ∂</button>
    <div class="bat" id="batDisp">üîã --</div>
    <div class="nav-pill" id="navPill">üß≠ EXPLORING</div>
    <div class="emo-lbl" id="emoLbl">NEUTRAL</div>
    <div class="eyes-row">
      <div class="eye" id="eyeL"><div class="pupil" id="pupL"></div><div class="shine"></div></div>
      <div class="eye" id="eyeR"><div class="pupil" id="pupR"></div><div class="shine"></div></div>
    </div>
    <div class="sub-area">
      <div class="sub-txt" id="subTxt">Hello! I am Bro Bot.</div>
      <div class="listen-lbl" id="listenLbl"></div>
    </div>
  </div>

  <!-- BOTTOM BAR: controls -->
  <div id="faceBar">
    <button class="fbar cy" id="voiceBtn" onclick="toggleVoice()">üé§ VOICE</button>
    <button class="fbar ol" id="camBtn" onclick="toggleBgCam()">üì∑ CAM</button>
    <button class="fbar ol" id="visionToggleBtn" onclick="toggleVisionPanel()">üëÅ VISION</button>
    <button class="fbar ol" onclick="goTo('settingsScreen')">‚öô SET</button>
    <button class="fbar ol" onclick="openFS()">‚õ∂ FULL</button>
  </div>

  <!-- BOTTOM HALF: Vision panel (shown/hidden by toggle) -->
  <div id="visionPanel">
    <!-- Camera header bar -->
    <div id="visionPanelBar">
      <div id="visionMLStatus" style="font-family:'Orbitron',monospace;font-size:10px;color:var(--o);">ML LOADING...</div>
      <div id="visionGestureStatus" style="font-family:'Orbitron',monospace;font-size:10px;color:var(--pur);display:none;">‚úã GESTURE</div>
      <div style="flex:1;"></div>
      <button id="visionFlipBtn" onclick="flipVisionCam()" title="Flip camera">üîÑ</button>
      <button id="visionStartBtn" onclick="toggleVisionCam()">‚ñ∂ START</button>
    </div>

    <!-- Live feed with detection overlay -->
    <div id="visionCamWrap">
      <video id="visionVideo" autoplay playsinline muted></video>
      <canvas id="visionOverlay"></canvas>
      <!-- Gesture indicator overlay -->
      <div id="gestureIndicator"></div>
      <div id="visionNoStream">üëÅ TAP START</div>
    </div>

    <!-- Detection list -->
    <div id="visionDetPanel">
      <div class="vdet-empty">Camera off ‚Äî tap ‚ñ∂ START above</div>
    </div>

    <!-- Ask bar -->
    <div id="visionAskBar">
      <input id="visionAskInput" placeholder="Ask about what I see..." onkeypress="if(event.key==='Enter'){visionAsk();}">
      <button onclick="visionAsk()">ASK</button>
    </div>
    <div id="visionAskReply"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FULLSCREEN OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="fsOverlay">
  <button class="fs-exit" onclick="closeFS()">‚õ∂</button>
  <div class="fs-emo" id="fsEmo">NEUTRAL</div>
  <div class="fs-eyes">
    <div class="fs-eye" id="fsEyeL"><div class="fs-pupil" id="fsPupL"></div><div class="fs-shine"></div></div>
    <div class="fs-eye" id="fsEyeR"><div class="fs-pupil" id="fsPupR"></div><div class="fs-shine"></div></div>
  </div>
  <div class="fs-sub">
    <div class="fs-sub-txt" id="fsSub">Hello!</div>
    <div class="fs-listen" id="fsListen"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHAT SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="chatScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="toggleSidebar()">‚ò∞</button>
    <button class="back" onclick="goTo('homeScreen')">‚Üê</button>
    <div class="tb-title">Bro AI</div>
    <div class="mbadge" id="modelBadge">READY</div>
    <div class="dot"></div>
  </div>
  <div class="chat-wrap">
    <div class="sidebar" id="sidebar">
      <div class="sb-head"><div class="sb-ttl">HISTORY</div><button class="sb-new" onclick="newChat()">+ NEW</button></div>
      <div class="sb-list" id="sbList"></div>
    </div>
    <div class="chat-main">
      <div id="msgList"><div class="msg s">Bro AI v10 ready! All systems active.</div></div>
      <div class="typing" id="typingDiv"><div class="typing-in"><span></span><span></span><span></span></div></div>
      <div class="input-bar">
        <button class="mic-btn" id="chatMicBtn" onclick="chatMic()">üé§</button>
        <input id="chatInput" type="text" placeholder="Ask Bro AI..." onkeypress="if(event.key==='Enter'){event.preventDefault();sendChat();}">
        <button class="send-btn" onclick="sendChat()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETTINGS ‚Äî All features organized
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="settingsScreen" class="screen">
  <div class="tb">
    <button class="back" onclick="goTo('homeScreen')">‚Üê</button>
    <div class="tb-title">Settings</div>
  </div>
  <div class="set-scroll">

    <!-- ‚ïê‚ïê PUTER.JS ‚ïê‚ïê -->
    <div class="acc-wrap" style="border-color:rgba(136,0,255,0.3);">
      <div class="acc-head" onclick="toggleAcc('accPuterMain')" style="background:rgba(136,0,255,0.08);">
        <div><div class="acc-title" style="color:var(--pur);">‚ú¶ Puter.js ‚Äî Free AI</div><div class="acc-sub">GPT-5 ¬∑ Claude 4 ¬∑ Gemini ¬∑ No key needed</div></div>
        <div class="acc-arrow" id="arrPuterMain" style="color:var(--pur);">‚ñº</div>
      </div>
      <div class="acc-body" id="accPuterMain">
        <div id="puterStatus" style="font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--g);margin-bottom:8px;">‚óâ NOT SIGNED IN</div>
        <div style="font-size:12px;color:var(--g);margin-bottom:10px;line-height:1.7;">Sign in free ‚Äî get GPT-5, Claude 4, Gemini, image gen, TTS, cloud save!</div>
        <button class="sbtn" style="background:var(--pur);color:#fff;margin-bottom:4px;" onclick="puterSignIn()">üîê SIGN IN TO PUTER (FREE)</button>
        <button class="sbtn gray" onclick="puterSignOut()">SIGN OUT</button>
        <div id="puterUserInfo" style="font-size:11px;color:var(--gr);margin-top:6px;min-height:14px;"></div>
        <div style="margin-top:10px;font-size:12px;color:var(--g);font-weight:600;margin-bottom:6px;">Puter Features:</div>
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">AI Vision (Camera‚ÜíAI)</div><div class="srd">Send frame to GPT/Claude</div></div><div class="tog on" id="tPuterVision" onclick="togSet(this,'puterVision')"></div></div>
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">Puter TTS Voice</div><div class="srd">ElevenLabs quality</div></div><div class="tog" id="tPuterTTS" onclick="togSet(this,'puterTTS')"></div></div>
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">Cloud Save (Puter FS)</div><div class="srd">Save chats to cloud</div></div><div class="tog" id="tPuterFS" onclick="togSet(this,'puterFS')"></div></div>
        <div class="srow" style="margin-bottom:10px;"><div><div class="srl">KV Sync (Cross-device)</div><div class="srd">Sync settings everywhere</div></div><div class="tog" id="tPuterKV" onclick="togSet(this,'puterKV')"></div></div>
        <button class="sbtn gray" onclick="testPuterVision()">üëÅ Test AI Vision</button>
        <button class="sbtn gray" onclick="testImgGen()">üé® Test Image Generation</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê API KEYS ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accKeys')">
        <div><div class="acc-title">üîë API Keys</div><div class="acc-sub" id="keysSub">Tap to add your keys</div></div>
        <div class="acc-arrow" id="arrKeys">‚ñº</div>
      </div>
      <div class="acc-body" id="accKeys">
        <div style="font-size:11px;color:var(--g);margin-bottom:8px;line-height:1.8;">All keys are stored locally on your device only.</div>
        <div style="font-size:11px;color:var(--c);margin-bottom:4px;">Google Gemini (aistudio.google.com)</div>
        <input type="password" class="sinp" id="kG" placeholder="AIzaSy...">
        <div style="font-size:11px;color:var(--gr);margin-bottom:4px;">‚ö° Groq ‚Äî Fast free AI (console.groq.com)</div>
        <input type="password" class="sinp" id="kGroq" placeholder="gsk_...">
        <div style="font-size:11px;color:#ff7043;margin-bottom:4px;">üåü Mistral AI (console.mistral.ai)</div>
        <input type="password" class="sinp" id="kMis" placeholder="Dvy8...">
        <div style="font-size:11px;color:var(--o);margin-bottom:4px;">OpenRouter (openrouter.ai ‚Äî free)</div>
        <input type="password" class="sinp" id="kOR" placeholder="sk-or-...">
        <div style="font-size:11px;color:var(--gold);margin-bottom:4px;">HuggingFace (hf.co/settings/tokens ‚Äî free)</div>
        <input type="password" class="sinp" id="kHF" placeholder="hf_...">
        <div style="font-size:11px;color:var(--pur);margin-bottom:4px;">Wisdom Gate (minimax-m2.5:free)</div>
        <input type="password" class="sinp" id="kWG" placeholder="Wisdom Gate key...">
        <div style="font-size:11px;color:var(--g);margin-bottom:4px;">GitHub AI (github.com/settings/tokens ‚Äî free)</div>
        <input type="password" class="sinp" id="kGH" placeholder="ghp_...">
        <button class="sbtn cy" onclick="saveKeys()">üíæ SAVE ALL KEYS</button>
        <div id="keyMsg" style="text-align:center;font-size:12px;color:var(--gr);min-height:16px;"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê AI MODELS ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accModels')">
        <div><div class="acc-title">ü§ñ AI Models</div><div class="acc-sub">6 providers ¬∑ Priority order</div></div>
        <div class="acc-arrow" id="arrModels">‚ñº</div>
      </div>
      <div class="acc-body" id="accModels">
        <div style="font-size:11px;color:var(--g);margin-bottom:10px;line-height:1.8;">Models are tried in priority order: <b style="color:var(--pur);">Puter</b> ‚Üí <b style="color:var(--c);">Gemini</b> ‚Üí <b style="color:var(--o);">OpenRouter</b> ‚Üí <b style="color:var(--gold);">HuggingFace</b> ‚Üí Wisdom Gate ‚Üí GitHub</div>

        <!-- Puter Models -->
        <div style="font-size:11px;color:var(--pur);font-weight:700;margin-bottom:4px;">‚ú¶ Puter.js ‚Äî FREE (Priority 1)</div>
        <select class="sinp" id="puterModelSel" onchange="sett.puterModel=this.value;saveSett()" style="margin-bottom:10px;">
          <option value="gpt-4o-mini">GPT-4o Mini (fastest)</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-5-mini">GPT-5 Mini</option>
          <option value="gpt-5">GPT-5</option>
          <option value="claude-opus-4-5">Claude Sonnet 4.5</option>
          <option value="claude-opus-4">Claude Opus 4</option>
          <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
          <option value="grok-beta">Grok Beta</option>
          <option value="deepseek-chat">DeepSeek Chat</option>
          <option value="deepseek-r1">DeepSeek R1 (thinking)</option>
          <option value="meta-llama/llama-4-maverick:free">Llama 4 Maverick</option>
          <option value="mistralai/mistral-nemo:free">Mistral Nemo</option>
          <option value="arcee-ai/arcee-blitz:free">Arcee Blitz</option>
        </select>
        <div id="puterModelStatus" style="font-size:11px;color:var(--g);line-height:1.8;margin-bottom:6px;"></div>
        <button class="sbtn gray" style="margin-bottom:12px;" onclick="loadPuterModels()">üîÑ Load Live Puter Models</button>

        <!-- Groq Models ‚Äî Priority 2 -->
        <div style="font-size:11px;color:var(--gr);font-weight:700;margin-bottom:4px;">‚ö° Groq ‚Äî Ultra Fast (Priority 2)</div>
        <select class="sinp" id="groqModelSel" onchange="sett.groqModel=this.value;saveSett()" style="margin-bottom:10px;">
          <option value="llama-3.3-70b-versatile">Llama 3.3 70B Versatile ‚òÖ Best</option>
          <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant (fastest)</option>
          <option value="mixtral-8x7b-32768">Mixtral 8x7B 32K</option>
          <option value="gemma2-9b-it">Gemma2 9B</option>
          <option value="deepseek-r1-distill-llama-70b">DeepSeek R1 70B (thinking)</option>
          <option value="qwen-qwq-32b">Qwen QwQ 32B</option>
          <option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout 17B</option>
        </select>
        <div id="groqModelStatus" style="font-size:11px;margin-bottom:10px;"></div>

        <!-- Mistral Models ‚Äî Priority 3 -->
        <div style="font-size:11px;color:#ff7043;font-weight:700;margin-bottom:4px;">üåü Mistral AI (Priority 3)</div>
        <select class="sinp" id="selMistral" onchange="sett.mistralModel=this.value;saveSett()" style="margin-bottom:6px;">
          <option value="mistral-large-latest">Mistral Large 2 ‚òÖ Best</option>
          <option value="mistral-small-latest">Mistral Small 3.1 (fast)</option>
          <option value="open-mistral-nemo">Mistral Nemo (lightest)</option>
          <option value="codestral-latest">Codestral (code tasks)</option>
        </select>
        <div id="mistralModelStatus" style="font-size:11px;margin-bottom:10px;"></div>

        <!-- Gemini Models ‚Äî Priority 4 -->
        <div style="font-size:11px;color:var(--c);font-weight:700;margin-bottom:4px;">üîµ Google Gemini/Gemma (Priority 3)</div>
        <select class="sinp" id="geminiModelSel" onchange="sett.geminiModel=this.value;saveSett()" style="margin-bottom:6px;">
          <option value="gemma-3-27b-it">Gemma 3 27B ‚Äî 14,400/day ‚òÖ</option>
          <option value="gemma-3-12b-it">Gemma 3 12B ‚Äî 14,400/day</option>
          <option value="gemini-2.5-flash-preview-04-17">Gemini 2.5 Flash ‚Äî 20/day</option>
          <option value="gemini-2.5-flash-lite-preview-06-17">Gemini 2.5 Flash Lite ‚Äî 20/day</option>
        </select>
        <div id="geminiModelList" style="margin-bottom:10px;"></div>
        <button class="sbtn gray" style="margin-bottom:12px;" onclick="resetSkip()">üîÑ Reset Quota Skips</button>

        <!-- OpenRouter Models -->
        <div style="font-size:11px;color:var(--o);font-weight:700;margin-bottom:4px;">üü† OpenRouter (Priority 3)</div>
        <select class="sinp" id="orModelSel" onchange="sett.orModel=this.value;saveSett()" style="margin-bottom:6px;">
          <option value="arcee-ai/trinity-large-preview:free">Arcee Trinity Large</option>
          <option value="upstage/solar-pro2-preview:free">Upstage Solar Pro 3</option>
          <option value="stepfun/step-3-5-flash:free">StepFun Step 3.5 Flash</option>
          <option value="sourceful/riverflow-v2-pro:free">Riverflow V2 Pro</option>
          <option value="sourceful/riverflow-v2-fast:free">Riverflow V2 Fast</option>
          <option value="liquid/lfm-2.5-1.2b-thinking:free">LiquidAI LFM2.5 Thinking</option>
          <option value="liquid/lfm-2.5-1.2b-instruct:free">LiquidAI LFM2.5 Instruct</option>
          <option value="nvidia/llama-3.2-nemotron-super-49b-v1:free">NVIDIA Nemotron</option>
        </select>
        <div id="orModelList" style="margin-bottom:10px;"></div>

        <!-- HuggingFace Models -->
        <div style="font-size:11px;color:var(--gold);font-weight:700;margin-bottom:4px;">üü° HuggingFace (Priority 4)</div>
        <select class="sinp" id="hfModelSel" onchange="sett.hfModel=this.value;saveSett()" style="margin-bottom:6px;">
          <option value="cutycat2000x/MeowGPT-3.5">MeowGPT-3.5</option>
          <option value="cutycat2000x/MeowGPT-3">MeowGPT-3</option>
          <option value="cutycat2000x/MeowGPT-ll3">MeowGPT-ll3</option>
          <option value="mradermacher/MeowGPT-3.5-GGUF">MeowGPT-3.5 GGUF</option>
          <option value="mradermacher/MeowGPT-ll3-GGUF">MeowGPT-ll3 GGUF</option>
          <option value="cutycat2000x/InterDiffusion-4.0">InterDiffusion-4.0</option>
          <option value="cutycat2000x/InterDiffusion-3.8">InterDiffusion-3.8</option>
          <option value="cutycat2000x/InterDiffusion-3.5">InterDiffusion-3.5</option>
          <option value="cutycat2000x/InterDiffusion-3">InterDiffusion-3</option>
          <option value="cutycat2000x/MeowGPT-2.5">MeowGPT-2.5</option>
          <option value="cutycat2000/MeowGPT-2">MeowGPT-2</option>
          <option value="cutycat2000/InterDiffusion-2.5">InterDiffusion-2.5</option>
          <option value="cutycat2000/InterDiffusion-2">InterDiffusion-2</option>
          <option value="cutycat2000/InterDiffusion-Nano">InterDiffusion-Nano</option>
          <option value="e-n-v-y/hidream-uncensored">HiDream Uncensored</option>
          <option value="xlelords/orbis-coder">Orbis Coder</option>
          <option value="xlelords/omriX">OmriX</option>
          <option value="aaravriyer193/monke-0.4b-v1.1">Monke-0.4B</option>
        </select>
        <div id="hfModelList" style="margin-bottom:10px;"></div>

        <!-- Wisdom Gate -->
        <div style="font-size:11px;color:var(--pi);font-weight:700;margin-bottom:4px;">üîÆ Wisdom Gate (Priority 5)</div>
        <div id="wgModelList" style="margin-bottom:10px;font-size:11px;color:var(--g);">minimax-m2.5:free</div>

        <!-- GitHub -->
        <div style="font-size:11px;color:var(--g);font-weight:700;margin-bottom:4px;">‚ö´ GitHub AI (Priority 6)</div>
        <select class="sinp" id="ghModelSel" style="margin-bottom:6px;">
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="meta-llama-3.3-70b-instruct">Llama 3.3 70B</option>
          <option value="deepseek-r1">DeepSeek R1</option>
          <option value="phi-4">Phi-4</option>
          <option value="mistral-large-2411">Mistral Large</option>
        </select>
        <div id="ghModelList"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê ESP32 ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accESP')">
        <div><div class="acc-title">üì° ESP32 Robot</div><div class="acc-sub" id="espSubLbl">Not connected</div></div>
        <div class="acc-arrow" id="arrESP">‚ñº</div>
      </div>
      <div class="acc-body" id="accESP">
        <input type="text" class="sinp" id="espIP" placeholder="ESP32 IP ‚Äî e.g. 192.168.1.100">
        <button class="sbtn cy" onclick="connectESP()">CONNECT BRO BOT</button>
        <div id="espMsg" style="text-align:center;font-size:12px;color:var(--g);min-height:16px;margin-top:4px;"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê VOICE & LANGUAGE ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accVoice')">
        <div><div class="acc-title">üîä Voice & Language</div><div class="acc-sub">Language, speed, Jarvis voice</div></div>
        <div class="acc-arrow" id="arrVoice">‚ñº</div>
      </div>
      <div class="acc-body" id="accVoice">
        <div class="srow" style="margin-bottom:6px;"><div><div class="srl">Language</div></div>
          <select class="ssel" id="sLang" onchange="saveSett()">
            <option value="en-US">English US</option><option value="en-GB">English UK</option>
            <option value="hi-IN">Hindi</option><option value="ta-IN">Tamil</option>
            <option value="te-IN">Telugu</option><option value="ml-IN">Malayalam</option>
            <option value="kn-IN">Kannada</option><option value="fr-FR">French</option>
            <option value="de-DE">German</option><option value="ja-JP">Japanese</option>
            <option value="zh-CN">Chinese</option><option value="es-ES">Spanish</option>
            <option value="ar-SA">Arabic</option>
          </select>
        </div>
        <div class="srow" style="margin-bottom:6px;"><div><div class="srl">Voice Speed</div><div class="srd">Jarvis rate (0.5‚Äì2.0)</div></div>
          <input type="range" class="sl" style="width:100px;" min="0.5" max="2" step="0.1" value="0.9" id="sSpeed" oninput="saveSett()">
        </div>
        <button class="sbtn gray" onclick="checkVoice()">üîä Test Voice</button>
        <div id="voiceBox" style="font-size:11px;color:var(--gr);background:rgba(0,255,255,0.04);border-radius:8px;padding:10px;display:none;margin-top:6px;line-height:1.8;"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê AI PERSONALITY ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accAI')">
        <div><div class="acc-title">üß† AI Personality</div><div class="acc-sub">Personality style, idle nav</div></div>
        <div class="acc-arrow" id="arrAI">‚ñº</div>
      </div>
      <div class="acc-body" id="accAI">
        <div class="srow" style="margin-bottom:6px;"><div><div class="srl">Personality</div></div>
          <select class="ssel" id="sPers" onchange="saveSett()">
            <option value="friendly">Friendly Bro</option><option value="funny">Funny Bro</option>
            <option value="professional">Professional</option><option value="jarvis">Jarvis</option>
            <option value="serious">Serious</option>
          </select>
        </div>
        <div class="srow"><div><div class="srl">Auto Nav When Idle</div><div class="srd">Robot explores after 30s silence</div></div><div class="tog on" id="tNav" onclick="togSet(this,'autoNav')"></div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê ROBOT BEHAVIOR ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accRobot')">
        <div><div class="acc-title">ü§ñ Robot Behavior</div><div class="acc-sub">Obstacle, follow, battery</div></div>
        <div class="acc-arrow" id="arrRobot">‚ñº</div>
      </div>
      <div class="acc-body" id="accRobot">
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">Auto Obstacle Avoid</div><div class="srd">Stop when sensors blocked</div></div><div class="tog on" id="tObs" onclick="togSet(this,'obstacle')"></div></div>
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">Person Follow Mode</div><div class="srd">Follow detected person</div></div><div class="tog" id="tFollow" onclick="togSet(this,'followPerson')"></div></div>
        <div class="srow"><div><div class="srl">Battery Alert</div><div class="srd">Warn below 15%</div></div><div class="tog on" id="tBat" onclick="togSet(this,'batAlert')"></div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê SAFETY ‚ïê‚ïê -->
    <div class="acc-wrap" style="border-color:rgba(255,68,68,0.25);">
      <div class="acc-head" onclick="toggleAcc('accSafety')" style="background:rgba(255,68,68,0.05);">
        <div><div class="acc-title" style="color:var(--r);">üõ° Safety</div><div class="acc-sub">Guardian ¬∑ Emergency ¬∑ Always on</div></div>
        <div class="acc-arrow" id="arrSafety" style="color:var(--r);">‚ñº</div>
      </div>
      <div class="acc-body" id="accSafety">
        <div class="srow" style="margin-bottom:4px;border-color:rgba(255,68,68,0.15);">
          <div><div class="srl" style="color:var(--r);">Guardian Mode</div><div class="srd">Detect intruders on any screen</div></div>
          <div class="tog on" id="tGuard" onclick="togGuardian(this)"></div>
        </div>
        <div class="srow" style="margin-bottom:8px;border-color:rgba(255,68,68,0.15);">
          <div><div class="srl" style="color:var(--r);">Emergency Listener</div><div class="srd">Say help / SOS / danger</div></div>
          <div class="tog on" id="tEmerg" onclick="togEmergency(this)"></div>
        </div>
        <div class="srow" style="margin-bottom:8px;border-color:rgba(255,68,68,0.15);">
          <div><div class="srl" style="color:var(--o);">Night-Only Alerts</div><div class="srd">Only alert strangers 10pm‚Äì7am (day = log only)</div></div>
          <div class="tog" id="tGuardNight" onclick="togSet(this,'guardNight')"></div>
        </div>
        <div style="font-size:11px;color:var(--g);background:rgba(255,68,68,0.04);border:1px solid rgba(255,68,68,0.12);border-radius:8px;padding:10px;line-height:1.8;margin-bottom:8px;">
          Words: <span style="color:var(--r);">help ¬∑ SOS ¬∑ danger ¬∑ fire ¬∑ intruder ¬∑ attack ¬∑ mayday ¬∑ call police</span>
        </div>
        <button class="sbtn re" onclick="testSOS()">üö® Test SOS Alert</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê VISION ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accVision')">
        <div><div class="acc-title">üëÅ Vision & Detection</div><div class="acc-sub">Face recognition ¬∑ Objects ¬∑ Unknown faces</div></div>
        <div class="acc-arrow" id="arrVision">‚ñº</div>
      </div>
      <div class="acc-body" id="accVision">
        <div class="srow" style="margin-bottom:4px;"><div><div class="srl">Background Detection</div><div class="srd">Detect people/objects on face screen</div></div><div class="tog on" id="tDetect" onclick="togSet(this,'detection')"></div></div>
        <div class="srow" style="margin-bottom:8px;"><div><div class="srl">Face Recognition</div><div class="srd">Gemini Vision identifies faces</div></div><div class="tog on" id="tFaceRec" onclick="togSet(this,'faceRec')"></div></div>
        <div id="mlStatusRow" style="text-align:center;font-size:11px;color:var(--o);padding:6px;font-family:'Orbitron',monospace;margin-bottom:6px;">ML: LOADING...</div>

        <!-- Register Face -->
        <div style="font-size:12px;color:var(--c);font-weight:700;margin-bottom:6px;">üë®‚Äçüë©‚Äçüëß Register Known Faces</div>
        <input type="text" class="sinp" id="fOrigName" placeholder="Full name (e.g. Rahul Sharma)">
        <input type="text" class="sinp" id="fNickname" placeholder="Nickname (e.g. Bro, Buddy)">
        <input type="text" class="sinp" id="fCallName" placeholder="How to greet (e.g. Hey Rahul!)">
        <input type="text" class="sinp" id="fRelation" placeholder="Relation (e.g. Friend, Brother)">
        <button class="sbtn cy" onclick="captureFace()">üì∏ Capture Face From Camera</button>
        <div style="font-size:11px;color:var(--g);margin-top:4px;line-height:1.6;">üí° Tip: Capture 3‚Äì5 times with different head angles for best accuracy. Open Vision tab or tap CAM first.</div>
        <div id="knownFaceList" style="margin-top:6px;"></div>

        <!-- Unknown Faces -->
        <div style="font-size:12px;color:var(--o);font-weight:700;margin:10px 0 6px;">üë§ Unknown Faces Detected</div>
        <div id="unknownFaceList"><div style="font-size:12px;color:#333;text-align:center;padding:10px;">No unknowns yet</div></div>
        <button class="sbtn gray" onclick="clearUnknowns()">üóë Clear Unknowns</button>

        <!-- Object Log -->
        <div style="font-size:12px;color:var(--gold);font-weight:700;margin:10px 0 6px;">üì¶ Objects Detected Log</div>
        <div id="objectLogDiv" style="max-height:130px;overflow-y:auto;"></div>
        <button class="sbtn gray" onclick="clearObjectLog()">üóë Clear Log</button>

        <!-- Live Stats -->
        <div style="font-size:12px;color:var(--gr);font-weight:700;margin:10px 0 6px;">üìä Live Detection Status</div>
        <div id="detectionStats" style="background:rgba(0,255,255,0.03);border:1px solid rgba(0,255,255,0.08);border-radius:10px;padding:10px;font-size:12px;line-height:2;color:#888;">Waiting for camera...</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê REMINDERS ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accRem')">
        <div><div class="acc-title">‚è∞ Reminders</div><div class="acc-sub" id="remSubLbl">0 reminders set</div></div>
        <div class="acc-arrow" id="arrRem">‚ñº</div>
      </div>
      <div class="acc-body" id="accRem">
        <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
          <input type="time" class="sinp" id="remTime" style="margin:0;flex:1;min-width:100px;">
          <input type="text" class="sinp" id="remTxt" placeholder="Reminder text..." style="margin:0;flex:2;min-width:120px;">
        </div>
        <button class="sbtn cy" onclick="addReminder()">+ Add Reminder</button>
        <div id="reminderList" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê FUN & GAMES ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accFun')">
        <div><div class="acc-title">üéÆ Fun & Games</div><div class="acc-sub">Joke ¬∑ Story ¬∑ Dance ¬∑ Trivia</div></div>
        <div class="acc-arrow" id="arrFun">‚ñº</div>
      </div>
      <div class="acc-body" id="accFun">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
          <button class="sbtn cy" style="margin:0;" onclick="tellJoke()">üòÇ Joke</button>
          <button class="sbtn" style="margin:0;background:var(--pur);color:#fff;" onclick="tellStory()">üìñ Story</button>
          <button class="sbtn" style="margin:0;background:var(--gr);color:#000;" onclick="robotDance()">üï∫ Dance</button>
          <button class="sbtn" style="margin:0;background:var(--gold);color:#000;" onclick="startTrivia()">üß© Trivia</button>
        </div>
        <div class="fun-result" id="funResult">Choose a fun activity!</div>
        <div id="triviaArea" style="display:none;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;font-family:'Orbitron',monospace;font-size:11px;color:var(--c);margin-bottom:8px;">
            <span>Score: <span id="tScore">0</span></span><span>Q <span id="tNum">1</span>/10</span>
          </div>
          <div id="tQuestion" style="font-size:15px;margin-bottom:10px;min-height:46px;line-height:1.6;"></div>
          <div id="tOptions"></div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="sbtn cy" style="margin:0;flex:1;" onclick="nextTrivia()">NEXT ‚ñ∂</button>
            <button class="sbtn gray" style="margin:0;flex:1;" onclick="document.getElementById('triviaArea').style.display='none'">CLOSE</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê REPORTS & LOGS ‚ïê‚ïê -->
    <div class="acc-wrap">
      <div class="acc-head" onclick="toggleAcc('accReports')">
        <div><div class="acc-title">üìä Reports & Logs</div><div class="acc-sub">Session stats ¬∑ AI report ¬∑ Movement log</div></div>
        <div class="acc-arrow" id="arrReports">‚ñº</div>
      </div>
      <div class="acc-body" id="accReports">
        <!-- STATS -->
        <div id="statsBlock" style="background:rgba(0,255,255,0.03);border-radius:10px;padding:12px;margin-bottom:8px;"></div>
        <button class="sbtn cy" onclick="generateReport()">üìù Generate AI Report</button>
        <div id="aiReportDiv" style="font-size:13px;color:#ccc;background:rgba(0,255,255,0.03);border-radius:10px;padding:12px;min-height:50px;line-height:1.8;margin-top:6px;display:none;"></div>

        <!-- AUTO PROFILE CARD -->
        <div id="profileCard" style="display:none;background:rgba(136,0,255,0.06);border:1px solid rgba(136,0,255,0.2);border-radius:10px;padding:12px;margin-bottom:10px;line-height:1.9;"></div>
        <button class="sbtn gray" onclick="clearProfile()" style="margin-bottom:8px;font-size:11px;">üóë Clear Learned Profile</button>

        <!-- EXPLICIT MEMORY (user-saved) -->
        <div style="font-size:12px;color:var(--c);font-weight:700;margin:14px 0 4px;">üß† Explicit Memory (User Saved)</div>
        <div style="font-size:11px;color:var(--g);margin-bottom:6px;">Things you told Bro AI to remember. Say "remember this" or "save this" during chat.</div>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <input type="text" class="sinp" id="newMemInput" placeholder="Add memory..." style="margin:0;flex:1;">
          <button onclick="addManualMem()" style="background:var(--c);color:#000;border:none;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;white-space:nowrap;">+ ADD</button>
        </div>
        <div id="memList" style="max-height:180px;overflow-y:auto;"></div>
        <button class="sbtn gray" onclick="clearAllMems()" style="margin-top:4px;">üóë Clear All Memories</button>

        <!-- SELF-LEARNED -->
        <div style="font-size:12px;color:var(--pur);font-weight:700;margin:14px 0 4px;">ü§ñ Self-Learned Facts</div>
        <div style="font-size:11px;color:var(--g);margin-bottom:6px;">Things Bro AI learned automatically from your conversations.</div>
        <div id="learnedList" style="max-height:140px;overflow-y:auto;"></div>
        <button class="sbtn gray" onclick="clearLearned()" style="margin-top:4px;">üóë Clear Learned Facts</button>

        <!-- LOGS -->
        <div style="font-size:11px;color:var(--c);font-weight:700;margin:14px 0 4px;">Movement Log</div>
        <div id="movLogDiv" style="max-height:80px;overflow-y:auto;background:rgba(0,255,255,0.02);border-radius:8px;padding:8px;"></div>
        <div style="font-size:11px;color:var(--c);font-weight:700;margin:10px 0 4px;">Detection Log</div>
        <div id="detLogDiv" style="max-height:80px;overflow-y:auto;background:rgba(0,255,255,0.02);border-radius:8px;padding:8px;"></div>
        <button class="sbtn gray" onclick="clearAllLogs()" style="margin-top:6px;">üóë Clear All Logs</button>
      </div>
    </div>

    <div style="height:20px;"></div>
  </div>
</div>
</div>

<!-- GLOBAL ALERT CONTAINER -->
<div id="globalAlert" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:rgba(255,0,0,0.93);color:#fff;font-family:'Orbitron',monospace;font-size:12px;letter-spacing:1px;padding:14px 16px;text-align:center;flex-direction:column;gap:8px;">
  <div id="globalAlertMsg">ALERT</div>
  <button onclick="dismissAlert()" style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:6px;padding:5px 16px;cursor:pointer;font-size:11px;">‚úï DISMISS</button>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODELS LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CONFIRMED WORKING on your Google AI Studio key ‚îÄ‚îÄ
// Ordered: high quota first ‚Üí save rate-limited ones for last
const MODELS=[
  // PRIORITY 1 ‚Äî Gemini/Gemma (highest daily quota)
  {name:'Gemma 3 27B',          p:'gemini',m:'gemma-3-27b-it',                      k:'g',  tier:10, rpd:14400},
  {name:'Gemma 3 12B',          p:'gemini',m:'gemma-3-12b-it',                      k:'g',  tier:9,  rpd:14400},
  {name:'Gemini 2.5 Flash',     p:'gemini',m:'gemini-2.5-flash-preview-04-17',      k:'g',  tier:8,  rpd:20},
  {name:'Gemini 2.5 Flash Lite',p:'gemini',m:'gemini-2.5-flash-lite-preview-06-17', k:'g',  tier:7,  rpd:20},
  // PRIORITY 2 ‚Äî Groq (extremely fast inference, free tier)
  {name:'Groq Llama 3.3 70B',   p:'groq',  m:'llama-3.3-70b-versatile',            k:'groq',tier:12, rpd:14400},
  {name:'Groq Llama 3.1 8B',    p:'groq',  m:'llama-3.1-8b-instant',               k:'groq',tier:11, rpd:14400},
  {name:'Groq Mixtral 8x7B',    p:'groq',  m:'mixtral-8x7b-32768',                 k:'groq',tier:10, rpd:14400},
  {name:'Groq Gemma2 9B',       p:'groq',  m:'gemma2-9b-it',                       k:'groq',tier:9,  rpd:14400},
  {name:'Groq DeepSeek R1 70B', p:'groq',  m:'deepseek-r1-distill-llama-70b',      k:'groq',tier:9,  rpd:1000},
  {name:'Groq Qwen QwQ 32B',    p:'groq',  m:'qwen-qwq-32b',                       k:'groq',tier:8,  rpd:1000},
  // PRIORITY 3 ‚Äî Mistral AI (fast, smart, paid key)
  {name:'Mistral Large 2',      p:'mistral',m:'mistral-large-latest',          k:'mis',tier:11,rpd:99999},
  {name:'Mistral Small 3.1',    p:'mistral',m:'mistral-small-latest',          k:'mis',tier:10,rpd:99999},
  {name:'Mistral Nemo',         p:'mistral',m:'open-mistral-nemo',             k:'mis',tier:9, rpd:99999},
  {name:'Codestral',            p:'mistral',m:'codestral-latest',              k:'mis',tier:8, rpd:99999},
  // PRIORITY 4 ‚Äî OpenRouter free
  {name:'Arcee Trinity Large',  p:'openrouter',m:'arcee-ai/trinity-large-preview:free', k:'or', tier:7, rpd:99999},
  {name:'Solar Pro 3',          p:'openrouter',m:'upstage/solar-pro2-preview:free',      k:'or', tier:6, rpd:99999},
  {name:'Step 3.5 Flash',       p:'openrouter',m:'stepfun/step-3-5-flash:free',           k:'or', tier:6, rpd:99999},
  {name:'Riverflow V2 Pro',     p:'openrouter',m:'sourceful/riverflow-v2-pro:free',       k:'or', tier:5, rpd:99999},
  {name:'Riverflow V2 Fast',    p:'openrouter',m:'sourceful/riverflow-v2-fast:free',      k:'or', tier:5, rpd:99999},
  {name:'LFM2.5 Thinking',      p:'openrouter',m:'liquid/lfm-2.5-1.2b-thinking:free',    k:'or', tier:4, rpd:99999},
  {name:'LFM2.5 Instruct',      p:'openrouter',m:'liquid/lfm-2.5-1.2b-instruct:free',    k:'or', tier:4, rpd:99999},
  // PRIORITY 4 ‚Äî HuggingFace
  {name:'MeowGPT-3.5',          p:'hf',   m:'cutycat2000x/MeowGPT-3.5',               k:'hf', tier:5, rpd:99999},
  {name:'MeowGPT-3',            p:'hf',   m:'cutycat2000x/MeowGPT-3',                 k:'hf', tier:4, rpd:99999},
  {name:'MeowGPT-ll3',          p:'hf',   m:'cutycat2000x/MeowGPT-ll3',               k:'hf', tier:4, rpd:99999},
  {name:'InterDiffusion-4.0',   p:'hf',   m:'cutycat2000x/InterDiffusion-4.0',        k:'hf', tier:3, rpd:99999},
  {name:'OmriX',                p:'hf',   m:'xlelords/omriX',                         k:'hf', tier:3, rpd:99999},
  // PRIORITY 5 ‚Äî Wisdom Gate
  {name:'MiniMax M2.5',         p:'wisdomgate',m:'minimax-m2.5:free',                 k:'wg', tier:5, rpd:99999},
  // PRIORITY 6 ‚Äî GitHub AI
  {name:'GPT-4o (GitHub)',       p:'github',m:'gpt-4o',                              k:'gh', tier:9, rpd:99999},
  {name:'GPT-4o Mini (GitHub)',  p:'github',m:'gpt-4o-mini',                         k:'gh', tier:8, rpd:99999},
  {name:'Llama 3.3 70B (GitHub)',p:'github',m:'meta-llama-3.3-70b-instruct',         k:'gh', tier:7, rpd:99999},
  {name:'DeepSeek R1 (GitHub)',  p:'github',m:'deepseek-r1',                         k:'gh', tier:6, rpd:99999},
  {name:'Phi-4 (GitHub)',        p:'github',m:'phi-4',                               k:'gh', tier:5, rpd:99999},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let keys     = JSON.parse(localStorage.getItem('bk')||'{}');
let sett     = JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"autoNav":true,"batAlert":true,"followPerson":false,"detection":true,"faceRec":true,"ocrMode":false,"gestureCtrl":false,"lookSpeak":true,"personality":"friendly","voiceSpeed":0.9,"lang":"en-US"}');
let mems        = JSON.parse(localStorage.getItem('bm')||'[]');
let selfLearned = JSON.parse(localStorage.getItem('bsl')||'[]');
let userProfile = (()=>{ try{ return JSON.parse(localStorage.getItem('bup'))||null; }catch(e){return null;} })()||{
  name:null,age:null,location:null,job:null,
  interests:[],dislikes:[],relationships:{},
  personality_notes:[],corrections:[],
  environment:{},routines:{},mood_patterns:{}
};
let skip     = JSON.parse(localStorage.getItem('bsk')||'{}');
let chats    = JSON.parse(localStorage.getItem('bchats')||'[]');
let habits   = JSON.parse(localStorage.getItem('bhab')||'{}');
let knownFaces   = JSON.parse(localStorage.getItem('bfaces')||'[]');
let unknownFaces = JSON.parse(localStorage.getItem('bunknown')||'[]');
let objectLog    = JSON.parse(localStorage.getItem('bobjlog')||'[]');
let reminders    = JSON.parse(localStorage.getItem('brem')||'[]');
let eIP      = localStorage.getItem('bi')||'';
let rOK=false, robotSpeed=50;
let intruderAlertRunning=false;

// Voice
let botVoiceOn=false;
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;

// Eyes
let eyeT=null, blinkT=null;

// Background systems
let bgCamOn=false, bgStream=null;
let bgDetectT=null, bgMotionT=null, bgEmergT=null;
let bgPrevFrame=null, bgAlertCooldown=0;
let bgGuardOn=true, bgEmergOn=true;
let cocoModel=null, mlReady=false;

// Navigation
let isIdle=false, lastActiveTime=Date.now();
let idleCheckT=null, autoNavT=null;
let patrolT=null, wallT=null, mazeT=null;
let pathRecording=false, recordedPath=[], startPos={x:0,y:0,h:0}, curPos={x:0,y:0,h:0};

// Stats
let stats={obstacles:0,detections:0,faces:0,people:0,motionAlerts:0,cmds:0,sessionStart:Date.now()};
let movLog=[], detLog=[];

// Chat
let curChatId=null, chatMsgCount=0;

// Trivia
const TRIVIA=[
  {q:'What is the capital of France?',opts:['London','Berlin','Paris','Madrid'],a:2},
  {q:'How many planets in our solar system?',opts:['7','8','9','10'],a:1},
  {q:'What is 15 √ó 12?',opts:['150','170','180','160'],a:2},
  {q:'Who invented the telephone?',opts:['Edison','Bell','Tesla','Marconi'],a:1},
  {q:'Largest ocean on Earth?',opts:['Atlantic','Indian','Arctic','Pacific'],a:3},
  {q:'What gas do plants absorb?',opts:['Oxygen','Nitrogen','CO2','Hydrogen'],a:2},
  {q:'Sides of a hexagon?',opts:['5','6','7','8'],a:1},
  {q:'Fastest land animal?',opts:['Lion','Cheetah','Leopard','Horse'],a:1},
  {q:'WW2 ended in?',opts:['1943','1944','1945','1946'],a:2},
  {q:'H2O is commonly called?',opts:['Salt','Water','Oxygen','Acid'],a:1},
];
let triviaIdx=0, triviaScore=0;

(()=>{
  const t=+localStorage.getItem('bskt')||0;
  if(Date.now()-t>3600000){skip={};localStorage.setItem('bsk','{}');localStorage.setItem('bskt',''+Date.now());console.log('[AI] Hourly quota reset');}
  // Per-model: clear skips older than 24hrs
  const st=JSON.parse(localStorage.getItem('bsktimes')||'{}');
  let ch=false;
  Object.keys(skip).forEach(k=>{if(st[k]&&Date.now()-st[k]>86400000){delete skip[k];delete st[k];ch=true;}});
  if(ch){localStorage.setItem('bsk',JSON.stringify(skip));localStorage.setItem('bsktimes',JSON.stringify(st));}
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='faceScreen') startEyes();
  else stopEyes();
  if(id==='chatScreen') renderSidebar();
  if(id==='settingsScreen') loadSettUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getBest(){return[...MODELS].filter(m=>keys[m.k]&&!skip[m.name]).sort((a,b)=>b.tier-a.tier);}

async function callAI(msg, cb, sys){
  const pers = sett.personality||'friendly';
  adaptPersonality();
  const system = buildSystemContext(pers, sys);
  const proactive = getProactiveContext(msg);
  const fullMsg = proactive ? '[Context: '+proactive+'] '+msg : msg;
  detectCorrection(msg);

  // ‚ïê‚ïê PRIORITY 0: PUTER.JS (free, no key needed) ‚ïê‚ïê
  if(puterReady && typeof puter !== 'undefined'){
    try{
      const model = sett.puterModel||'gpt-4o-mini';
      setModelBadge('‚ú¶ '+model.split('/').pop().substring(0,18));
      const res = await puter.ai.chat(system+'\nUser: '+fullMsg, {model});
      const txt = typeof res==='string' ? res : (res?.message?.content||res?.content||res?.text||null);
      if(txt?.trim().length>1){ learnHabit(msg); autoLearn(msg,txt.trim()); learnPattern(msg,'chat'); stats.cmds++; cb(txt.trim()); return; }
    }catch(e){ console.log('[Puter]',e.message); }
  }

  // ‚ïê‚ïê PRIORITY 1-6: Model fallback chain ‚ïê‚ïê
  const models = [...MODELS]
    .filter(m => keys[m.k] && !skip[m.name])
    .sort((a,b) => b.tier - a.tier);

  if(!models.length){
    const haveKeys = MODELS.some(m=>keys[m.k]);
    if(!haveKeys) cb('No API key set. Go to Settings ‚Üí API Keys and add your Groq or Gemini key.');
    else cb('All models hit quota. Go to Settings ‚Üí AI Models ‚Üí Reset Quota Skips, then try again.');
    return;
  }

  for(const mdl of models){
    setModelBadge(mdl.name.substring(0,20));
    try{
      let url, body, headers = {'Content-Type':'application/json'};

      if(mdl.p==='gemini'){
        url = 'https://generativelanguage.googleapis.com/v1beta/models/'+mdl.m+':generateContent?key='+keys[mdl.k];
        body = JSON.stringify({contents:[{parts:[{text:system+'\nUser: '+fullMsg}]}]});

      } else if(mdl.p==='groq'){
        url = 'https://api.groq.com/openai/v1/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        body = JSON.stringify({model:mdl.m, messages:[{role:'system',content:system},{role:'user',content:fullMsg}], max_tokens:600, temperature:0.7, stream:false});

      } else if(mdl.p==='openrouter'){
        url = 'https://openrouter.ai/api/v1/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        headers['HTTP-Referer'] = 'https://broai.app';
        headers['X-Title'] = 'Bro AI';
        body = JSON.stringify({model:mdl.m, messages:[{role:'system',content:system},{role:'user',content:fullMsg}], max_tokens:600});

      } else if(mdl.p==='hf'){
        url = 'https://api-inference.huggingface.co/models/'+mdl.m+'/v1/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        body = JSON.stringify({messages:[{role:'user',content:fullMsg}], max_tokens:500, stream:false});

      } else if(mdl.p==='mistral'){
        url = 'https://api.mistral.ai/v1/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        const mistralMdl=sett.mistralModel||mdl.m;
        body = JSON.stringify({model:mistralMdl, messages:[{role:'system',content:system},{role:'user',content:fullMsg}], max_tokens:600, temperature:0.7});

      } else if(mdl.p==='wisdomgate'){
        url = 'https://api.wisdomgate.io/v1/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        body = JSON.stringify({model:mdl.m, messages:[{role:'system',content:system},{role:'user',content:fullMsg}], max_tokens:600});

      } else if(mdl.p==='github'){
        url = 'https://models.inference.ai.azure.com/chat/completions';
        headers['Authorization'] = 'Bearer '+keys[mdl.k];
        body = JSON.stringify({model:mdl.m, messages:[{role:'system',content:system},{role:'user',content:fullMsg}], max_tokens:600});
      }

      const r = await fetch(url, {method:'POST', headers, body, signal:AbortSignal.timeout(20000)});

      if(r.status===429||r.status===402){
        skip[mdl.name]=true; localStorage.setItem('bsk',JSON.stringify(skip));
        console.log('[AI] quota/billing skip:',mdl.name); continue;
      }
      if(r.status===404){
        skip[mdl.name]=true; localStorage.setItem('bsk',JSON.stringify(skip));
        console.log('[AI] 404 not enabled:',mdl.name); continue;
      }
      if(!r.ok){ console.log('[AI]',r.status,'on',mdl.name); continue; }

      const d = await r.json();
      let txt;
      if(mdl.p==='gemini') txt = d?.candidates?.[0]?.content?.parts?.[0]?.text;
      else txt = d?.choices?.[0]?.message?.content;

      if(txt?.trim().length>1){
        learnHabit(msg);
        autoLearn(msg, txt.trim());
        learnPattern(msg, 'chat');
        stats.cmds++;
        cb(txt.trim());
        return;
      }
      console.log('[AI] empty from',mdl.name);
    }catch(e){ console.log('[AI] catch',mdl.name,':',e.message); continue; }
  }

  // All failed
  const skippedAll = MODELS.filter(m=>keys[m.k]&&skip[m.name]).length;
  const withKeys   = MODELS.filter(m=>keys[m.k]).length;
  if(skippedAll>=withKeys) cb('All models hit quota. Tap Reset Quota in Settings ‚Üí AI Models.');
  else cb('Could not reach AI. Check internet connection.');
}

function setModelBadge(txt){
  const el=document.getElementById('modelBadge');
  if(el){el.textContent=txt;el.className='mbadge';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HABIT LEARNING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function learnHabit(msg){
  const h=new Date().getHours();
  const p=h<12?'morning':h<17?'afternoon':'evening';
  habits[p]=(habits[p]||'')+(msg.substring(0,20)+'|');
  if(habits[p].length>200) habits[p]=habits[p].slice(-200);
  localStorage.setItem('bhab',JSON.stringify(habits));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TTS ‚Äî Jarvis British Voice
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanTxt(t){
  return t.replace(/[\u{1F000}-\u{1FFFF}]/gu,'').replace(/[\u2600-\u27FF]/g,'')
    .replace(/\[.*?\]/g,'').replace(/broai/gi,'Bro AI').replace(/brobot/gi,'Bro Bot')
    .trim().substring(0,400);
}
function getBritishVoice(){
  const v=window.speechSynthesis?.getVoices()||[];
  for(const n of['Google UK English Male','Microsoft George','Microsoft Ryan','Daniel','Arthur']){
    const f=v.find(x=>x.name===n||x.name.startsWith(n));if(f)return f;
  }
  return v.find(x=>x.lang==='en-GB')||v.find(x=>x.lang.startsWith('en'))||v[0];
}
async function speak(text,onDone){
  if(!text) return;
  const c=cleanTxt(text);if(!c){onDone?.();return;}
  // Try Puter TTS first (better quality) if enabled
  if(sett.puterTTS && puterReady && typeof puter!=='undefined'){
    try{
      const audio=await puter.ai.txt2speech(c);
      if(audio){audio.onended=()=>onDone?.();audio.onerror=()=>browserSpeak(c,onDone);audio.play();return;}
    }catch(e){ console.log('[Puter TTS]',e.message); }
  }
  browserSpeak(c,onDone);
}
function browserSpeak(c,onDone){
  if(!window.speechSynthesis){onDone?.();return;}
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(c);
  u.lang=sett.lang||'en-US';u.rate=parseFloat(sett.voiceSpeed)||0.9;u.pitch=0.85;u.volume=1;
  u.onend=()=>onDone?.();u.onerror=()=>onDone?.();
  const go=()=>{const v=getBritishVoice();if(v)u.voice=v;window.speechSynthesis.speak(u);};
  if(window.speechSynthesis.getVoices().length) go();
  else{
    if('onvoiceschanged' in window.speechSynthesis) window.speechSynthesis.onvoiceschanged=()=>{go();window.speechSynthesis.onvoiceschanged=null;};
    setTimeout(go,300);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EYES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startEyes(){
  stopEyes();
  blinkT=setInterval(()=>{
    ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
      const e=document.getElementById(id);if(!e)return;
      e.classList.add('blink');setTimeout(()=>e.classList.remove('blink'),150);
    });
  },3000+Math.random()*2000);
  eyeT=setInterval(()=>{
    const x=(Math.random()-0.5)*16,y=(Math.random()-0.5)*12;
    ['pupL','pupR','fsPupL','fsPupR'].forEach(id=>{
      const p=document.getElementById(id);if(!p)return;
      p.style.transform=`translate(calc(-50% + ${x}px),calc(-50% + ${y}px))`;
      setTimeout(()=>p.style.transform='translate(-50%,-50%)',700);
    });
  },2500+Math.random()*1200);
}
function stopEyes(){clearInterval(blinkT);clearInterval(eyeT);}

function setEmotion(text){
  const t=text.toLowerCase();
  let col='#00FFFF',sh='rgba(0,255,255,0.8)',emo='NEUTRAL';
  if(/happy|great|awesome|love|wonderful/.test(t)){col='#00FF88';sh='rgba(0,255,136,0.8)';emo='HAPPY';}
  else if(/sorry|fail|error/.test(t)){col='#FF8800';sh='rgba(255,136,0,0.8)';emo='CONCERNED';}
  else if(/think|hmm|calculating|processing/.test(t)){col='#8800FF';sh='rgba(136,0,255,0.8)';emo='THINKING';}
  else if(/alert|danger|intruder|warning|emergency/.test(t)){col='#FF4444';sh='rgba(255,68,68,0.8)';emo='ALERT';}
  else if(/curious|interesting|wow/.test(t)){col='#FFD700';sh='rgba(255,215,0,0.8)';emo='CURIOUS';}
  ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
    const e=document.getElementById(id);if(!e)return;
    e.style.background=col;e.style.boxShadow='0 0 40px '+sh;
  });
  ['emoLbl','fsEmo'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=emo;});
}
function resetToNeutral(){
  // Always call this after alert sequences to restore eyes
  ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
    const e=document.getElementById(id);if(!e)return;
    e.style.background='#00FFFF';e.style.boxShadow='0 0 40px rgba(0,255,255,0.8)';
  });
  ['emoLbl','fsEmo'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent='NEUTRAL';});
}
function setSub(t){
  const c=cleanTxt(t).substring(0,140);
  ['subTxt','fsSub'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=c;});
}
function setListenLbl(t){['listenLbl','fsListen'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=t;});}
function openFS(){document.getElementById('fsOverlay').classList.add('show');}
function closeFS(){document.getElementById('fsOverlay').classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleVoice(){botVoiceOn?stopVoice():startVoice();}
function startVoice(){
  if(!SR){alert('Voice requires Chrome browser!');return;}
  botVoiceOn=true;
  const btn=document.getElementById('voiceBtn');
  btn.textContent='üî¥ ON';btn.style.background='rgba(255,68,68,0.2)';btn.style.color='var(--r)';btn.style.border='1px solid var(--r)';
  document.getElementById('voiceStatus').textContent='ON';document.getElementById('voiceStatus').style.color='var(--gr)';
  setPill('pillVoice',true);setListenLbl('‚óè LISTENING...');
  startIdleWatch();
  startBgEmergency();
  // Auto-start front cam when voice turns ON
  if(!bgCamOn) toggleBgCam();
  if(bgCamOn){
    if(sett.detection) startBgDetection();
    startBgMotion();
  }
  listenLoop();
}
function stopVoice(){
  botVoiceOn=false;clearInterval(idleCheckT);stopAutoNav();
  // Stop background detection when voice OFF
  clearInterval(bgDetectT);clearInterval(bgMotionT);
  setPill('pillDetect',false);setPill('pillGuard',false);setPill('pillNav',false);
  const btn=document.getElementById('voiceBtn');
  btn.textContent='üé§ VOICE';btn.style.background='var(--c)';btn.style.color='#000';btn.style.border='none';
  document.getElementById('voiceStatus').textContent='OFF';document.getElementById('voiceStatus').style.color='var(--g)';
  setPill('pillVoice',false);setListenLbl('');
  // Stop bg cam + detection when voice turns OFF
  if(bgCamOn) toggleBgCam();
  stopBgDetection();
  clearInterval(bgMotionT);setPill('pillGuard',false);
  clearInterval(bgDetectT);setPill('pillDetect',false);
  bgPrevFrame=null;
}
function listenLoop(){
  if(!botVoiceOn) return;
  if(intruderAlertRunning) return; // wait for alert sequence to finish
  let got=false;
  const r=new SR();
  r.lang=sett.lang||'en-US';r.continuous=false;r.interimResults=false;r.maxAlternatives=1;
  r.onresult=(e)=>{
    got=true;resetIdle();
    const cmd=e.results[0][0].transcript.trim();
    if(!cmd||cmd.length<2){if(botVoiceOn)setTimeout(listenLoop,400);return;}
    if(/disable voice|stop listening/i.test(cmd)){setSub('Voice off.');speak('Voice disabled.',stopVoice);return;}
    setListenLbl('‚óè THINKING...');setSub('Thinking...');setEmotion('thinking');
    callAI(cmd,(reply)=>{
      setSub(reply);setEmotion(reply);handleRobotCmds(reply);
      saveMem(reply.substring(0,200));
      setListenLbl('‚óè SPEAKING...');
      speak(reply,()=>{setListenLbl('‚óè LISTENING...');if(botVoiceOn)setTimeout(listenLoop,500);});
    });
  };
  r.onerror=()=>{if(botVoiceOn)setTimeout(listenLoop,1000);};
  r.onend=()=>{if(!got&&botVoiceOn)setTimeout(listenLoop,400);};
  try{r.start();}catch(ex){if(botVoiceOn)setTimeout(listenLoop,1500);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKGROUND CAMERA (face screen)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function toggleBgCam(){
  if(bgCamOn){
    bgStream?.getTracks().forEach(t=>t.stop());
    bgStream=null;bgCamOn=false;
    document.getElementById('camBtn').textContent='üì∑ CAM';
    stopBgDetection();
  } else {
    try{
      bgStream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'user',width:{ideal:320},height:{ideal:240}},audio:false
      });
      const v=document.getElementById('bgCamVideo');
      v.srcObject=bgStream;bgCamOn=true;
      document.getElementById('camBtn').textContent='üì∑ ON';
      v.onloadedmetadata=()=>{
        const c=document.getElementById('bgCanvas');
        c.width=v.videoWidth;c.height=v.videoHeight;
        // Only auto-start if voice is already on
        if(botVoiceOn){
          if(sett.detection) startBgDetection();
          startBgMotion();
        }
      };
    }catch(e){
      setSub('Camera error: '+e.message);
    }
  }
}

// ‚îÄ‚îÄ Background ML Detection ‚îÄ‚îÄ

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VISION ENGINE v2 ‚Äî Face-API.js + COCO-SSD + MediaPipe Hands
//   ‚Ä¢ Real on-device face recognition (Face-API.js)
//   ‚Ä¢ Object detection with bounding boxes (COCO-SSD)
//   ‚Ä¢ Gesture control (MediaPipe Hands)
//   ‚Ä¢ Camera flip (front/rear)
//   ‚Ä¢ AI vision queries (Puter / Gemini)
//   ‚Ä¢ Registered face auto-upgrade from live captures
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let visionStream      = null;
let visionOn          = false;
let visionFacing      = 'user';          // 'user'=front, 'environment'=rear
let visionDetectLoop  = null;
let visionFaceLoop    = null;
let visionHandsLoop   = null;
let visionLastFrame   = null;
let visionDetections  = [];
let visionPanelOpen   = false;

// Face-API state
let faceApiReady      = false;
let faceDescriptors   = [];   // [{name, descriptor, matcher}]

// MediaPipe Hands state
let mpHands           = null;
let mpHandsReady      = false;
let lastGesture       = null;
let lastGestureTime   = 0;
let gestureCooldown   = 1500; // ms between gesture triggers

// Colors for boxes
const DET_COLORS = {
  known:    '#00ffff',
  intruder: '#ff3333',
  person:   '#00ff88',
  object:   '#ffaa00',
  gesture:  '#cc44ff',
};

// ‚îÄ‚îÄ Panel Toggle ‚îÄ‚îÄ
function toggleVisionPanel(){
  visionPanelOpen = !visionPanelOpen;
  const panel = document.getElementById('visionPanel');
  const area  = document.getElementById('faceArea');
  const btn   = document.getElementById('visionToggleBtn');
  if(visionPanelOpen){
    panel.classList.add('open');
    area.classList.add('shrunk');
    if(btn) btn.classList.add('active');
    // Auto-start camera when opened
    if(!visionOn) startVisionCam();
  } else {
    panel.classList.remove('open');
    area.classList.remove('shrunk');
    if(btn) btn.classList.remove('active');
    stopVisionCam();
  }
}

// ‚îÄ‚îÄ Camera Controls ‚îÄ‚îÄ
async function toggleVisionCam(){
  if(visionOn) stopVisionCam();
  else await startVisionCam();
}

async function flipVisionCam(){
  visionFacing = visionFacing==='user' ? 'environment' : 'user';
  if(visionOn){ stopVisionCam(); await startVisionCam(); }
}

async function startVisionCam(){
  const noStream = document.getElementById('visionNoStream');
  const startBtn = document.getElementById('visionStartBtn');
  try{
    if(noStream) noStream.style.display='none';
    visionStream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:visionFacing, width:{ideal:640}, height:{ideal:480} },
      audio:false
    });
    const vid = document.getElementById('visionVideo');
    vid.srcObject = visionStream;
    await vid.play();
    visionOn = true;
    if(startBtn){ startBtn.textContent='‚èπ STOP'; startBtn.className='running'; }
    vid.onloadedmetadata = ()=>{
      const cv = document.getElementById('visionOverlay');
      if(cv){ cv.width=vid.videoWidth; cv.height=vid.videoHeight; }
    };
    // Load Face-API models if not done
    if(!faceApiReady) loadFaceApi();
    // Load MediaPipe Hands
    if(!mpHandsReady) loadMediaPipeHands();
    startVisionLoops();
  }catch(e){
    console.log('[VisionCam]',e.message);
    if(noStream){ noStream.textContent='Camera error: '+e.message; noStream.style.display='flex'; }
  }
}

function stopVisionCam(){
  visionOn = false;
  if(visionStream){ visionStream.getTracks().forEach(t=>t.stop()); visionStream=null; }
  clearInterval(visionDetectLoop);
  clearInterval(visionFaceLoop);
  clearInterval(visionHandsLoop);
  visionDetectLoop=null; visionFaceLoop=null; visionHandsLoop=null;
  const btn = document.getElementById('visionStartBtn');
  if(btn){ btn.textContent='‚ñ∂ START'; btn.className=''; }
  const ns = document.getElementById('visionNoStream');
  if(ns){ ns.textContent='üëÅ TAP START'; ns.style.display='flex'; }
  const cv = document.getElementById('visionOverlay');
  if(cv){ const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height); }
  updateVisionPanel([]);
}

function startVisionLoops(){
  clearInterval(visionDetectLoop);
  clearInterval(visionFaceLoop);
  // COCO-SSD: every 400ms
  visionDetectLoop = setInterval(runVisionDetect, 400);
  // Face recognition: every 2s (Face-API is fast)
  visionFaceLoop = setInterval(runFaceRecognition, 2000);
  // Gesture: every 200ms
  visionHandsLoop = setInterval(runGestureDetect, 200);
}

// ‚îÄ‚îÄ Face-API.js Loading ‚îÄ‚îÄ
async function loadFaceApi(){
  const statusEl = document.getElementById('visionMLStatus');
  if(typeof faceapi === 'undefined'){
    if(statusEl){ statusEl.textContent='FACE-API OFFLINE'; statusEl.style.color='var(--o)'; }
    console.warn('[FaceAPI] Library not loaded ‚Äî using AI fallback for face recognition');
    return;
  }
  try{
    if(statusEl) statusEl.textContent='LOADING FACE MODELS...';
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
    ]);
    faceApiReady = true;
    if(statusEl){ statusEl.textContent='‚úì FACE-API'; statusEl.style.color='var(--gr)'; }
    
    // Build face descriptors from registered faces
    await buildFaceDescriptors();
  }catch(e){
    console.log('[FaceAPI load]',e.message);
    if(statusEl){ statusEl.textContent='FACE-API ERR'; statusEl.style.color='var(--r)'; }
  }
}

// Build descriptor database from registered face photos
async function buildFaceDescriptors(){
  if(!faceApiReady || !knownFaces.length) return;
  faceDescriptors = [];
  for(const face of knownFaces){
    try{
      const imgs = face.imgs || (face.img ? [face.img] : []);
      const descriptors = [];
      for(const imgSrc of imgs.slice(0,5)){
        const img = await loadImgFromBase64(imgSrc);
        const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks(true).withFaceDescriptor();
        if(det) descriptors.push(det.descriptor);
      }
      if(descriptors.length){
        const matcher = new faceapi.FaceMatcher(
          [new faceapi.LabeledFaceDescriptors(face.name, descriptors)], 0.5);
        faceDescriptors.push({ name:face.name, matcher, callName:face.callName, relation:face.relation });
        console.log(`[FaceAPI] Built descriptor for ${face.name} (${descriptors.length} samples)`);
      }
    }catch(e){ console.log('[FaceAPI build]',face.name,e.message); }
  }
  console.log('[FaceAPI] Ready with',faceDescriptors.length,'known faces');
}

function loadImgFromBase64(src){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = src;
  });
}

// ‚îÄ‚îÄ COCO-SSD Object Detection ‚îÄ‚îÄ
async function runVisionDetect(){
  if(!visionOn) return;
  const vid = document.getElementById('visionVideo');
  const cv  = document.getElementById('visionOverlay');
  if(!vid||!cv||!vid.videoWidth) return;

  // Capture frame
  const snap = document.createElement('canvas');
  snap.width=320; snap.height=240;
  snap.getContext('2d').drawImage(vid,0,0,320,240);
  visionLastFrame = snap.toDataURL('image/jpeg',0.7);

  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);

  let dets = [];

  if(mlReady && cocoModel){
    try{
      const preds = await cocoModel.detect(vid);
      const scX = cv.width/vid.videoWidth;
      const scY = cv.height/vid.videoHeight;
      preds.forEach(p=>{
        const [x,y,w,h] = p.bbox;
        const isPerson = p.class==='person';
        dets.push({
          class:p.class, type:isPerson?'person':'object',
          conf:Math.round(p.score*100),
          x:x*scX, y:y*scY, w:w*scX, h:h*scY,
          label:p.class, status:isPerson?'person':'object',
          color:isPerson?DET_COLORS.person:DET_COLORS.object
        });
        // Log to object log
        if(!objectLog.find(o=>o.name===p.class&&Date.now()-o.time<30000)){
          objectLog.unshift({name:p.class,conf:Math.round(p.score*100),time:Date.now(),ts:new Date().toLocaleTimeString()});
          if(objectLog.length>100) objectLog.splice(100);
        }
      });
      stats.detections += preds.length;
      const pc = dets.filter(d=>d.type==='person').length;
      if(pc>0){ stats.faces++; stats.people=Math.max(stats.people,pc); learnPattern('camera_person','vision'); }
      visionDetections = dets;
    }catch(e){ console.log('[COCO]',e.message); }
  }

  drawBoxes(ctx, visionDetections);
  updateVisionPanel(visionDetections);
}

// ‚îÄ‚îÄ Face-API Recognition ‚îÄ‚îÄ
async function runFaceRecognition(){
  if(!visionOn||!faceApiReady) return;
  const vid = document.getElementById('visionVideo');
  const cv  = document.getElementById('visionOverlay');
  if(!vid||!cv||!vid.videoWidth) return;

  try{
    const detections = await faceapi
      .detectAllFaces(vid, new faceapi.TinyFaceDetectorOptions({inputSize:320,scoreThreshold:0.4}))
      .withFaceLandmarks(true)
      .withFaceDescriptors();

    if(!detections.length) return;

    const scX = cv.width/vid.videoWidth;
    const scY = cv.height/vid.videoHeight;
    const ctx = cv.getContext('2d');
    ctx.clearRect(0,0,cv.width,cv.height);

    // First redraw object (non-person) boxes
    drawBoxes(ctx, visionDetections.filter(d=>d.type!=='person'));

    const updatedDets = [...visionDetections.filter(d=>d.type!=='person')];

    for(const det of detections){
      const box = det.detection.box;
      const bx=box.x*scX, by=box.y*scY, bw=box.width*scX, bh=box.height*scY;

      let label='PERSON', status='person', color=DET_COLORS.person;
      let matchedFace = null;

      // Try Face-API matching first (fast, on-device)
      if(faceDescriptors.length){
        let bestMatch = null, bestDist = 1.0;
        for(const fd of faceDescriptors){
          const match = fd.matcher.findBestMatch(det.descriptor);
          if(match.label !== 'unknown' && match.distance < bestDist){
            bestDist = match.distance;
            bestMatch = fd;
          }
        }
        if(bestMatch && bestDist < 0.5){
          label = bestMatch.callName || bestMatch.name;
          status = 'known'; color = DET_COLORS.known;
          matchedFace = bestMatch;
          addDetLog('Face: '+bestMatch.name+' ('+Math.round((1-bestDist)*100)+'%)');
          // Auto-upgrade: save this frame crop as additional training sample
          autoUpgradeFaceSample(vid, box, bestMatch.name);
        } else {
          // Unknown ‚Äî check with AI for confirmation (every 15s)
          if(Date.now()-faceRecCooldown > 15000){
            faceRecCooldown = Date.now();
            confirmUnknownWithAI();
          }
          label='INTRUDER'; status='intruder'; color=DET_COLORS.intruder;
          if(bgGuardOn && Date.now()-bgAlertCooldown>15000){
            const hr=new Date().getHours();
            if(!sett.guardNight||(hr>=22||hr<7)){bgAlertCooldown=Date.now(); onIntruder(100);}
          }
        }
      } else {
        // No registered faces ‚Äî use AI fallback
        if(Date.now()-faceRecCooldown>10000){
          faceRecCooldown=Date.now();
          runVisionFaceAI();
        }
      }

      updatedDets.push({class:'person',type:'person',conf:Math.round(det.detection.score*100),
        x:bx,y:by,w:bw,h:bh,label,status,color});
    }

    visionDetections = updatedDets;
    drawBoxes(ctx, visionDetections);
    updateVisionPanel(visionDetections);

  }catch(e){ console.log('[FaceRec]',e.message); }
}

// Auto-upgrade: add new face crop to training set when recognized
let upgradeCount = {};
async function autoUpgradeFaceSample(vid, box, name){
  if(!faceApiReady) return;
  upgradeCount[name] = (upgradeCount[name]||0)+1;
  // Only upgrade every 30 detections to avoid too many samples
  if(upgradeCount[name] % 30 !== 0) return;
  const faceEntry = knownFaces.find(f=>f.name===name);
  if(!faceEntry) return;
  // Crop face from video
  const cv2 = document.createElement('canvas');
  cv2.width=112; cv2.height=112;
  const ctx2=cv2.getContext('2d');
  const pad=20;
  ctx2.drawImage(vid, Math.max(0,box.x-pad), Math.max(0,box.y-pad),
    box.width+pad*2, box.height+pad*2, 0,0,112,112);
  const crop = cv2.toDataURL('image/jpeg',0.8);
  if(!faceEntry.imgs) faceEntry.imgs=[faceEntry.img].filter(Boolean);
  if(faceEntry.imgs.length < 10){
    faceEntry.imgs.push(crop);
    localStorage.setItem('bfaces',JSON.stringify(knownFaces));
    // Rebuild descriptor with new sample
    await buildFaceDescriptors();
    console.log('[FaceAPI] Auto-upgraded',name,'now has',faceEntry.imgs.length,'samples');
  }
}

// AI fallback for face recognition (when Face-API has no registered faces)
async function runVisionFaceAI(){
  if(!visionLastFrame) return;
  const personDets = visionDetections.filter(d=>d.type==='person');
  if(!personDets.length) return;
  try{
    const faceNames = knownFaces.map(f=>f.name+(f.nickname?' ('+f.nickname+')':'')).join(', ');
    const hasKnown = knownFaces.length>0;
    const prompt = hasKnown
      ? 'Known people: '+faceNames+'. For each person in image return ONLY JSON array: [{"i":0,"status":"KNOWN","name":"..."}] or UNKNOWN. JSON only.'
      : 'Are there people? Return ONLY: [{"i":0,"status":"UNKNOWN"}] or []. JSON only.';
    let result=null;
    if(puterReady&&typeof puter!=='undefined'){
      try{
        const res=await puter.ai.chat([{role:'user',content:[
          {type:'image_url',image_url:{url:visionLastFrame}},{type:'text',text:prompt}
        ]}],{model:'gpt-4o-mini'});
        result=parseVisionJSON(typeof res==='string'?res:(res?.message?.content||''));
      }catch(e){}
    }
    if(!result&&keys.g){
      const parts=knownFaces.slice(0,2).filter(f=>f.img).map(f=>({inline_data:{mime_type:'image/jpeg',data:f.img.split(',')[1]}}));
      parts.push({inline_data:{mime_type:'image/jpeg',data:visionLastFrame.split(',')[1]}});
      parts.push({text:hasKnown?'Known: '+faceNames+'. JSON only: [{"i":0,"status":"KNOWN","name":"..."}] or UNKNOWN.':prompt});
      try{
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key='+keys.g,
          {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}]}),signal:AbortSignal.timeout(10000)});
        if(r.ok){const d=await r.json();result=parseVisionJSON(d?.candidates?.[0]?.content?.parts?.[0]?.text||'');}
      }catch(e){}
    }
    if(result&&Array.isArray(result)){
      const cv=document.getElementById('visionOverlay');if(!cv)return;
      const ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);
      let pi=0;
      visionDetections=visionDetections.map(det=>{
        if(det.type!=='person') return det;
        const ai=result[pi++]; if(!ai) return det;
        if(ai.status==='KNOWN'&&ai.name){
          const face=knownFaces.find(f=>f.name.toUpperCase()===ai.name.toUpperCase())||knownFaces[0];
          return {...det,label:face?.callName||face?.name||ai.name,status:'known',color:DET_COLORS.known};
        }
        if(bgGuardOn&&Date.now()-bgAlertCooldown>15000){bgAlertCooldown=Date.now();onIntruder(100);}
        return {...det,label:'INTRUDER',status:'intruder',color:DET_COLORS.intruder};
      });
      drawBoxes(ctx,visionDetections);
      updateVisionPanel(visionDetections);
    }
  }catch(e){console.log('[VisionFaceAI]',e.message);}
}

async function confirmUnknownWithAI(){
  // Quick AI check when Face-API says unknown but we have registered faces
  if(!visionLastFrame||!knownFaces.length) return;
  const names=knownFaces.map(f=>f.name).join(', ');
  const prompt='Is the person in this image one of these known people: '+names+'? Reply ONLY: YES:<name> or NO.';
  let ans=null;
  if(puterReady&&typeof puter!=='undefined'){
    try{
      const res=await puter.ai.chat([{role:'user',content:[{type:'image_url',image_url:{url:visionLastFrame}},{type:'text',text:prompt}]}],{model:'gpt-4o-mini'});
      ans=(typeof res==='string'?res:(res?.message?.content||'')).trim();
    }catch(e){}
  }
  if(ans&&ans.startsWith('YES:')){
    const name=ans.replace('YES:','').trim();
    const face=knownFaces.find(f=>f.name.toUpperCase()===name.toUpperCase());
    if(face){
      // Add this image as a training sample to improve Face-API
      if(!face.imgs) face.imgs=[face.img].filter(Boolean);
      if(face.imgs.length<10){
        face.imgs.push(visionLastFrame);
        localStorage.setItem('bfaces',JSON.stringify(knownFaces));
        await buildFaceDescriptors();
        console.log('[AI Confirm] Added sample for',name);
      }
    }
  }
}

// ‚îÄ‚îÄ MediaPipe Hands ‚Äî Gesture Control ‚îÄ‚îÄ
async function loadMediaPipeHands(){
  // Gesture detection uses pixel-based skin analysis (no external lib needed)
  mpHandsReady = true;
  const gs=document.getElementById('visionGestureStatus');
  if(gs) gs.style.display='block';
}

async function runGestureDetect(){
  if(!visionOn||!faceApiReady) return;
  const vid=document.getElementById('visionVideo');
  if(!vid||!vid.videoWidth) return;

  try{
    // Detect hands using faceapi canvas + simple gesture from landmark positions
    // We analyze the full frame for hand-like movement patterns
    const snap=document.createElement('canvas');
    snap.width=160;snap.height=120;
    const sctx=snap.getContext('2d');
    sctx.drawImage(vid,0,0,160,120);
    const d=sctx.getImageData(0,0,160,120);

    // Detect skin-colored regions in upper portion (hand area)
    const gesture=detectGestureFromPixels(d,vid);
    if(gesture&&gesture!==lastGesture&&Date.now()-lastGestureTime>gestureCooldown){
      lastGesture=gesture; lastGestureTime=Date.now();
      handleGesture(gesture);
    }
  }catch(e){}
}

function detectGestureFromPixels(imgData, vid){
  // Simple skin detection + region analysis
  const d=imgData.data;const w=imgData.width;const h=imgData.height;
  let skinPixels=0,topSkin=0,bottomSkin=0,leftSkin=0,rightSkin=0;
  for(let i=0;i<d.length;i+=4){
    const r=d[i],g=d[i+1],b=d[i+2];
    // Skin color range (works for many skin tones)
    const isSkin=(r>60&&g>40&&b>20&&r>g&&r>b&&(r-g)>10&&r<250);
    if(isSkin){
      skinPixels++;
      const px=(i/4)%w, py=Math.floor((i/4)/w);
      if(py<h*0.4) topSkin++;
      else bottomSkin++;
      if(px<w*0.3) leftSkin++;
      if(px>w*0.7) rightSkin++;
    }
  }
  const total=w*h;
  const density=skinPixels/total;
  if(density<0.04) return null; // no hand visible

  // Classify gesture by distribution
  if(density>0.25) return 'palm';       // ‚úã open palm = large skin area
  if(topSkin>bottomSkin*2) return 'point';    // ‚òù pointing up
  if(leftSkin>rightSkin*2.5) return 'wave_l'; // üëã wave left
  if(rightSkin>leftSkin*2.5) return 'wave_r'; // üëã wave right
  if(density>0.12&&density<0.2) return 'thumbs'; // üëç medium coverage
  if(density>0.06&&density<0.1) return 'peace';  // ‚úå small coverage
  return null;
}

function handleGesture(gesture){
  const indicator=document.getElementById('gestureIndicator');
  let text='', action=null;

  switch(gesture){
    case 'wave_l':
    case 'wave_r':
      text='üëã WAKE'; action=()=>{ if(!botVoiceOn) toggleVoice(); speak('Hey! How can I help?'); }; break;
    case 'palm':
      text='‚úã STOP'; action=()=>{ espCmd({action:'stop'}); speak('Stopped.'); }; break;
    case 'thumbs':
      text='üëç YES'; action=()=>{ speak('Got it!'); setSub('Confirmed ‚úì'); }; break;
    case 'point':
      text='‚òù FORWARD'; action=()=>{ espCmd({action:'forward',speed:50}); speak('Moving forward.'); }; break;
    case 'peace':
      text='‚úå PHOTO'; action=()=>{ if(visionLastFrame) speak('Photo captured!'); }; break;
  }

  if(text&&action){
    if(indicator){ indicator.textContent=text; indicator.style.display='block'; setTimeout(()=>indicator.style.display='none',2000); }
    visionDetections.push({class:'gesture',type:'gesture',conf:80,x:0,y:0,w:0,h:0,label:text,status:'gesture',color:DET_COLORS.gesture});
    updateVisionPanel(visionDetections);
    action();
    addDetLog('Gesture: '+text);
  }
}

// ‚îÄ‚îÄ Draw bounding boxes ‚îÄ‚îÄ
function drawBoxes(ctx, dets){
  const cv=document.getElementById('visionOverlay');
  if(!cv||!ctx) return;
  dets.forEach(det=>{
    if(!det.w||!det.h||det.type==='gesture') return;
    const col=det.color||DET_COLORS.object;
    const isAlert=det.status==='intruder';

    ctx.shadowColor=col; ctx.shadowBlur=isAlert?16:6;
    ctx.strokeStyle=col; ctx.lineWidth=isAlert?3:2;
    ctx.strokeRect(det.x,det.y,det.w,det.h);

    // Corner brackets
    const cs=Math.min(16,det.w*0.2,det.h*0.2);
    ctx.lineWidth=isAlert?3:2.5;
    [[det.x,det.y,cs,0,0,cs],[det.x+det.w,det.y,-cs,0,0,cs],
     [det.x,det.y+det.h,cs,0,0,-cs],[det.x+det.w,det.y+det.h,-cs,0,0,-cs]
    ].forEach(([ox,oy,hx,hy,vx,vy])=>{
      ctx.beginPath();ctx.moveTo(ox+hx,oy);ctx.lineTo(ox,oy);ctx.lineTo(ox+vx,oy+vy);ctx.stroke();
    });

    // Label above box
    const label=det.label||det.class||'?';
    ctx.font='bold 11px "Orbitron",monospace';
    const tw=ctx.measureText(label).width;
    const lx=det.x, ly=det.y>20?det.y-20:det.y+det.h+4;
    ctx.shadowBlur=0;
    ctx.fillStyle=col+'44'; ctx.fillRect(lx,ly,tw+10,16);
    ctx.strokeStyle=col; ctx.lineWidth=1; ctx.strokeRect(lx,ly,tw+10,16);
    ctx.fillStyle=col; ctx.fillText(label,lx+5,ly+12);
    if(det.conf){
      ctx.font='8px Rajdhani,sans-serif';
      ctx.fillStyle='rgba(255,255,255,0.5)';
      ctx.fillText(det.conf+'%',lx+tw+6,ly+12);
    }
    ctx.shadowBlur=0;
  });
}

// ‚îÄ‚îÄ Detection panel update ‚îÄ‚îÄ
function updateVisionPanel(dets){
  const el=document.getElementById('visionDetPanel'); if(!el) return;
  const real=dets.filter(d=>d.label&&d.type!=='gesture'||(d.type==='gesture'));
  if(!real.length){el.innerHTML='<div class="vdet-empty">Nothing detected</div>';return;}
  el.innerHTML='';
  real.forEach(det=>{
    const row=document.createElement('div');
    const icons={known:'ü§ù',intruder:'‚ö†Ô∏è',person:'üë§',object:'üì¶',gesture:'‚úã'};
    row.className='vdet-row '+(det.status||det.type||'object');
    const col=det.color||DET_COLORS.object;
    row.innerHTML=`<span>${icons[det.status]||icons[det.type]||'üìå'}</span>
      <div style="flex:1;"><div class="vdet-name">${esc(det.label||det.class)}</div>
      <div class="vdet-type" style="color:${col};">${det.status||det.type} ¬∑ ${det.class}</div></div>
      <span class="vdet-conf">${det.conf||0}%</span>`;
    el.appendChild(row);
  });
}

// ‚îÄ‚îÄ Ask about what you see ‚îÄ‚îÄ
async function visionAsk(){
  const inp=document.getElementById('visionAskInput');
  const replyEl=document.getElementById('visionAskReply');
  const q=inp?.value.trim(); if(!q) return;
  inp.value='';
  replyEl.style.display='block'; replyEl.textContent='Thinking...';

  const detCtx=visionDetections.map(d=>`${d.label||d.class}(${d.status},${d.conf}%)`).join(', ')||'nothing detected';
  const sysprompt='You are Bro AI with vision. Camera currently detects: '+detCtx+'. Answer concisely.';

  if(visionLastFrame&&(puterReady||keys.g)){
    let ans=null;
    if(puterReady&&typeof puter!=='undefined'){
      try{
        const res=await puter.ai.chat([{role:'user',content:[
          {type:'image_url',image_url:{url:visionLastFrame}},{type:'text',text:q+' (detected: '+detCtx+')'}
        ]}],{model:'gpt-4o-mini'});
        ans=typeof res==='string'?res:(res?.message?.content||null);
      }catch(e){}
    }
    if(!ans&&keys.g){
      try{
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key='+keys.g,
          {method:'POST',headers:{'Content-Type':'application/json'},
           body:JSON.stringify({contents:[{parts:[{inline_data:{mime_type:'image/jpeg',data:visionLastFrame.split(',')[1]}},{text:q}]}]}),
           signal:AbortSignal.timeout(10000)});
        if(r.ok){const d=await r.json();ans=d?.candidates?.[0]?.content?.parts?.[0]?.text;}
      }catch(e){}
    }
    if(ans){replyEl.textContent=ans.trim();speak(ans.trim().substring(0,160));return;}
  }
  callAI(q,r=>{replyEl.textContent=r;speak(r.substring(0,160));},sysprompt);
}

function parseVisionJSON(txt){
  if(!txt) return null;
  try{
    const cl=txt.replace(/```json|```/g,'').trim();
    const s=cl.indexOf('['),e=cl.lastIndexOf(']');
    if(s<0||e<0) return null;
    return JSON.parse(cl.substring(s,e+1));
  }catch(e){return null;}
}


async function loadML(){
  const el=document.getElementById('mlStatusRow');
  try{
    if(el) el.textContent='ML: Loading TensorFlow...';
    const tfOk=await loadTF();
    if(!tfOk) throw new Error('TF.js load failed');
    if(el) el.textContent='ML: Loading COCO-SSD...';
    const cocoOk=await loadCocoSsd();
    if(!cocoOk) throw new Error('COCO-SSD load failed');
    cocoModel=await cocoSsd.load();
    mlReady=true;
    if(el){el.textContent='ML: READY ‚úì';el.style.color='var(--gr)';}
    const vms=document.getElementById('visionMLStatus');
    if(vms){vms.textContent='‚úì COCO READY';vms.style.color='var(--gr)';}
    // If face screen is open and vision on, rebuild descriptors
    if(faceApiReady) buildFaceDescriptors();
    setPill('pillML',true);
    addDetLog('ML object detection ready');
  }catch(e){
    mlReady=false;
    if(el){el.textContent='ML: Basic mode (no internet for ML)';el.style.color='var(--o)';}
    setPill('pillML',false);
  }
}

function startBgDetection(){
  clearInterval(bgDetectT);
  setPill('pillDetect',true);
  bgDetectT=setInterval(runBgDetect,1200);
}
function stopBgDetection(){
  clearInterval(bgDetectT);
  setPill('pillDetect',false);
}

async function runBgDetect(){
  if(!bgCamOn||!sett.detection) return;
  const v=document.getElementById('bgCamVideo');
  if(!v.videoWidth) return;
  const c=document.getElementById('bgCanvas');
  const ctx=c.getContext('2d');
  ctx.drawImage(v,0,0,c.width,c.height);

  let detectedClasses=[], personCount=0;

  // Real ML detection
  if(mlReady&&cocoModel){
    try{
      const preds=await cocoModel.detect(v);
      detectedClasses=preds.map(p=>p.class);
      preds.forEach(p=>{
        if(p.class==='person') personCount++;
        // log unique objects
        if(!objectLog.find(o=>o.name===p.class&&Date.now()-o.time<60000)){
          objectLog.unshift({name:p.class,conf:Math.round(p.score*100),time:Date.now(),ts:new Date().toLocaleTimeString()});
          if(objectLog.length>100) objectLog.splice(100);
          localStorage.setItem('bobjlog',JSON.stringify(objectLog));
        }
      });

      // Person follow
      if(sett.followPerson&&personCount>0&&rOK){
        const person=preds.find(p=>p.class==='person');
        if(person){
          const cx=(person.bbox[0]+person.bbox[2]/2)/c.width;
          if(cx<0.35) espCmd({action:'left',speed:30});
          else if(cx>0.65) espCmd({action:'right',speed:30});
          else espCmd({action:'forward',speed:35});
        }
      }

      stats.detections+=preds.length;
      stats.people=Math.max(stats.people,personCount);

      if(personCount>0){
        stats.faces++;
        learnPattern('camera_activity_person','vision');
        // Vision learning: periodically learn from what camera sees
        if(sett.detection && Date.now()-visionLearnCooldown>30000){
          const snapEl=document.getElementById('bgCamVideo');
          if(snapEl&&snapEl.videoWidth){
            const sc=document.createElement('canvas');sc.width=320;sc.height=240;
            sc.getContext('2d').drawImage(snapEl,0,0,320,240);
            learnFromVision(sc.toDataURL('image/jpeg',0.6), personCount+' person(s) detected');
          }
        }
        if(sett.faceRec){
          const isKnown=await tryFaceRecognition(ctx,c,personCount);
          if(!isKnown&&bgGuardOn&&Date.now()>bgAlertCooldown+15000){
            bgAlertCooldown=Date.now();
            onIntruder(100);
          }
        } else {
          setSub('Person in view: '+personCount);
          addDetLog('Person detected: '+personCount);
        }
      }

      // Update stats display
      const classes=[...new Set(detectedClasses)];
      document.getElementById('detectionStats').innerHTML=
        `<div class="rep-row"><span class="rep-k">Objects in view</span><span class="rep-v">${preds.length}</span></div>`+
        `<div class="rep-row"><span class="rep-k">People</span><span class="rep-v">${personCount}</span></div>`+
        `<div class="rep-row"><span class="rep-k">Detected</span><span class="rep-v" style="font-size:11px;">${classes.join(', ')||'None'}</span></div>`+
        `<div class="rep-row"><span class="rep-k">Total logged</span><span class="rep-v">${objectLog.length}</span></div>`;

    }catch(e){console.log('Detection error:',e.message);}
  } else {
    // Basic brightness/pixel fallback
    const d=ctx.getImageData(0,0,c.width,c.height);
    const brightness=getAvgBrightness(d);
    document.getElementById('detectionStats').innerHTML=
      `<div class="rep-row"><span class="rep-k">Mode</span><span class="rep-v" style="color:var(--o);">BASIC</span></div>`+
      `<div class="rep-row"><span class="rep-k">Brightness</span><span class="rep-v">${brightness}</span></div>`+
      `<div style="font-size:11px;color:var(--g);margin-top:6px;">Full detection needs internet to load ML models. Basic motion detection still works!</div>`;
  }
}

function getAvgBrightness(d){
  let t=0;for(let i=0;i<d.data.length;i+=16)t+=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
  return Math.round(t/(d.data.length/16));
}

// Face recognition against known faces
// Face recognition using Gemini Vision API
// Returns true if known person, false if unknown
let faceRecCooldown=0;
async function tryFaceRecognition(ctx, canvas, count){
  // Only run every 10 seconds max
  if(Date.now()-faceRecCooldown<10000) return lastFaceKnown;

  // If no known faces registered, everyone is unknown
  if(!knownFaces.length){
    if(unknownFaces.length<20&&Date.now()-bgAlertCooldown>20000){
      const snap=canvas.toDataURL('image/jpeg',0.5);
      unknownFaces.unshift({img:snap,time:new Date().toLocaleString(),ts:Date.now()});
      if(unknownFaces.length>20) unknownFaces.splice(20);
      localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
    }
    return false;
  }

  faceRecCooldown=Date.now();
  const snap=canvas.toDataURL('image/jpeg',0.5);

  // Build known face names list for Gemini to compare
  const faceNames=knownFaces.map(f=>f.name+(f.nickname?' ('+f.nickname+')':'')).join(', ');

  // Use Gemini Vision to identify who is in the frame
  const gemKey=keys['g'];
  if(!gemKey){ lastFaceKnown=false; return false; }

  try{
    // Send current frame + known face images to Gemini
    const knownImgParts=knownFaces.slice(0,3).map(f=>({
      inline_data:{mime_type:'image/jpeg',data:f.img.split(',')[1]}
    }));
    const currentImgPart={inline_data:{mime_type:'image/jpeg',data:snap.split(',')[1]}};
    const prompt=`Look at the LAST image (current camera frame). The previous images are registered known people: ${faceNames}. Does the person in the LAST image match any of the known people? Reply with ONLY: KNOWN:<name> or UNKNOWN. Nothing else.`;

    const body={contents:[{parts:[...knownImgParts,currentImgPart,{text:prompt}]}]};
    const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+gemKey,
      {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),signal:AbortSignal.timeout(8000)});

    if(!r.ok){ lastFaceKnown=false; return false; }
    const d=await r.json();
    const reply=(d?.candidates?.[0]?.content?.parts?.[0]?.text||'').trim().toUpperCase();
    console.log('[FaceRec] Gemini reply:', reply);

    if(reply.startsWith('KNOWN:')){
      const recognizedName=reply.replace('KNOWN:','').trim();
      const face=knownFaces.find(f=>recognizedName.toUpperCase().includes(f.name.toUpperCase()))||knownFaces[0];
      const greeting=face.callName||('Hello '+face.name+'!');
      setSub(greeting);speak(greeting);
      addDetLog('Face recognised: '+face.name);
      lastFaceKnown=true;
      return true;
    } else {
      // Unknown person ‚Äî save snapshot
      addDetLog('Unknown face detected');
      if(unknownFaces.length<20){
        unknownFaces.unshift({img:snap,time:new Date().toLocaleString(),ts:Date.now()});
        if(unknownFaces.length>20) unknownFaces.splice(20);
        localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
      }
      lastFaceKnown=false;
      return false;
    }
  }catch(e){
    console.log('[FaceRec] error:',e.message);
    lastFaceKnown=true; // on error, assume known to avoid false alarms
    return true;
  }
}
let lastFaceKnown=true;

// ‚îÄ‚îÄ Background Motion Watch (Guardian) ‚îÄ‚îÄ
function startBgMotion(){
  clearInterval(bgMotionT);
  bgMotionT=setInterval(runBgMotion,600);
  setPill('pillGuard',true);
}

function runBgMotion(){
  // Motion detection is now only used for motion SENSING (speed/movement indicator)
  // Intruder alerts are ONLY triggered by ML person detection (not pixel changes)
  // This prevents fan, light, objects from being flagged as intruders
  if(!bgGuardOn||!bgCamOn) return;
  const v=document.getElementById('bgCamVideo');if(!v.videoWidth) return;
  const canvas=document.createElement('canvas');canvas.width=80;canvas.height=60;
  const ctx=canvas.getContext('2d');ctx.drawImage(v,0,0,80,60);
  const frame=ctx.getImageData(0,0,80,60);
  if(bgPrevFrame){
    let diff=0,changed=0;
    for(let i=0;i<frame.data.length;i+=4){
      const d=Math.abs(frame.data[i]-bgPrevFrame[i])+Math.abs(frame.data[i+1]-bgPrevFrame[i+1])+Math.abs(frame.data[i+2]-bgPrevFrame[i+2]);
      if(d>35)changed++;diff+=d;
    }
    const score=diff/(frame.data.length/4);
    // Just update motion indicator ‚Äî NO intruder alert from motion alone
    const motionLevel=score>50?'HIGH':score>20?'LOW':'NONE';
    const pill=document.getElementById('pillGuard');
    if(pill) pill.textContent='üõ° Motion:'+motionLevel;
    stats.motionAlerts=(score>30)?stats.motionAlerts+0.01:stats.motionAlerts; // track lightly
  }
  bgPrevFrame=Array.from(frame.data);
}

function onIntruder(pct){
  if(intruderAlertRunning) return; // don't stack alerts
  intruderAlertRunning=true;
  addDetLog('‚ö† INTRUDER! Motion: '+pct+'%');

  // Capture snapshot first
  const v=document.getElementById('bgCamVideo');
  if(v&&v.videoWidth){
    const snap=document.createElement('canvas');snap.width=160;snap.height=120;
    snap.getContext('2d').drawImage(v,0,0,160,120);
    unknownFaces.unshift({img:snap.toDataURL('image/jpeg',0.6),time:new Date().toLocaleString()+' [INTRUDER]',ts:Date.now()});
    if(unknownFaces.length>20) unknownFaces.splice(20);
    localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
  }

  // Eyes go RED
  ['eyeL','eyeR','fsEyeL','fsEyeR'].forEach(id=>{
    const e=document.getElementById(id);if(!e)return;
    e.style.background='#FF0000';e.style.boxShadow='0 0 60px rgba(255,0,0,1)';
  });
  ['emoLbl','fsEmo'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent='ALERT';});

  if(rOK){espCmd({action:'stop'});espCmd({action:'alarm'});}
  showAlert('‚ö† INTRUDER DETECTED!');

  // 3 alerts with 5 second intervals
  let alertCount=0;
  function doAlert(){
    if(alertCount>=3){
      // Done ‚Äî reset everything
      dismissAlert();
      resetToNeutral();
      setSub('Area clear. I am watching.');
      setListenLbl('‚óè LISTENING...');
      intruderAlertRunning=false;
      // Resume voice loop
      if(botVoiceOn) setTimeout(listenLoop,500);
      return;
    }
    alertCount++;
    setSub('‚ö† INTRUDER ALERT! ('+alertCount+'/3)');
    speak('Warning! Intruder detected!',()=>{
      setTimeout(doAlert,5000);
    });
  }
  doAlert();
}

// ‚îÄ‚îÄ Background Emergency Listener ‚îÄ‚îÄ
function startBgEmergency(){
  if(!SR||!bgEmergOn) return;
  listenEmerg();
}
function listenEmerg(){
  if(!bgEmergOn) return;
  if(botVoiceOn){setTimeout(listenEmerg,5000);return;} // voice loop handles it
  try{
    const r=new SR();r.lang=sett.lang||'en-US';r.continuous=false;r.interimResults=false;r.maxAlternatives=2;
    let got=false;
    r.onresult=(e)=>{
      got=true;
      let h='';for(let i=0;i<e.results[0].length;i++) h+=e.results[0][i].transcript.toLowerCase()+' ';
      const words=['help','emergency','sos','danger','intruder','attack','fire','call police','mayday'];
      const hit=words.find(w=>h.includes(w));
      if(hit) onEmergWord(hit);
    };
    r.onend=()=>{if(bgEmergOn) setTimeout(listenEmerg,1200);};
    r.onerror=()=>{if(bgEmergOn) setTimeout(listenEmerg,4000);};
    r.start();
  }catch(e){if(bgEmergOn) setTimeout(listenEmerg,5000);}
}

function onEmergWord(word){
  if(Date.now()<bgAlertCooldown+10000) return;
  bgAlertCooldown=Date.now();
  showAlert('üö® EMERGENCY WORD: "'+word.toUpperCase()+'" DETECTED!');
  setSub('Emergency: '+word);setEmotion('alert emergency danger');
  speak('Emergency detected! Do you need help?',()=>{
    try{
      const c=new SR();c.lang=sett.lang||'en-US';c.continuous=false;
      c.onresult=(e)=>{
        const resp=e.results[0][0].transcript.toLowerCase();
        if(/yes|help|please/.test(resp)){
          activateSOS();
        } else {
          speak('Okay. Staying alert.');dismissAlert();
        }
      };c.onend=()=>{};c.start();
    }catch(ex){}
  });
}

let sosInterval=null;
function activateSOS(){
  speak('SOS activated! Calling for help!');
  showAlert('üö® SOS ACTIVATED!');
  setEmotion('alert');setSub('SOS ACTIVE ‚Äî EMERGENCY');
  clearInterval(sosInterval);
  sosInterval=setInterval(()=>speak('SOS! Emergency! Please help!'),8000);
  addDetLog('SOS activated');
}
function testSOS(){activateSOS();setTimeout(()=>{clearInterval(sosInterval);dismissAlert();speak('SOS test complete.');},5000);}

// ‚îÄ‚îÄ Global Alert Banner ‚îÄ‚îÄ
function showAlert(msg){
  const el=document.getElementById('globalAlert');
  document.getElementById('globalAlertMsg').textContent=msg;
  el.style.display='flex';
}
function dismissAlert(){
  document.getElementById('globalAlert').style.display='none';
  clearInterval(sosInterval);
}

// ‚îÄ‚îÄ Status Pills ‚îÄ‚îÄ
function setPill(id,on){const e=document.getElementById(id);if(e)e.className='fs-pill'+(on?' on':'');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IDLE + AUTO NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetIdle(){lastActiveTime=Date.now();if(isIdle){isIdle=false;stopAutoNav();setPill('pillNav',false);document.getElementById('navPill').style.display='none';}}
function startIdleWatch(){
  clearInterval(idleCheckT);
  idleCheckT=setInterval(()=>{
    if(!sett.autoNav||!rOK) return;
    if(Date.now()-lastActiveTime>30000&&!isIdle){
      isIdle=true;startAutoNav();
    }
    // Proactive memory: surface relevant facts/routines when idle
    const idleMs=Date.now()-lastActiveTime;
    if(idleMs>90000&&botVoiceOn&&!intruderAlertRunning){
      const period=getCurrentPeriod();
      const day=new Date().toLocaleDateString('en',{weekday:'short'});
      const routine=(userProfile.routines[period+'_'+day]||[]).find(r=>r.count>=3);
      if(routine&&idleMs<95000){
        const m='Hey, you usually '+routine.action+' around this time!';
        setSub(m);speak(m);
      } else if(selfLearned.length&&idleMs>300000&&idleMs<305000){
        const fact=selfLearned[Math.floor(Math.random()*Math.min(selfLearned.length,10))];
        if(fact){const m='Reminder: '+fact.fact;setSub(m.substring(0,80));speak(m.substring(0,80));}
      }
    }
  },5000);
}
function startAutoNav(){
  setPill('pillNav',true);
  document.getElementById('navPill').style.display='block';
  setSub('No one talking. Exploring...');setEmotion('curious');
  addMovLog('Auto-nav started (idle)');
  runAutoNav();
}
function stopAutoNav(){
  clearTimeout(autoNavT);isIdle=false;
  setPill('pillNav',false);
  document.getElementById('navPill').style.display='none';
  if(rOK) espCmd({action:'stop'});
}
async function runAutoNav(){
  if(!isIdle||!rOK) return;
  let sd={ultrasonic:100,ir1:false,ir2:false};
  try{const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(700)});sd=await r.json();}catch(e){}
  const us=sd.ultrasonic??100;
  if(us<25||sd.ir1||sd.ir2){
    espCmd({action:'stop'});stats.obstacles++;
    const d=Math.random()>0.5?'left':'right';
    espCmd({action:d,speed:robotSpeed});
    addMovLog('Auto: obstacle‚Üíturn '+d);
    autoNavT=setTimeout(()=>{espCmd({action:'stop'});autoNavT=setTimeout(runAutoNav,400);},700+Math.random()*400);
  } else {
    espCmd({action:'forward',speed:Math.min(robotSpeed,45)});
    addMovLog('Auto: forward');
    autoNavT=setTimeout(runAutoNav,1800+Math.random()*800);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESP32
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function espCmd(obj){
  if(!eIP) return;
  try{await fetch('http://'+eIP+'/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj),signal:AbortSignal.timeout(1000)});}catch(e){}
}
async function connectESP(){
  const ip=document.getElementById('espIP')?.value.trim();if(!ip)return;
  eIP=ip;localStorage.setItem('bi',ip);
  const m=document.getElementById('espMsg');
  if(m){m.textContent='Connecting...';m.style.color='var(--o)';}
  try{
    const r=await fetch('http://'+ip+'/ping',{signal:AbortSignal.timeout(3000)});
    if(r.ok){
      rOK=true;document.getElementById('botDot')?.classList.remove('r');
      if(m){m.textContent='‚úì Connected to Bro Bot!';m.style.color='var(--gr)';}
      startSensorLoop();
    } else throw new Error();
  }catch(e){rOK=false;if(m){m.textContent='‚úó Cannot connect. Check IP.';m.style.color='var(--r)';}}
}
let sensorLoopT=null;
function startSensorLoop(){
  clearInterval(sensorLoopT);
  sensorLoopT=setInterval(async()=>{
    if(!rOK||!eIP) return;
    try{
      const r=await fetch('http://'+eIP+'/sensors',{signal:AbortSignal.timeout(800)});
      const d=await r.json();
      const bat=d.battery??'--',us=d.ultrasonic??'--';
      const bd=document.getElementById('batDisp');
      if(bd){bd.style.display='block';bd.textContent='üîã '+bat+'%';bd.className='bat'+(bat<20?' low':'');}
      if(sett.batAlert&&bat<15&&bat>0) speak('Warning! Battery low. Please charge soon.');
      if(sett.obstacle&&(d.ir1||d.ir2||us<15)){espCmd({action:'stop'});stats.obstacles++;}
    }catch(e){}
  },500);
}
function handleRobotCmds(text){
  if(/MOVE_FORWARD|MOVE_BACKWARD|TURN|PATROL/.test(text)) learnPattern('robot_movement','command');
  if(!rOK) return;const t=text.toUpperCase();
  if(t.includes('[MOVE_FORWARD]')) espCmd({action:'forward',speed:robotSpeed});
  else if(t.includes('[MOVE_BACKWARD]')) espCmd({action:'backward',speed:robotSpeed});
  else if(t.includes('[TURN_LEFT]')) espCmd({action:'left',speed:robotSpeed});
  else if(t.includes('[TURN_RIGHT]')) espCmd({action:'right',speed:robotSpeed});
  else if(t.includes('[STOP]')) espCmd({action:'stop'});
  else if(t.includes('[TURN_90L]')){espCmd({action:'left',speed:40});setTimeout(()=>espCmd({action:'stop'}),800);}
  else if(t.includes('[TURN_90R]')){espCmd({action:'right',speed:40});setTimeout(()=>espCmd({action:'stop'}),800);}
  else if(t.includes('[TURN_180]')){espCmd({action:'right',speed:40});setTimeout(()=>espCmd({action:'stop'}),1600);}
  if(t.includes('[HEAD_LEFT]')) espCmd({action:'servo_head',angle:45});
  else if(t.includes('[HEAD_RIGHT]')) espCmd({action:'servo_head',angle:135});
  else if(t.includes('[HEAD_CENTER]')) espCmd({action:'servo_head',angle:90});
  if(t.includes('[TILT_UP]')) espCmd({action:'servo_tilt',angle:60});
  else if(t.includes('[TILT_DOWN]')) espCmd({action:'servo_tilt',angle:120});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chatRecOn=false;
async function chatMic(){
  const btn=document.getElementById('chatMicBtn');
  if(chatRecOn){chatRecOn=false;btn.textContent='üé§';return;}
  // Try Puter speech2txt first (better accuracy)
  if(puterReady && typeof puter!=='undefined' && typeof puter.ai?.speech2txt==='function'){
    btn.textContent='üî¥';chatRecOn=true;
    try{
      const result=await puter.ai.speech2txt();
      chatRecOn=false;btn.textContent='üé§';
      if(result?.text){document.getElementById('chatInput').value=result.text;sendChat();return;}
    }catch(e){console.log('[Puter STT]',e.message);}
    chatRecOn=false;btn.textContent='üé§';
  }
  // Fallback: browser speech recognition
  if(!SR) return;
  const r=new SR();r.lang=sett.lang||'en-US';r.continuous=false;chatRecOn=true;
  btn.textContent='üî¥';
  r.onresult=(e)=>{document.getElementById('chatInput').value=e.results[0][0].transcript;sendChat();};
  r.onend=()=>{chatRecOn=false;btn.textContent='üé§';};
  r.onerror=()=>{chatRecOn=false;btn.textContent='üé§';};
  try{r.start();}catch(ex){chatRecOn=false;btn.textContent='üé§';}
}
function sendChat(){
  const inp=document.getElementById('chatInput');const txt=inp.value.trim();if(!txt)return;inp.value='';
  // Vision question ‚Äî ask about what camera sees
  if(/what.*(see|detect|in front|looking at|around|visible)/i.test(txt)||/describe.*(scene|room|view|environment)/i.test(txt)||/who.*(there|camera|front)/i.test(txt)){
    if(visionLastFrame){
      addMsg(txt,'u');
      const detCtx=visionDetections.map(d=>''+( d.label||d.class)+'('+d.status+','+d.conf+'%)').join(', ')||'nothing yet';
      callAI(txt,(r)=>{addMsg(r,'b');saveChatMsg('bot',r);setSub(r);speak(r);},
        'You are Bro AI with a camera. Currently seeing: '+detCtx+'. Answer the user question about what you see. Be specific and helpful.');
    } else {
      addMsg(txt,'u');addMsg('Vision camera is off. Open the Vision tab (üëÅ VISION button) and tap START CAMERA first.','b');
      speak('Vision camera is off. Open the Vision tab and start the camera first.');
    }
    return;
  }

  // Detect explicit memory commands
  const memCmdMatch = txt.match(/(?:remember|save|note|memorize)[: ]+(this[: ]+)?(.+)/i)
                   || txt.match(/add to (?:memory|memories)[: ]+(.+)/i)
                   || txt.match(/update (?:your )?memory[: ]+(.+)/i);
  if(memCmdMatch){
    const memText = (memCmdMatch[2]||memCmdMatch[1]||'').trim();
    const cleanMem = txt.replace(/^(?:remember|save|note|memorize|add to memory|update your memory|update memory)[: ]*/i,'').replace(/^this[: ]*/i,'').trim();
    if(cleanMem.length>2){
      saveMem(cleanMem);
      addMsg('‚úì Memory saved: "'+cleanMem.substring(0,60)+'"','b');
      speak('Got it, I will remember that.');
      renderMemory();
      return;
    }
  }
  addMsg(txt,'u');saveChatMsg('user',txt);showTyping(true);
  callAI(txt,(reply)=>{
    showTyping(false);
    addMsg(reply,'b');
    saveChatMsg('bot',reply);
    setSub(reply);
    setEmotion(reply);
    speak(reply);
    handleRobotCmds(reply);
    // Don't auto-save every reply as memory ‚Äî only save explicit user memories
    // autoLearn is called inside callAI when user says facts about themselves
    chatMsgCount++;
    if(chatMsgCount===2) autoName();
  });
}
function addMsg(txt,type){
  const l=document.getElementById('msgList');const d=document.createElement('div');
  d.className='msg '+(type==='u'?'u':type==='b'?'b':'s');d.textContent=txt;l.appendChild(d);
  setTimeout(()=>l.scrollTop=l.scrollHeight,50);
}
function showTyping(s){const t=document.getElementById('typingDiv');if(t)t.style.display=s?'block':'none';if(s){const l=document.getElementById('msgList');if(l)l.scrollTop=l.scrollHeight;}}
function newChat(){saveCurChat();curChatId=null;chatMsgCount=0;document.getElementById('msgList').innerHTML='<div class="msg s">New chat started!</div>';document.getElementById('sidebar').classList.remove('open');renderSidebar();}
function saveCurChat(){if(!curChatId)return;localStorage.setItem('bchats',JSON.stringify(chats));}
function saveChatMsg(role,text){
  if(!curChatId){curChatId=Date.now();chatMsgCount=0;chats.unshift({id:curChatId,name:'New Chat',msgs:[],time:new Date().toLocaleDateString()});}
  const ch=chats.find(c=>c.id===curChatId);
  if(ch){
    ch.msgs.push({role,text,time:Date.now()});
    localStorage.setItem('bchats',JSON.stringify(chats));
    // Cloud backup to Puter
    if(sett.puterFS&&puterReady) puterCloudSave('chat_'+curChatId+'.json', ch);
    // KV sync latest exchange
    if(sett.puterKV&&puterReady&&role==='bot') puterKVSet('last_exchange', {user:text,time:Date.now()});
  }
}
function autoName(){const c=chats.find(c=>c.id===curChatId);if(!c||c.name!=='New Chat')return;const f=c.msgs.find(m=>m.role==='user');if(!f)return;c.name=f.text.substring(0,35)+(f.text.length>35?'...':'');localStorage.setItem('bchats',JSON.stringify(chats));renderSidebar();}
function loadChat(id){saveCurChat();curChatId=id;chatMsgCount=0;const c=chats.find(c=>c.id===id);if(!c)return;const l=document.getElementById('msgList');l.innerHTML='';c.msgs.forEach(m=>addMsg(m.text,m.role==='user'?'u':'b'));setTimeout(()=>l.scrollTop=l.scrollHeight,50);document.getElementById('sidebar').classList.remove('open');renderSidebar();}
function deleteChat(id,ev){ev.stopPropagation();if(!confirm('Delete this chat?'))return;chats=chats.filter(c=>c.id!==id);if(curChatId===id){curChatId=null;document.getElementById('msgList').innerHTML='<div class="msg s">Chat deleted.</div>';}localStorage.setItem('bchats',JSON.stringify(chats));renderSidebar();}
function renderSidebar(){chats=JSON.parse(localStorage.getItem('bchats')||'[]');const l=document.getElementById('sbList');if(!l)return;if(!chats.length){l.innerHTML='<div style="color:var(--g);font-size:12px;text-align:center;padding:20px;">No chats yet!</div>';return;}l.innerHTML='';chats.forEach(c=>{const d=document.createElement('div');d.className='sb-item'+(c.id===curChatId?' act':'');d.onclick=()=>loadChat(c.id);d.innerHTML=`<button class="sb-del" onclick="deleteChat(${c.id},event)">‚úï</button><div class="sb-name">${esc(c.name)}</div><div class="sb-date">${c.time}</div>`;l.appendChild(d);});}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');renderSidebar();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSettUI(){
  keys=JSON.parse(localStorage.getItem('bk')||'{}');
  sett=JSON.parse(localStorage.getItem('bs')||'{}');
  if(keys.g)    document.getElementById('kG')?.setAttribute('value',keys.g);
  if(keys.groq) document.getElementById('kGroq')?.setAttribute('value',keys.groq);
  if(keys.mis)  document.getElementById('kMis')?.setAttribute('value',keys.mis);
  if(keys.or)   document.getElementById('kOR')?.setAttribute('value',keys.or);
  if(keys.hf) document.getElementById('kHF')?.setAttribute('value',keys.hf);
  if(keys.wg) document.getElementById('kWG')?.setAttribute('value',keys.wg);
  if(keys.gh) document.getElementById('kGH')?.setAttribute('value',keys.gh);
  // Puter model selection
  const pms=document.getElementById('puterModelSel');if(pms&&sett.puterModel)pms.value=sett.puterModel;
  updatePuterStatus(puterReady);
  renderMemory();
  if(eIP) document.getElementById('espIP').value=eIP;
  [['tNav','autoNav'],['tObs','obstacle'],['tFollow','followPerson'],['tBat','batAlert'],['tLook','lookSpeak'],['tDetect','detection'],['tFaceRec','faceRec'],['tOCR','ocrMode'],['tGest','gestureCtrl']].forEach(([id,k])=>{const e=document.getElementById(id);if(e)e.className='tog'+(sett[k]?' on':'');});
  [['tGuard',bgGuardOn],['tEmerg',bgEmergOn],['tGuardNight',sett.guardNight]].forEach(([id,v])=>{const e=document.getElementById(id);if(e)e.className='tog'+(v?' on':'');});
  const p=document.getElementById('sPers');if(p)p.value=sett.personality||'friendly';
  const sp=document.getElementById('sSpeed');if(sp)sp.value=sett.voiceSpeed||0.9;
  const sl=document.getElementById('sLang');if(sl)sl.value=sett.lang||'en-US';
  renderModelList();renderKnownFaces();renderUnknownFaces();renderObjectLog();renderReminders();renderStats();
}
function saveKeys(){
  keys={
    g:   document.getElementById('kG')?.value.trim()||'',
    groq:document.getElementById('kGroq')?.value.trim()||'',
    mis: document.getElementById('kMis')?.value.trim()||'',
    or:  document.getElementById('kOR')?.value.trim()||'',
    hf:  document.getElementById('kHF')?.value.trim()||'',
    wg:  document.getElementById('kWG')?.value.trim()||'',
    gh:  document.getElementById('kGH')?.value.trim()||'',
  };
  // Remove empty keys
  Object.keys(keys).forEach(k=>{if(!keys[k])delete keys[k];});
  localStorage.setItem('bk',JSON.stringify(keys));
  const m=document.getElementById('keyMsg');
  if(m){m.textContent='‚úì All keys saved!';setTimeout(()=>m.textContent='',2500);}
  renderModelList();
}
function saveSett(){sett.personality=document.getElementById('sPers').value;sett.voiceSpeed=parseFloat(document.getElementById('sSpeed').value);sett.lang=document.getElementById('sLang').value;localStorage.setItem('bs',JSON.stringify(sett));}
function togSet(el,key){el.classList.toggle('on');sett[key]=el.classList.contains('on');localStorage.setItem('bs',JSON.stringify(sett));}
function togGuardian(el){el.classList.toggle('on');bgGuardOn=el.classList.contains('on');setPill('pillGuard',bgGuardOn);speak(bgGuardOn?'Guardian mode enabled.':'Guardian mode disabled.');}
function togEmergency(el){el.classList.toggle('on');bgEmergOn=el.classList.contains('on');if(bgEmergOn)listenEmerg();speak(bgEmergOn?'Emergency listener enabled.':'Emergency listener disabled.');}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACCORDION TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAcc(id){
  const body=document.getElementById(id);
  const arrow=document.getElementById('arr'+id.replace('acc',''));
  if(!body) return;
  body.classList.toggle('open');
  if(arrow) arrow.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUTER.JS INTEGRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let puterReady=false, puterUser=null;

async function initPuter(){
  if(typeof puter==='undefined'){
    console.log('[Puter] Not loaded');
    updatePuterStatus(false); return;
  }
  try{
    puterUser = await puter.auth.getUser();
    if(puterUser?.username){
      puterReady = true;
      updatePuterStatus(true);
      
      // Sync settings from Puter KV if enabled
      if(sett.puterKV){
        try{
          const cloudSett = await puter.kv.get('broai_settings');
          if(cloudSett){ sett=Object.assign(sett, JSON.parse(cloudSett)); saveSett(); }
          const cloudMems = await puter.kv.get('broai_mems');
          if(cloudMems){ mems=JSON.parse(cloudMems); localStorage.setItem('bm',cloudMems); }
          const cloudProfile = await puter.kv.get('broai_profile');
          if(cloudProfile){ userProfile=JSON.parse(cloudProfile); localStorage.setItem('bup',cloudProfile); }
          
        }catch(e){ console.log('[Puter KV sync]',e.message); }
      }
    }
  }catch(e){
    puterReady=false;
    updatePuterStatus(false);
  }
}

function updatePuterStatus(ok){
  const el=document.getElementById('puterStatus');
  if(!el) return;
  if(ok&&puterUser){
    el.textContent='‚úì SIGNED IN: '+puterUser.username;
    el.className='puter-status ok';
  } else {
    el.textContent='‚óâ NOT SIGNED IN';
    el.className='puter-status off';
  }
}

async function puterSignIn(){
  if(typeof puter==='undefined'){alert('Puter.js not loaded. Check internet connection.');return;}
  try{
    puterUser=await puter.auth.signIn();
    puterReady=true;
    updatePuterStatus(true);
    speak('Puter sign in successful. Now using free GPT and Claude models!');
    loadPuterModels();
  }catch(e){
    alert('Puter sign in failed: '+e.message);
  }
}

async function puterSignOut(){
  if(typeof puter==='undefined') return;
  try{await puter.auth.signOut();puterReady=false;puterUser=null;updatePuterStatus(false);}catch(e){}
}

async function loadPuterModels(){
  const el=document.getElementById('puterModelStatus');
  if(!el) return;
  if(!puterReady){el.innerHTML='<span style="color:var(--o);">Sign in to Puter first to see live model list.</span>';return;}
  el.textContent='Loading models...';
  try{
    const models=await puter.ai.listModels?.();
    if(models?.length){
      el.innerHTML='<b style="color:var(--gr);">'+models.length+' models available:</b><br>'+
        models.slice(0,20).map(m=>'<span style="color:#aaa;">¬∑ '+(m.id||m.name||m)+'</span>').join('<br>');
    } else {
      el.innerHTML='<span style="color:var(--g);">Model list not available. Selected model above will be used.</span>';
    }
  }catch(e){el.innerHTML='<span style="color:var(--g);">Using selected model from dropdown above.</span>';}
}

async function callPuterAI(msg){
  if(!puterReady||typeof puter==='undefined') return null;
  const model=sett.puterModel||'gpt-4o-mini';
  try{
    const badge=document.getElementById('modelBadge');
    if(badge){badge.textContent='‚ú¶ '+model.split('/').pop();badge.className='mbadge';}
    const res=await puter.ai.chat(msg,{model});
    const txt=typeof res==='string'?res:(res?.message?.content||res?.content||res?.text||null);
    if(txt?.trim().length>1) return txt.trim();
  }catch(e){
    console.log('[Puter AI] error on',model,':',e.message);
  }
  return null;
}

async function puterTTS(text){
  if(!puterReady||typeof puter==='undefined') return false;
  try{
    const audio=await puter.ai.txt2speech(text);
    audio.play();return true;
  }catch(e){console.log('[Puter TTS]',e.message);return false;}
}

async function puterVisionAnalyze(imgBase64, prompt){
  if(!puterReady||typeof puter==='undefined') return null;
  try{
    const model=sett.puterModel||'gpt-4o';
    const res=await puter.ai.chat([
      {role:'user',content:[
        {type:'image_url',image_url:{url:imgBase64}},
        {type:'text',text:prompt}
      ]}
    ],{model});
    const txt=typeof res==='string'?res:(res?.message?.content||res?.content||null);
    return txt?.trim()||null;
  }catch(e){console.log('[Puter Vision]',e.message);return null;}
}

async function testPuterVision(){
  if(!bgCamOn){alert('Enable camera first (tap CAM on face screen)');return;}
  const v=document.getElementById('bgCamVideo');
  if(!v.videoWidth){alert('Camera not ready');return;}
  const c=document.createElement('canvas');c.width=320;c.height=240;
  c.getContext('2d').drawImage(v,0,0,320,240);
  const img=c.toDataURL('image/jpeg',0.7);
  const el=document.getElementById('funResult');
  if(el) el.textContent='Sending camera to AI vision...';
  const result=await puterVisionAnalyze(img,'Describe what you see in this image in 2 sentences. What objects and people are visible?');
  if(result){if(el)el.textContent='Vision: '+result;speak(result);}
  else{if(el)el.textContent='Vision failed - sign in to Puter first!';}
}

async function testImgGen(){
  if(!puterReady){alert('Sign in to Puter first!');return;}
  const el=document.getElementById('funResult');
  if(el)el.textContent='Generating image...';
  try{
    const img=await puter.ai.txt2img('a futuristic robot with glowing cyan eyes in space');
    if(el){el.innerHTML='';el.appendChild(img);img.style.width='100%';img.style.borderRadius='8px';}
  }catch(e){if(el)el.textContent='Image gen failed: '+e.message;}
}

async function puterCloudSave(filename, data){
  if(!puterReady||!sett.puterFS) return;
  try{await puter.fs.write('/BroAI/'+filename,JSON.stringify(data));console.log('[Puter FS] Saved:',filename);}catch(e){console.log('[Puter FS]',e.message);}
}

async function puterKVSet(key, val){
  if(!puterReady||!sett.puterKV) return;
  try{await puter.kv.set('broai_'+key,JSON.stringify(val));}catch(e){}
}

async function puterKVGet(key){
  if(!puterReady||!sett.puterKV) return null;
  try{const v=await puter.kv.get('broai_'+key);return v?JSON.parse(v):null;}catch(e){return null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER MODEL STATUS IN EACH ACCORDION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderModelList(){
  // Gemini accordion status
  const gEl=document.getElementById('geminiModelList');
  if(gEl){
    const models=[
      {name:'Gemma 3 27B',m:'gemma-3-27b-it',rpd:'14,400/day'},
      {name:'Gemma 3 12B',m:'gemma-3-12b-it',rpd:'14,400/day'},
      {name:'Gemini 2.5 Flash',m:'gemini-2.5-flash-preview-04-17',rpd:'20/day'},
      {name:'Gemini 2.5 Lite',m:'gemini-2.5-flash-lite-preview-06-17',rpd:'20/day'},
    ];
    gEl.innerHTML=models.map(m=>{
      const s=skip[m.name];
      return `<div class="mrow"><div><div style="font-size:12px;color:#ddd;">${m.name}</div><div style="font-size:10px;color:var(--g);">${m.rpd}</div></div><span class="mbadge2 ${s?'skip':'ok'}">${s?'QUOTA':'READY'}</span></div>`;
    }).join('')+(keys.g?'':'<div style="font-size:11px;color:var(--r);padding:8px;">‚ö† No Gemini key ‚Äî add above</div>');
  }
  // Groq status
  const groqEl=document.getElementById('groqModelStatus');
  if(groqEl) groqEl.innerHTML=keys.groq
    ?'<span style="color:var(--gr);">‚úì Groq key found ‚Äî ultra fast inference ready!</span>'
    :'<span style="color:var(--r);">‚ö† Add Groq key above ‚Äî free at console.groq.com</span>';
  // Mistral status
  const misEl=document.getElementById('mistralModelStatus');
  if(misEl) misEl.innerHTML=keys.mis
    ?'<span style="color:var(--gr);">‚úì Mistral key found ‚Äî Mistral Large, Small, Nemo ready</span>'
    :'<span style="color:var(--r);">‚ö† Add Mistral key above ‚Äî console.mistral.ai</span>';
  // OpenRouter status
  const orEl=document.getElementById('orModelList');
  if(orEl) orEl.innerHTML=keys.or?'<div style="font-size:11px;color:var(--gr);padding:6px;">‚úì OpenRouter key found</div>':'<div style="font-size:11px;color:var(--r);padding:6px;">‚ö† Add OpenRouter key in API Keys section</div>';
  // HuggingFace status
  const hfEl=document.getElementById('hfModelList');
  if(hfEl) hfEl.innerHTML=keys.hf?'<div style="font-size:11px;color:var(--gr);padding:6px;">‚úì HuggingFace token found</div>':'<div style="font-size:11px;color:var(--r);padding:6px;">‚ö† Add HuggingFace token in API Keys section</div>';
  // Wisdom Gate status
  const wgEl=document.getElementById('wgModelList');
  if(wgEl) wgEl.innerHTML=keys.wg?'<div style="font-size:11px;color:var(--gr);padding:6px;">‚úì Wisdom Gate key found ¬∑ minimax-m2.5:free ready</div>':'<div style="font-size:11px;color:var(--r);padding:6px;">‚ö† Add Wisdom Gate key in API Keys section</div>';
  // GitHub status
  const ghEl=document.getElementById('ghModelList');
  if(ghEl) ghEl.innerHTML=keys.gh?'<div style="font-size:11px;color:var(--gr);padding:6px;">‚úì GitHub token found ‚Äî GPT-4o, Llama, DeepSeek ready</div>':'<div style="font-size:11px;color:var(--r);padding:6px;">‚ö† Add GitHub token in API Keys section</div>';
  // Puter
  const puterEl=document.getElementById('puterModelStatus');
  if(puterEl&&!puterReady) puterEl.innerHTML='<span style="color:var(--o);">Sign in to Puter above to use free AI models.</span>';
}
function resetSkip(){skip={};localStorage.setItem('bsk','{}');localStorage.removeItem('bsktimes');localStorage.setItem('bskt',''+Date.now());renderModelList();speak('Quota reset. All models available.');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KNOWN FACES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function captureFace(){
  const name=document.getElementById('fOrigName').value.trim();
  const nick=document.getElementById('fNickname').value.trim();
  const call=document.getElementById('fCallName').value.trim();
  const rel=document.getElementById('fRelation').value.trim();
  if(!name){alert('Enter original name!');return;}
  // Use vision video if open, else bg cam
  const vid=visionOn?document.getElementById('visionVideo'):document.getElementById('bgCamVideo');
  if(!vid||!vid.videoWidth){
    alert('Turn on the camera first ‚Äî open Vision tab and tap START, or tap üì∑ CAM.');return;
  }
  // Capture 3 shots for better accuracy
  const shots=[];
  for(let i=0;i<3;i++){
    const cv2=document.createElement('canvas');cv2.width=320;cv2.height=320;
    cv2.getContext('2d').drawImage(vid,0,0,320,320);
    shots.push(cv2.toDataURL('image/jpeg',0.85));
  }
  const img=shots[0];
  const existing=knownFaces.find(f=>f.name.toLowerCase()===name.toLowerCase());
  if(existing){
    existing.img=img;
    if(!existing.imgs) existing.imgs=[];
    shots.forEach(s=>{if(existing.imgs.length<15) existing.imgs.push(s);});
    speak('Updated '+name+'! Now have '+existing.imgs.length+' face samples for better accuracy.');
  } else {
    knownFaces.push({id:Date.now(),name,nickname:nick,callName:call||('Hello '+name+'!'),relation:rel,img,imgs:shots,time:new Date().toLocaleString()});
    speak('Registered '+name+'! I will remember your face. Add more angles for accuracy.');
  }
  localStorage.setItem('bfaces',JSON.stringify(knownFaces));
  ['fOrigName','fNickname','fCallName','fRelation'].forEach(id=>document.getElementById(id).value='');
  renderKnownFaces();
  // Rebuild Face-API descriptors immediately
  if(faceApiReady) buildFaceDescriptors().then(()=>setSub('Face model updated for '+name));
}
function renderKnownFaces(){
  knownFaces=JSON.parse(localStorage.getItem('bfaces')||'[]');
  const el=document.getElementById('knownFaceList');if(!el)return;
  if(!knownFaces.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No faces registered yet</div>';return;}
  el.innerHTML='';
  knownFaces.forEach((f,i)=>{
    const d=document.createElement('div');d.className='face-card';
    d.innerHTML=`<img class="face-img" src="${f.img}"><div class="face-info"><div class="face-name">${esc(f.name)}</div><div class="face-sub">Nick: ${esc(f.nickname)||'‚Äî'} ¬∑ Call: ${esc(f.callName)||'‚Äî'}</div><div class="face-sub">Relation: ${esc(f.relation)||'‚Äî'} ¬∑ Added: ${f.time}</div></div><button class="face-del" onclick="deleteFace(${i})">‚úï</button>`;
    el.appendChild(d);
  });
}
function deleteFace(i){knownFaces.splice(i,1);localStorage.setItem('bfaces',JSON.stringify(knownFaces));renderKnownFaces();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNKNOWN FACES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUnknownFaces(){
  unknownFaces=JSON.parse(localStorage.getItem('bunknown')||'[]');
  const el=document.getElementById('unknownFaceList');if(!el)return;
  if(!unknownFaces.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No unknowns detected yet</div>';return;}
  el.innerHTML='';
  unknownFaces.forEach((f,i)=>{
    const d=document.createElement('div');d.className='unk-card';
    d.innerHTML=`<img class="unk-img" src="${f.img}"><div style="flex:1;"><div style="font-size:12px;color:var(--o);">${f.time}</div></div><button onclick="registerUnknown(${i})" style="background:var(--c);border:none;border-radius:6px;color:#000;padding:4px 8px;font-size:11px;cursor:pointer;margin-right:6px;">REGISTER</button><button onclick="deleteUnknown(${i})" style="background:none;border:none;color:var(--r);font-size:15px;cursor:pointer;">‚úï</button>`;
    el.appendChild(d);
  });
}
function deleteUnknown(i){unknownFaces.splice(i,1);localStorage.setItem('bunknown',JSON.stringify(unknownFaces));renderUnknownFaces();}
function registerUnknown(i){
  const f=unknownFaces[i];
  const name=prompt('Enter name for this person:');if(!name)return;
  knownFaces.push({id:Date.now(),name,nickname:'',callName:'Hello '+name+'!',relation:'Unknown',img:f.img,time:new Date().toLocaleString()});
  localStorage.setItem('bfaces',JSON.stringify(knownFaces));
  unknownFaces.splice(i,1);localStorage.setItem('bunknown',JSON.stringify(unknownFaces));
  renderKnownFaces();renderUnknownFaces();speak('Face registered for '+name+'!');
}
function clearUnknowns(){unknownFaces=[];localStorage.removeItem('bunknown');renderUnknownFaces();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OBJECT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderObjectLog(){
  objectLog=JSON.parse(localStorage.getItem('bobjlog')||'[]');
  const el=document.getElementById('objectLogDiv');if(!el)return;
  if(!objectLog.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:12px;">No objects logged yet</div>';return;}
  // Group by class and count
  const counts={};objectLog.forEach(o=>{counts[o.name]=(counts[o.name]||0)+1;});
  el.innerHTML=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([name,cnt])=>`<div class="det-item object"><b style="color:var(--o);">${name}</b> ‚Äî seen ${cnt} time${cnt>1?'s':''}</div>`).join('');
}
function clearObjectLog(){objectLog=[];localStorage.removeItem('bobjlog');renderObjectLog();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMINDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addReminder(){
  const t=document.getElementById('remTime').value,tx=document.getElementById('remTxt').value.trim();
  if(!t||!tx){alert('Enter time and text!');return;}
  reminders.push({id:Date.now(),time:t,text:tx});
  localStorage.setItem('brem',JSON.stringify(reminders));
  document.getElementById('remTxt').value='';renderReminders();
}
function renderReminders(){
  reminders=JSON.parse(localStorage.getItem('brem')||'[]');
  const el=document.getElementById('reminderList');if(!el)return;
  if(!reminders.length){el.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:10px;">No reminders set</div>';return;}
  el.innerHTML='';
  reminders.forEach((r,i)=>{
    const d=document.createElement('div');d.className='rem-item';
    d.innerHTML=`<div class="rem-time">${r.time}</div><div style="flex:1;font-size:14px;">${esc(r.text)}</div><button class="rem-del" onclick="delReminder(${i})">‚úï</button>`;
    el.appendChild(d);
  });
}
function delReminder(i){reminders.splice(i,1);localStorage.setItem('brem',JSON.stringify(reminders));renderReminders();}
function checkReminders(){
  const now=new Date();
  const cur=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  reminders.forEach(r=>{if(r.time===cur&&Date.now()-(r.lastFired||0)>60000){r.lastFired=Date.now();speak('Reminder: '+r.text);setSub('‚è∞ '+r.text);}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUN & GAMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tellJoke(){
  document.getElementById('funResult').textContent='Loading joke...';
  callAI('Tell me a funny short joke.',(r)=>{document.getElementById('funResult').textContent=r;speak(r);},'You are a comedian. Tell one funny clean joke in 2 sentences. No emojis.');
}
function tellStory(){
  document.getElementById('funResult').textContent='Creating story...';
  callAI('Tell me a short 3-sentence exciting story.',(r)=>{document.getElementById('funResult').textContent=r;speak(r);},'You are a storyteller. Tell a short exciting story in exactly 3 sentences. No emojis.');
}
function robotDance(){
  if(!rOK){document.getElementById('funResult').textContent='Connect robot first to dance!';return;}
  document.getElementById('funResult').textContent='Dancing! Watch me move!';speak('Let me dance!');
  const moves=[{action:'left'},{action:'right'},{action:'left'},{action:'right'},{action:'forward'},{action:'backward'},{action:'stop'}];
  let i=0;const d=setInterval(()=>{if(i>=moves.length){clearInterval(d);return;}espCmd({...moves[i++],speed:60});},600);
}
function startTrivia(){
  triviaIdx=0;triviaScore=0;
  document.getElementById('tScore').textContent=0;document.getElementById('tNum').textContent=1;
  document.getElementById('triviaArea').style.display='block';
  document.getElementById('funResult').textContent='Trivia started! Answer the questions below.';
  showTrivia();
}
function showTrivia(){
  if(triviaIdx>=TRIVIA.length){document.getElementById('tQuestion').textContent='Game over! Score: '+triviaScore+'/'+TRIVIA.length;document.getElementById('tOptions').innerHTML='';speak('Game over! Score: '+triviaScore+' out of '+TRIVIA.length);return;}
  const q=TRIVIA[triviaIdx];document.getElementById('tQuestion').textContent=q.q;
  const opts=document.getElementById('tOptions');opts.innerHTML='';
  q.opts.forEach((o,i)=>{const b=document.createElement('button');b.className='t-opt';b.textContent=o;b.onclick=()=>ansTrivia(i,q.a,opts);opts.appendChild(b);});
}
function ansTrivia(ch,cor,opts){
  opts.querySelectorAll('.t-opt').forEach((b,i)=>{b.onclick=null;if(i===cor)b.classList.add('correct');else if(i===ch)b.classList.add('wrong');});
  if(ch===cor){triviaScore++;document.getElementById('tScore').textContent=triviaScore;speak('Correct!');}
  else speak('Wrong! Answer: '+TRIVIA[triviaIdx].opts[cor]);
}
function nextTrivia(){triviaIdx++;document.getElementById('tNum').textContent=triviaIdx+1;showTrivia();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS & LOGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addMovLog(msg){movLog.unshift(new Date().toLocaleTimeString()+' ‚Äî '+msg);if(movLog.length>50)movLog.splice(50);}
function addDetLog(msg){detLog.unshift(new Date().toLocaleTimeString()+' ‚Äî '+msg);if(detLog.length>50)detLog.splice(50);}
function renderStats(){
  const el=document.getElementById('statsBlock');if(!el)return;
  const min=Math.round((Date.now()-stats.sessionStart)/60000);
  el.innerHTML=[
    ['Session Time',min+' min'],['Obstacles Hit',stats.obstacles],
    ['Objects Detected',stats.detections],['People Seen',stats.people],
    ['Motion Alerts',stats.motionAlerts],['AI Commands',stats.cmds],
  ].map(([k,v])=>`<div class="rep-row"><span class="rep-k">${k}</span><span class="rep-v">${v}</span></div>`).join('');
  const ml=document.getElementById('movLogDiv');if(ml)ml.innerHTML=movLog.map(l=>`<div class="log-entry">${l}</div>`).join('')||'<div style="color:#333;font-size:12px;text-align:center;padding:8px;">No movement logged</div>';
  const dl=document.getElementById('detLogDiv');if(dl)dl.innerHTML=detLog.map(l=>`<div class="log-entry">${l}</div>`).join('')||'<div style="color:#333;font-size:12px;text-align:center;padding:8px;">No detections logged</div>';
}
async function generateReport(){
  const el=document.getElementById('aiReportDiv');el.style.display='block';el.textContent='Generating report...';
  const min=Math.round((Date.now()-stats.sessionStart)/60000);
  const p=userProfile;
  const profileSummary=`User: ${p.name||'unknown'}, Job: ${p.job||'unknown'}, Interests: ${p.interests.slice(-4).join(',')||'none learned yet'}, Mood patterns: ${JSON.stringify(p.mood_patterns)}, Environment: ${p.environment.type||'unknown'}`;
  const learnedSummary=`Learned ${selfLearned.length} facts, ${mems.length} explicit memories, ${p.corrections.length} corrections applied`;
  const activityData=`Session: ${min}min, Obstacles: ${stats.obstacles}, Detections: ${stats.detections}, People: ${stats.people}, Motion alerts: ${stats.motionAlerts}, Commands: ${stats.cmds}`;
  const prompt=`Generate a comprehensive Bro AI report covering:
1. User profile insight (what has been learned about the user)
2. Session activity (robot movement, detections)
3. Self-learning progress (facts learned, patterns discovered)
4. Recommendations (what robot should do better)

Data:
${activityData}
Profile: ${profileSummary}
Learning: ${learnedSummary}
Top facts: ${selfLearned.slice(0,5).map(l=>l.fact).join(' | ')}

Write 4 short paragraphs, one per topic. Professional tone, no emojis.`;
  callAI(prompt,(r)=>{el.textContent=r;speak(r.substring(0,180));},
    'You are a robot AI analyst. Generate a concise, insightful report. No emojis. Plain text only.');
}
function clearAllLogs(){movLog=[];detLog=[];renderStats();}

// ‚ïê‚ïê‚ïê MEMORY MANAGEMENT ‚ïê‚ïê‚ïê
function addManualMem(){
  const inp=document.getElementById('newMemInput');
  if(!inp||!inp.value.trim()) return;
  saveMem(inp.value.trim());
  inp.value='';
  renderMemory();
  speak('Memory saved!');
}

function deleteMem(id){
  mems=mems.filter(m=>m.id!==id);
  localStorage.setItem('bm',JSON.stringify(mems));
  renderMemory();
}

function deleteLearned(id){
  selfLearned=selfLearned.filter(l=>l.id!==id);
  localStorage.setItem('bsl',JSON.stringify(selfLearned));
  renderMemory();
}

function clearAllMems(){
  if(!confirm('Clear all explicit memories?')) return;
  mems=[];localStorage.removeItem('bm');renderMemory();speak('All memories cleared.');
}

function clearLearned(){
  if(!confirm('Clear all self-learned facts?')) return;
  selfLearned=[];localStorage.removeItem('bsl');renderMemory();speak('Learned facts cleared.');
}
function clearProfile(){
  if(!confirm('Clear the auto-built user profile? This removes name, job, interests, habits etc.')) return;
  userProfile={name:null,age:null,location:null,job:null,interests:[],dislikes:[],relationships:{},personality_notes:[],corrections:[],environment:{},routines:{},mood_patterns:{}};
  localStorage.removeItem('bup');renderMemory();speak('User profile cleared.');
}

function renderMemory(){
  mems=JSON.parse(localStorage.getItem('bm')||'[]');
  selfLearned=JSON.parse(localStorage.getItem('bsl')||'[]');
  try{ userProfile=JSON.parse(localStorage.getItem('bup')||'null')||userProfile; }catch(e){}

  // Show user profile card if we have data
  const profileEl=document.getElementById('profileCard');
  if(profileEl){
    const p=userProfile;
    const hasData=p.name||p.job||p.interests.length||p.location;
    if(hasData){
      profileEl.style.display='block';
      profileEl.innerHTML=`
        <div style="font-size:12px;color:var(--pur);font-weight:700;margin-bottom:8px;">üß† Learned User Profile</div>
        ${p.name?'<div style="font-size:12px;color:#ddd;">Name: <b style="color:var(--c);">'+esc(p.name)+'</b></div>':''}
        ${p.job?'<div style="font-size:12px;color:#ddd;">Job: <b style="color:var(--c);">'+esc(p.job)+'</b></div>':''}
        ${p.location?'<div style="font-size:12px;color:#ddd;">Location: <b style="color:var(--c);">'+esc(p.location)+'</b></div>':''}
        ${p.age?'<div style="font-size:12px;color:#ddd;">Age: <b style="color:var(--c);">'+esc(p.age)+'</b></div>':''}
        ${p.interests.length?'<div style="font-size:12px;color:#ddd;margin-top:4px;">Interests: <span style="color:var(--gr);">'+p.interests.slice(-6).map(esc).join(', ')+'</span></div>':''}
        ${p.dislikes.length?'<div style="font-size:12px;color:#ddd;">Dislikes: <span style="color:var(--r);">'+p.dislikes.slice(-4).map(esc).join(', ')+'</span></div>':''}
        ${Object.keys(p.mood_patterns).length?'<div style="font-size:12px;color:#ddd;">Mood patterns: <span style="color:var(--gold);">'+Object.entries(p.mood_patterns).map(([k,v])=>k+':'+v).join(', ')+'</span></div>':''}
        ${p.corrections.length?'<div style="font-size:11px;color:var(--g);margin-top:4px;">'+p.corrections.length+' corrections applied</div>':''}
      `;
    } else {
      profileEl.style.display='none';
    }
  }

  // Render explicit memories
  const ml=document.getElementById('memList');
  if(ml){
    if(!mems.length){ml.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:10px;">No memories saved yet. Say "remember this" in chat!</div>';
    }else{
      ml.innerHTML=mems.map(m=>`
        <div style="display:flex;align-items:flex-start;gap:8px;background:rgba(0,255,255,0.04);border:1px solid rgba(0,255,255,0.1);border-radius:8px;padding:9px;margin-bottom:4px;">
          <div style="flex:1;">
            <div style="font-size:13px;color:#ddd;line-height:1.5;">${esc(m.text)}</div>
            <div style="font-size:10px;color:var(--g);margin-top:3px;">${m.time||''} ¬∑ ${m.source==='user'?'User saved':'Auto'}</div>
          </div>
          <button onclick="deleteMem(${m.id})" style="background:none;border:none;color:var(--r);font-size:16px;cursor:pointer;flex-shrink:0;">‚úï</button>
        </div>`).join('');
    }
  }

  // Render self-learned
  const ll=document.getElementById('learnedList');
  if(ll){
    if(!selfLearned.length){ll.innerHTML='<div style="font-size:12px;color:#333;text-align:center;padding:10px;">Nothing learned yet. Keep chatting!</div>';
    }else{
      ll.innerHTML=selfLearned.map(l=>`
        <div style="display:flex;align-items:flex-start;gap:8px;background:rgba(136,0,255,0.04);border:1px solid rgba(136,0,255,0.1);border-radius:8px;padding:9px;margin-bottom:4px;">
          <div style="flex:1;">
            <div style="font-size:13px;color:#ddd;line-height:1.5;">${esc(l.fact)}</div>
            <div style="font-size:10px;color:var(--g);margin-top:3px;">${l.time||''} ¬∑ Auto-learned</div>
          </div>
          <button onclick="deleteLearned(${l.id})" style="background:none;border:none;color:var(--r);font-size:16px;cursor:pointer;flex-shrink:0;">‚úï</button>
        </div>`).join('');
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMORY & UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveMem(text){
  if(!text||text.length<3) return;
  const entry={id:Date.now(),text:text.trim(),time:new Date().toLocaleString(),source:'user'};
  mems.unshift(entry);
  if(mems.length>500) mems=mems.slice(0,500);
  localStorage.setItem('bm',JSON.stringify(mems));
  if(sett.puterKV&&puterReady) puterKVSet('mems',mems);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FULL AI SELF-LEARNING ENGINE
// Learns from: Chat, Vision, Corrections, Patterns
// Builds: User profile, beliefs, habits, environment map
// Acts: Adapts personality, proactively recalls, changes behavior
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// userProfile declared in state vars

// ‚îÄ‚îÄ Learning queue ‚Äî pending AI extractions ‚îÄ‚îÄ
let learnQueue = [];
let visionLearnCooldown = 0;
let learnProcessing = false;
let lastLearnTime = 0;

// ‚îÄ‚îÄ Main entry point ‚Äî called after every chat exchange ‚îÄ‚îÄ
async function autoLearn(userMsg, aiReply) {
  if (!userMsg || userMsg.length < 2) return;
  // Queue for processing (batch to avoid too many API calls)
  learnQueue.push({ userMsg, aiReply, time: Date.now() });
  if (!learnProcessing) processLearnQueue();
}

async function processLearnQueue() {
  if (learnProcessing || learnQueue.length === 0) return;
  // Throttle: only extract once every 8 seconds
  if (Date.now() - lastLearnTime < 8000) {
    setTimeout(processLearnQueue, 8000);
    return;
  }
  learnProcessing = true;
  lastLearnTime = Date.now();
  const batch = learnQueue.splice(0, 3); // process up to 3 at once
  for (const item of batch) {
    await extractAndLearn(item.userMsg, item.aiReply);
  }
  learnProcessing = false;
  if (learnQueue.length > 0) setTimeout(processLearnQueue, 8000);
}

async function extractAndLearn(userMsg, aiReply) {
  const prompt = `Analyze this conversation exchange and extract learnable facts.

User said: "${userMsg}"
AI replied: "${aiReply}"

Current known profile: ${JSON.stringify(userProfile).substring(0, 300)}

Extract ONLY genuinely new/useful information. Return JSON only:
{
  "facts": ["short fact strings about the user or world"],
  "profile_updates": {"field": "value"},
  "corrections": ["any correction to previous beliefs"],
  "interests": ["topics user cares about"],
  "dislikes": ["things user dislikes"],
  "mood": "positive/negative/neutral",
  "important": true/false
}
Return {} if nothing meaningful to learn.`;

  try {
    let result = null;

    // Use Puter first (free)
    if (puterReady && typeof puter !== 'undefined') {
      try {
        const res = await puter.ai.chat(prompt, { model: 'gpt-4o-mini' });
        const txt = typeof res === 'string' ? res : (res?.message?.content || '');
        result = parseLearnJSON(txt);
      } catch(e) {}
    }

    // Fallback to Groq (fast)
    if (!result && keys.groq) {
      try {
        const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + keys.groq },
          body: JSON.stringify({ model: 'llama-3.1-8b-instant', messages: [{ role: 'user', content: prompt }], max_tokens: 300, temperature: 0.1 }),
          signal: AbortSignal.timeout(6000)
        });
        if (r.ok) {
          const d = await r.json();
          result = parseLearnJSON(d?.choices?.[0]?.message?.content || '');
        }
      } catch(e) {}
    }

    // Fallback to Gemini
    if (!result && keys.g) {
      try {
        const r = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent?key=' + keys.g, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
          signal: AbortSignal.timeout(8000)
        });
        if (r.ok) {
          const d = await r.json();
          result = parseLearnJSON(d?.candidates?.[0]?.content?.parts?.[0]?.text || '');
        }
      } catch(e) {}
    }

    if (result) applyLearning(result, 'chat');

  } catch(e) {
    console.log('[Learn]', e.message);
  }
}

function parseLearnJSON(txt) {
  if (!txt || txt.trim() === '{}') return null;
  try {
    const clean = txt.replace(/```json|```/g, '').trim();
    const start = clean.indexOf('{');
    const end = clean.lastIndexOf('}');
    if (start < 0 || end < 0) return null;
    const parsed = JSON.parse(clean.substring(start, end + 1));
    if (Object.keys(parsed).length === 0) return null;
    return parsed;
  } catch(e) { return null; }
}

function applyLearning(data, source) {
  let changed = false;

  // Apply facts
  if (data.facts?.length) {
    data.facts.forEach(fact => {
      if (typeof fact === 'string' && fact.length > 3) {
        // Check for contradictions ‚Äî remove old conflicting facts
        const keywords = fact.toLowerCase().split(' ').slice(0, 3).join(' ');
        selfLearned = selfLearned.filter(l => {
          const overlap = l.fact.toLowerCase().includes(keywords.split(' ')[0]);
          return !overlap || l.source === 'user'; // keep user-saved, remove conflicting auto-learned
        });
        if (!selfLearned.find(l => l.fact.toLowerCase() === fact.toLowerCase())) {
          selfLearned.unshift({ id: Date.now() + Math.random(), fact, time: new Date().toLocaleString(), source, confidence: 0.8 });
          changed = true;
        }
      }
    });
  }

  // Apply corrections ‚Äî update beliefs
  if (data.corrections?.length) {
    data.corrections.forEach(correction => {
      if (typeof correction === 'string' && correction.length > 3) {
        selfLearned.unshift({ id: Date.now() + Math.random(), fact: '[UPDATED] ' + correction, time: new Date().toLocaleString(), source: 'correction', confidence: 1.0 });
        userProfile.corrections.push({ correction, time: new Date().toLocaleString() });
        changed = true;
      }
    });
  }

  // Apply interests
  if (data.interests?.length) {
    data.interests.forEach(interest => {
      if (typeof interest === 'string' && !userProfile.interests.includes(interest)) {
        userProfile.interests.push(interest);
        userProfile.interests = userProfile.interests.slice(-30);
        changed = true;
      }
    });
  }

  // Apply dislikes
  if (data.dislikes?.length) {
    data.dislikes.forEach(dislike => {
      if (typeof dislike === 'string' && !userProfile.dislikes.includes(dislike)) {
        userProfile.dislikes.push(dislike);
        changed = true;
      }
    });
  }

  // Apply profile updates
  if (data.profile_updates) {
    Object.entries(data.profile_updates).forEach(([k, v]) => {
      if (v && userProfile.hasOwnProperty(k)) {
        userProfile[k] = v;
        changed = true;
      }
    });
  }

  // Track mood patterns
  if (data.mood) {
    const hour = new Date().getHours();
    const period = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
    userProfile.mood_patterns[period] = data.mood;
    changed = true;
  }

  // Handle vision-specific fields
  if (data.environment_type) {
    userProfile.environment.type = data.environment_type;
    changed = true;
  }
  if (data.environment_changed && data.change_description) {
    const warn = 'Environment change: ' + data.change_description;
    addDetLog('‚ö† ' + warn);
    selfLearned.unshift({id:Date.now()+Math.random(), fact:warn, time:new Date().toLocaleString(), source:'vision_change', confidence:0.9});
    // Proactively warn user
    if(botVoiceOn) setSub('Notice: ' + data.change_description.substring(0,80));
    changed = true;
  }
  if (data.people_emotions?.length) {
    const emotions = data.people_emotions.join(', ');
    userProfile.mood_patterns['last_seen'] = emotions;
    changed = true;
  }
  if (data.safety_concerns && data.safety_concerns !== 'none' && data.safety_concerns.length > 5) {
    addDetLog('‚ö† Safety: ' + data.safety_concerns.substring(0,80));
    if(botVoiceOn) speak('Warning: ' + data.safety_concerns.substring(0,60));
  }
  if (data.text_seen && data.text_seen.length > 2 && data.text_seen !== 'none') {
    selfLearned.unshift({id:Date.now()+Math.random(), fact:'Saw text: "'+data.text_seen.substring(0,100)+'"', time:new Date().toLocaleString(), source:'vision_ocr', confidence:0.85});
    addDetLog('Vision OCR: ' + data.text_seen.substring(0,60));
    changed = true;
  }

  if (changed) {
    selfLearned = selfLearned.slice(0, 300);
    localStorage.setItem('bsl', JSON.stringify(selfLearned));
    localStorage.setItem('bup', JSON.stringify(userProfile));
    if (document.getElementById('memList')?.offsetParent !== null) renderMemory();
    adaptPersonality();
  }
}

// ‚îÄ‚îÄ Vision Learning ‚îÄ‚îÄ learns from camera observations
async function learnFromVision(imageBase64, detectionContext) {
  if (Date.now() - visionLearnCooldown < 30000) return; // max every 30s
  if (!imageBase64) return;
  visionLearnCooldown = Date.now();

  const knownEnvStr = JSON.stringify(userProfile.environment).substring(0,200);
  const prompt = `You are a robot observing through its camera. Extract ALL learnable information from this image.
Context: ${detectionContext || 'routine observation'}
Previously known environment: ${knownEnvStr}

Analyze and return ONLY valid JSON (no markdown):
{
  "objects_seen": ["every object you can identify"],
  "environment_type": "bedroom/kitchen/office/living room/outdoor/etc",
  "environment_changed": true/false,
  "change_description": "what changed from known environment if anything",
  "people_count": 0,
  "people_emotions": ["happy/sad/angry/neutral/surprised - one per person"],
  "people_activities": ["what each person is doing"],
  "text_seen": "any readable text in image",
  "lighting": "bright/dim/dark/natural/artificial",
  "time_of_day_guess": "morning/afternoon/evening/night",
  "activity": "overall scene description",
  "safety_concerns": "anything that looks dangerous or out of place",
  "facts": ["specific new learnable facts about user or environment"]
}`;

  let result = null;

  // Use Puter vision
  if (puterReady && typeof puter !== 'undefined') {
    try {
      const res = await puter.ai.chat([{
        role: 'user',
        content: [
          { type: 'image_url', image_url: { url: imageBase64 } },
          { type: 'text', text: prompt }
        ]
      }], { model: sett.puterModel || 'gpt-4o-mini' });
      const txt = typeof res === 'string' ? res : (res?.message?.content || '');
      result = parseLearnJSON(txt);
    } catch(e) { console.log('[VisionLearn]', e.message); }
  }

  // Fallback: Gemini Vision
  if (!result && keys.g) {
    try {
      const body = { contents: [{ parts: [
        { inline_data: { mime_type: 'image/jpeg', data: imageBase64.split(',')[1] } },
        { text: prompt }
      ]}]};
      const r = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=' + keys.g, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body), signal: AbortSignal.timeout(10000)
      });
      if (r.ok) {
        const d = await r.json();
        result = parseLearnJSON(d?.candidates?.[0]?.content?.parts?.[0]?.text || '');
      }
    } catch(e) {}
  }

  if (result) {
    // Store environment observations
    if (result.environment_notes) {
      Object.assign(userProfile.environment, result.environment_notes);
      userProfile.environment.last_seen = new Date().toLocaleString();
    }
    if (result.text_seen && result.text_seen.length > 2) {
      addDetLog('Vision read text: ' + result.text_seen.substring(0, 60));
    }
    if (result.objects_seen?.length) {
      result.objects_seen.forEach(obj => {
        if (obj && !objectLog.find(o => o.name === obj)) {
          objectLog.unshift({ name: obj, time: Date.now(), ts: new Date().toLocaleTimeString(), conf: 90 });
        }
      });
      if (objectLog.length > 100) objectLog.splice(100);
      localStorage.setItem('bobjlog', JSON.stringify(objectLog));
    }
    if (result.facts?.length) applyLearning({ facts: result.facts }, 'vision');
    addDetLog('Vision learned: ' + (result.activity || 'observation'));
  }
}

// ‚îÄ‚îÄ Pattern Learning ‚îÄ‚îÄ tracks routines and habits
function learnPattern(action, context) {
  const now = new Date();
  const hour = now.getHours();
  const day = now.toLocaleDateString('en',{weekday:'short'});
  const period = hour < 6 ? 'night' : hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : hour < 21 ? 'evening' : 'night';
  const key = period + '_' + day;

  if (!userProfile.routines[key]) userProfile.routines[key] = [];
  const routine = userProfile.routines[key];

  // Track frequency
  const existing = routine.find(r => r.action === action);
  if (existing) {
    existing.count = (existing.count || 1) + 1;
    existing.last = now.toLocaleString();
  } else {
    routine.push({ action, context, count: 1, first: now.toLocaleString(), last: now.toLocaleString() });
  }

  // Trim
  userProfile.routines[key] = routine.slice(-20);
  localStorage.setItem('bup', JSON.stringify(userProfile));

  // If pattern repeats 3+ times, save as a learned fact
  const rep = routine.find(r => r.action === action && r.count >= 3);
  if (rep && !selfLearned.find(l => l.fact.includes(action + ' on ' + day))) {
    applyLearning({ facts: [`User often does "${action}" on ${day} ${period}`] }, 'pattern');
  }
}

// ‚îÄ‚îÄ Correction Detection ‚îÄ‚îÄ detects when user corrects AI
function detectCorrection(userMsg) {
  const corrections = [
    /(?:no|wrong|incorrect|that'?s? not right|you'?re? wrong|not true|false)[,.]?\s*(?:actually|it'?s?|the truth is|correct is)?\s*(.+)/i,
    /(?:actually|in fact|correction)[,:]?\s*(.+)/i,
    /(?:stop|don'?t|never) (saying|doing|calling|referring) (.+)/i,
    /(?:update|change|fix) (?:your|the) (?:memory|knowledge|belief|record)[: ]+(.+)/i,
    /(?:i told you|i said|i mentioned) (.+) (?:before|already|earlier)/i,
  ];
  for (const re of corrections) {
    const m = userMsg.match(re);
    if (m) {
      const correction = m[1] || m[2] || '';
      if (correction.length > 3) {
        applyLearning({ corrections: [correction.trim()] }, 'correction');
        // Remove conflicting facts
        const keyword = correction.toLowerCase().split(' ')[0];
        selfLearned = selfLearned.filter(l => !l.fact.toLowerCase().includes(keyword) || l.source === 'user');
        localStorage.setItem('bsl', JSON.stringify(selfLearned));
        return true;
      }
    }
  }
  return false;
}

// ‚îÄ‚îÄ Personality Adaptation ‚îÄ‚îÄ changes how AI talks based on learning
function adaptPersonality() {
  if (!userProfile.interests.length && !userProfile.mood_patterns) return;
  // Build adapted system context for next call
  const topInterests = userProfile.interests.slice(-5).join(', ');
  const mood = userProfile.mood_patterns[getCurrentPeriod()] || 'neutral';
  const adaptNote = `User interests: ${topInterests}. Current mood pattern: ${mood}.${mood === 'negative' ? ' Be extra supportive and gentle.' : mood === 'positive' ? ' Match their energy, be enthusiastic.' : ''}`;
  // Store in sett for use in next callAI
  sett._adaptNote = adaptNote;
}

function getCurrentPeriod() {
  const h = new Date().getHours();
  return h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
}

// ‚îÄ‚îÄ Proactive Memory Recall ‚îÄ‚îÄ AI mentions relevant memories unprompted
function getProactiveContext(userMsg) {
  const msgLower = userMsg.toLowerCase();
  const relevant = [];

  // Find memories relevant to current message
  [...mems, ...selfLearned].forEach(item => {
    const text = (item.text || item.fact || '').toLowerCase();
    const words = msgLower.split(' ').filter(w => w.length > 3);
    if (words.some(w => text.includes(w))) {
      relevant.push(item.text || item.fact);
    }
  });

  // Check if user profile has relevant data
  if (msgLower.includes('weather') && userProfile.location) relevant.push('User is in ' + userProfile.location);
  if (msgLower.includes('work') && userProfile.job) relevant.push('User works as: ' + userProfile.job);
  if (msgLower.includes('like') || msgLower.includes('prefer')) {
    if (userProfile.interests.length) relevant.push('User interests: ' + userProfile.interests.slice(-3).join(', '));
  }

  return relevant.slice(0, 3).join('; ');
}

// ‚îÄ‚îÄ Build full system context for AI calls ‚îÄ‚îÄ
function buildSystemContext(pers, sys) {
  if (sys) return sys;

  const memCtx = mems.slice(0, 6).map(m => m.text).join(' | ');
  const learnCtx = selfLearned.slice(0, 8).map(l => l.fact).join(' | ');
  const profileCtx = [
    userProfile.name ? 'Name: ' + userProfile.name : '',
    userProfile.job ? 'Job: ' + userProfile.job : '',
    userProfile.interests.length ? 'Likes: ' + userProfile.interests.slice(-4).join(', ') : '',
    userProfile.dislikes.length ? 'Dislikes: ' + userProfile.dislikes.slice(-3).join(', ') : '',
    Object.keys(userProfile.environment).length ? 'Environment: ' + JSON.stringify(userProfile.environment).substring(0, 100) : '',
  ].filter(Boolean).join('. ');

  const correction_ctx = userProfile.corrections.slice(-3).map(c => c.correction).join('; ');
  const adaptCtx = sett._adaptNote || '';
  const period = getCurrentPeriod();
  const routineKey = period + '_' + new Date().toLocaleDateString('en',{weekday:'short'});
  const routineCtx = userProfile.routines[routineKey]?.slice(-3).map(r => r.action).join(', ') || '';

  // Last 8 messages for conversational context
  const recentMsgs=(()=>{
    const ch=chats.find(ch=>ch.id===curChatId);
    if(!ch||!ch.msgs||!ch.msgs.length) return '';
    return ch.msgs.slice(-8).map(m=>(m.role==='user'?'User':'Bro')+': '+m.text.substring(0,100)).join('\n');
  })();

  return `You are Bro AI, a ${pers} AI robot. You have a deep memory and learn from every interaction. Be concise. No emojis in spoken text.

RECENT CONVERSATION:
${recentMsgs||'(start of conversation)'}


WHAT YOU KNOW ABOUT THE USER:
${profileCtx || 'Still learning about user.'}

EXPLICIT MEMORIES (user told you to remember):
${memCtx || 'None yet.'}

SELF-LEARNED FACTS (from conversations & vision):
${learnCtx || 'None yet.'}

CORRECTIONS (user corrected you on these):
${correction_ctx || 'None.'}

CURRENT CONTEXT: ${period} routine today includes: ${routineCtx || 'nothing noted yet'}.
${adaptCtx}

BEHAVIOR RULES:
- Reference memories naturally when relevant (e.g. "As you mentioned before, you like X...")
- If user seems unhappy (based on mood patterns), be gentler
- If you learn something new, briefly confirm it ("Got it, I'll remember that!")
- Never contradict user's corrections
- Adapt your tone to match user's preferences

ROBOT COMMANDS (add when user wants movement): [MOVE_FORWARD][MOVE_BACKWARD][TURN_LEFT][TURN_RIGHT][STOP][HEAD_LEFT][HEAD_RIGHT][HEAD_CENTER][TILT_UP][TILT_DOWN][TURN_90L][TURN_90R][TURN_180]`;
}
function esc(s){return(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function checkVoice(){const el=document.getElementById('voiceBox');el.style.display='block';const v=window.speechSynthesis.getVoices();const s=getBritishVoice();el.innerHTML='<b style="color:var(--c)">Selected:</b> '+(s?s.name+' ('+s.lang+')':'None')+'<br><b style="color:var(--c)">All English:</b><br>'+v.filter(x=>x.lang.startsWith('en')).map((x,i)=>`${i+1}. ${x.name}`).join('<br>');speak('Hello! I am Bro AI, your robot companion.');}


// ‚îÄ‚îÄ Spaced Repetition ‚Äî re-verify old facts ‚îÄ‚îÄ
function runSpacedRepetition(){
  if(!selfLearned.length) return;
  const now = Date.now();
  // Find facts older than 3 days with low confidence
  const old = selfLearned.filter(l => {
    if(!l.confidence||l.confidence>0.9) return false;
    const age = now - new Date(l.time).getTime();
    return age > 3*24*3600*1000; // 3 days old
  });
  if(!old.length) return;
  const fact = old[Math.floor(Math.random()*old.length)];
  // Re-ask AI if this fact is still accurate
  callAI('Is this still accurate? "'+fact.fact+'". Reply YES or NO and why briefly.',
    r=>{
      if(/^no/i.test(r.trim())){
        selfLearned = selfLearned.filter(l=>l.id!==fact.id);
        localStorage.setItem('bsl',JSON.stringify(selfLearned));
        console.log('[SpacedRep] Removed outdated fact:', fact.fact);
      } else {
        fact.confidence = Math.min(1.0,(fact.confidence||0.7)+0.1);
        fact.verified = new Date().toLocaleString();
        localStorage.setItem('bsl',JSON.stringify(selfLearned));
      }
    }, 'Reply YES or NO briefly. Do not elaborate.');
}
// Run spaced repetition every 6 hours
setInterval(runSpacedRepetition, 6*3600*1000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
keys     = JSON.parse(localStorage.getItem('bk')||'{}');
sett     = JSON.parse(localStorage.getItem('bs')||'{"obstacle":true,"autoNav":true,"batAlert":true,"followPerson":false,"detection":true,"faceRec":true,"ocrMode":false,"gestureCtrl":false,"lookSpeak":true,"personality":"friendly","voiceSpeed":0.9,"lang":"en-US"}');
mems     = JSON.parse(localStorage.getItem('bm')||'[]');
skip     = JSON.parse(localStorage.getItem('bsk')||'{}');
chats    = JSON.parse(localStorage.getItem('bchats')||'[]');
habits   = JSON.parse(localStorage.getItem('bhab')||'{}');
knownFaces   = JSON.parse(localStorage.getItem('bfaces')||'[]');
unknownFaces = JSON.parse(localStorage.getItem('bunknown')||'[]');
objectLog    = JSON.parse(localStorage.getItem('bobjlog')||'[]');
reminders    = JSON.parse(localStorage.getItem('brem')||'[]');
if(eIP) document.getElementById('espIP').value=eIP;
if(window.speechSynthesis) window.speechSynthesis.getVoices();

// Load ML in background (non-blocking)
loadML();
// Load Face-API (deferred slightly so page renders first)
setTimeout(()=>{ if(typeof faceapi!=='undefined') loadFaceApi(); }, 3000);

// Init Puter.js
setTimeout(initPuter, 1500);

// Emergency listener starts only when voice is turned ON
// (see startVoice function)

// Reminder checker every minute
setInterval(checkReminders, 60000);
</script>
</body>
</html>
